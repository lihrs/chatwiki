import{M as t,N as o,W as e,a6 as K,a7 as y,F as q,$ as O,Z as g,b as X,e as x,ai as me,k as l,S as m,u as w,Q as J,Y as L,G as Z,H as Ie,z as le,aa as ne,a1 as ee,a2 as te,w as ge,B as Me,a4 as Le,a5 as ue,a9 as Ee,x as Oe,D as Re,a8 as Ae}from"./vue-chunks-BjMuQ6KD.js";import{u as Be}from"./useEventBus-DCQvkgIt.js";import{u as ve}from"./chat-DyZefrwF.js";import{b as N,V as de,am as De,d as ae,bu as he,M as Pe,f as Fe,bA as He,k as Ne,B as Ue}from"../../index-CfxQ5aRu.js";import{_ as pe}from"./useIM-CliBsTXv.js";import{S as fe}from"./index-BLP-Fxny.js";import{_ as ye}from"./index-D1MiuDW_.js";import{_ as be}from"./cu-scroll-ClwfOnpN.js";import{_ as Qe}from"./TextArea-CN_AI7y7.js";import{Q as H}from"./QuestionCircleOutlined-Deh272L3.js";import{_ as ke}from"./index-Ch1-3QsQ.js";import{a as je}from"./index-D7LnsHib.js";import{V as Ve}from"./vue-pdf-embed-TbWIKlKu.js";import{q as ze}from"./index-W8wCYhw3.js";import{u as Je}from"./robot-Buya70Kq.js";import{B as Ke,_ as Ge}from"./index-Q8_wcZdl.js";import{P as Ye}from"./PlusOutlined-xiVHYVI8.js";import"./axios-Cm0UX6qg.js";import"./qs-DjdPq-RR.js";import"./crypto-js-BemCeW_6.js";import"./dayjs-DK4rpucX.js";import"./index-BLNMWHkL.js";import"./Trigger-Dy6Dc2CN.js";import"./ResizeObserver.es-B1PUzC5B.js";import"./colors-C9XVGyX_.js";import"./pull-up.esm-JZ91zQ8P.js";import"./observe-dom.esm-DPKTicVt.js";import"./FormItemContext-DQ1b1ToO.js";import"./index-D6-G2N0k.js";import"./index-CXSrVsd0.js";import"./inputProps-D7qr__m5.js";import"./dropdown-DsYo-imx.js";import"./RightOutlined-BHf0iqSq.js";import"./move-BjmscfYf.js";import"./slide-BYYxYcj9.js";import"./index-Bx_z5H0C.js";import"./shallowequal-B6gQS78g.js";import"./collapseMotion-BH6Vz7El.js";import"./DownOutlined-Gk0UBxct.js";const We={class:"guess-you-want"},Ze={class:"message-tabs"},Xe={key:1,class:"v-line"},et={key:0,class:"message-menus"},tt=["onClick"],ot={key:1,class:"message-menus"},st=["onClick"],nt={__name:"guess-you-want",props:{item:{type:Object,default:()=>{}},common_question_list:{type:Object,default:()=>[]},enable_common_question:{type:Boolean,default:!1}},emits:["clickMeun"],setup(p,{emit:E}){const b=E,s=p,f=(k,c)=>{k.question_tabkey=c},S=k=>{b("clickMeun",k)};return(k,c)=>(t(),o("div",We,[e("div",Ze,[s.item.guess_you_want?(t(),o("div",{key:0,onClick:c[0]||(c[0]=_=>f(s.item,1)),class:K(["tab-item",{active:s.item.question_tabkey==1}])}," 猜你想问 ",2)):y("",!0),s.item.guess_you_want&&s.common_question_list&&s.enable_common_question?(t(),o("div",Xe)):y("",!0),s.common_question_list&&s.enable_common_question?(t(),o("div",{key:2,onClick:c[1]||(c[1]=_=>f(s.item,2)),class:K(["tab-item",{active:s.item.question_tabkey==2}])}," 常见问题 ",2)):y("",!0)]),s.item.question_tabkey==1?(t(),o("div",et,[(t(!0),o(q,null,O(s.item.guess_you_want,(_,u)=>(t(),o("div",{onClick:r=>S(_),class:"menu-item",key:u},g(_),9,tt))),128))])):(t(),o("div",ot,[(t(!0),o(q,null,O(p.common_question_list,(_,u)=>(t(),o("div",{onClick:r=>S(_),class:"menu-item",key:u},g(_),9,st))),128))]))]))}},lt=N(nt,[["__scopeId","data-v-9c22a890"]]),at=p=>(ee("data-v-a04d3aa0"),p=p(),te(),p),it={class:"message-list-wrapper"},ct={class:"message-list"},rt=["id"],_t={class:"itme-left"},ut=["src"],dt={class:"itme-right"},pt={class:"item-body"},mt={class:"message-content"},gt=["id"],vt={class:"itme-left"},ht=["src"],ft={class:"itme-right"},yt={class:"label-flex-block"},bt=["onClick"],kt=at(()=>e("span",{class:"label-text"},"正在检索知识库...",-1)),$t={class:"label-text"},wt=["onClick"],qt={class:"label-text"},St={class:"item-body"},Ct={key:0,class:"file-items"},xt=["onClick"],Tt={class:"file-name"},It={key:0},Mt={key:1},Lt={key:1,class:"thinking-content"},Et={class:"message-content"},Ot={class:"message-menus"},Rt=["onClick"],At=["innerHTML"],Bt={class:"message-menus"},Dt=["onClick"],Pt={key:4,class:"message-content"},Ft=["src"],Ht={key:5,class:"message-action-wrap"},Nt={key:0,class:"message-action"},Ut={class:"action-btn"},Qt=["onClick"],jt={__name:"message-list",props:{messages:{type:Array,default:()=>[]},robotInfo:{type:Object,default:()=>{}}},emits:["clickMsgMeun","scroll","scrollStart","scrollEnd","openPromptLog","openLibrary"],setup(p,{expose:E,emit:b}){const s=b,f=p,S=d=>{d.show_reasoning=!d.show_reasoning},k=d=>{d.show_quote_file=!d.show_quote_file},c=X(()=>f.robotInfo.common_question_list.length?JSON.parse(f.robotInfo.common_question_list):[]),_=X(()=>f.robotInfo.chat_type==1||f.robotInfo.chat_type==3),u=d=>{s("clickMsgMeun",d)},r=x(null),a={scrollTop:0,scrollHeight:0,clientHeight:0,scrollStartDiff:60,scrollEndDiff:60,scrollDirection:""};let I=null,B=!1;function Q(d){B||(I&&(clearTimeout(I),I=null),I=setTimeout(()=>{a.scrollTop-d.target.scrollTop>0&&(a.scrollDirection="up"),a.scrollTop-d.target.scrollTop<0&&(a.scrollDirection="down"),a.scrollTop=d.target.scrollTop,a.scrollHeight=d.target.scrollHeight,a.clientHeight=d.target.clientHeight,s("scroll",{...a}),Math.abs(a.scrollTop)<=a.scrollStartDiff&&a.scrollDirection==="up"&&j(),Math.abs(a.scrollHeight-a.scrollTop-a.clientHeight)<=a.scrollEndDiff&&a.scrollDirection==="down"&&P()},50))}function j(){f.messages.length!=0&&s("scrollStart",{msg:f.messages[0]})}function P(){f.messages.length!=0&&s("scrollEnd",{msg:f.messages[f.messages.length-1]})}const W=()=>{r.value&&le(()=>{B=!0,r.value.scrollTop=r.value.scrollHeight+1,setTimeout(()=>{a.scrollTop=r.value.scrollTop,B=!1},50)})};function G(d,T){le(()=>{B=!0,T||(T="top");let M=r.value,i=document.querySelector("#msg-"+d);T=="top"?M.scrollTop=i.offsetTop:M.scrollTop=i.offsetTop-M.clientHeight+i.clientHeight,setTimeout(()=>{a.scrollTop=r.value.scrollTop,B=!1},50)})}function v(){a.scrollTop=0,a.scrollDirection=""}function $(d){return!!(d.quote_file&&d.quote_file.length>0||d.debug&&d.debug.length>0)}function D(d){s("openPromptLog",ne(d))}function R(d,T,M){let i=ne(d);T.message_id=T.message_id||M,i.forEach(A=>{A.message_id=A.message_id||M}),s("openLibrary",i,ne(T))}return E({scrollToBottom:W,scrollToMessage:G,resetScroll:v}),(d,T)=>{const M=fe,i=ae,A=ye,V=me("viewer");return t(),o("div",it,[e("div",{class:"scroll-box",ref_key:"scrollBoxRef",ref:r,onScroll:Q},[e("div",ct,[(t(!0),o(q,null,O(f.messages,n=>(t(),o(q,{key:n.uid},[n.is_customer==1?(t(),o("div",{key:0,class:"message-item user-message",id:"msg-"+n.uid},[e("div",_t,[e("img",{class:"user-avatar",src:n.avatar},null,8,ut)]),e("div",dt,[e("div",pt,[e("div",mt,g(n.content),1)])])],8,rt)):(t(),o("div",{key:1,class:"message-item robot-message",id:"msg-"+n.uid},[e("div",vt,[l(M,{size:"small",spinning:n.loading},{default:m(()=>[e("img",{class:"robot-avatar",src:n.robot_avatar},null,8,ht)]),_:2},1032,["spinning"])]),e("div",ft,[e("div",yt,[n.msg_type==1&&_.value?(t(),o("div",{key:0,class:K(["thinking-label-wrapper",{reasoning_open:n.show_quote_file}])},[e("div",{class:"thinking-label",onClick:C=>k(n)},[n.quote_loading?(t(),o(q,{key:0},[l(w(de),{class:"loading"}),kt],64)):(t(),o(q,{key:1},[l(i,{class:"think-icon",name:"quote-file"}),e("span",$t,"检索到"+g(n.quote_file.length)+"个知识库文档",1)],64)),n.quote_file.length?(t(),J(i,{key:2,name:"arrow-down",class:"arrow-down"})):y("",!0)],8,bt)],2)):y("",!0),n.reasoning_content?(t(),o("div",{key:1,class:K(["thinking-label-wrapper",{reasoning_open:n.show_reasoning}])},[e("div",{class:"thinking-label",onClick:C=>S(n)},[n.reasoning_status?(t(),J(w(de),{key:0,class:"loading"})):(t(),J(i,{key:1,class:"think-icon",name:"think"})),e("span",qt,g(n.reasoning_status?"深度思考中...":"已完成深度思考"),1),n.reasoning_status?y("",!0):(t(),J(i,{key:2,name:"arrow-down",class:"arrow-down"}))],8,wt),l(A,null,{title:m(()=>[L("在应用设置中关闭推理过程开关，将不再显示推理过程")]),default:m(()=>[l(w(De),{class:"tip"})]),_:1})],2)):y("",!0)]),e("div",St,[n.show_quote_file&&n.quote_file&&n.quote_file.length>0?(t(),o("div",Ct,[(t(!0),o(q,null,O(n.quote_file,C=>(t(),o("div",{class:"file-item",key:C.id,onClick:z=>R(n.quote_file,C,n.id)},[e("a",Tt,[l(i,{class:"think-icon",name:"quote-file"}),C.file_name?(t(),o("span",It,g(C.file_name),1)):(t(),o("span",Mt,g(C.library_name)+"-精选",1))])],8,xt))),128))])):y("",!0),n.show_reasoning?(t(),o("div",Lt,[l(pe,{content:n.reasoning_content},null,8,["content"])])):y("",!0),n.msg_type==1?(t(),o(q,{key:2},[Z((t(),o("div",Et,[l(pe,{content:n.content},null,8,["content"])])),[[V]]),e("div",Ot,[(t(!0),o(q,null,O(n.question,(C,z)=>(t(),o("div",{class:"menu-item",onClick:oe=>u(C),key:z},g(C),9,Rt))),128))])],64)):y("",!0),n.msg_type==2?(t(),o(q,{key:3},[e("div",{class:"message-content",innerHTML:n.menu_json.content},null,8,At),e("div",Bt,[(t(!0),o(q,null,O(n.menu_json.question,(C,z)=>(t(),o("div",{class:"menu-item",onClick:oe=>u(C),key:z},g(C),9,Dt))),128))])],64)):y("",!0),n.msg_type==3?(t(),o("div",Pt,[Z(e("img",{class:"msg-img",src:n.content,alt:""},null,8,Ft),[[V]])])):y("",!0),$(n)?Z((t(),o("div",Ht,[n.debug&&n.debug.length>0?(t(),o("div",Nt,[e("div",Ut,[e("span",null,[e("a",{onClick:C=>D(n)},"Prompt 日志",8,Qt)])])])):y("",!0)],512)),[[Ie,!n.question]]):y("",!0)]),(n.guess_you_want&&n.guess_you_want.length||c.value.length&&f.robotInfo.enable_common_question=="true")&&n.question_tabkey>0?(t(),J(lt,{key:0,item:n,enable_common_question:f.robotInfo.enable_common_question=="true",common_question_list:c.value,onClickMeun:u},null,8,["item","enable_common_question","common_question_list"])):y("",!0)])],8,gt))],64))),128))])],544)])}}},Vt=N(jt,[["__scopeId","data-v-a04d3aa0"]]),zt={class:"chat-list-box"},Jt=["onClick"],Kt={class:"chat-item-title"},Gt={__name:"chat-list",props:{list:{type:Array,default:()=>[]},active:{type:[String,Number],default:""}},emits:["openChat","onScrollEnd"],setup(p,{emit:E}){const b=E,s=p,f=x(null),S=c=>{b("openChat",c)},k=()=>{b("onScrollEnd")};return ge(()=>s.list,()=>{le(()=>{f.value.refresh()})}),(c,_)=>{const u=ae;return t(),o("div",zt,[l(be,{ref_key:"scroller",ref:f,onOnScrollEnd:k},{default:m(()=>[e("div",null,[(t(!0),o(q,null,O(s.list,r=>(t(),o("div",{class:K(["chat-list-item",{active:r.id==s.active}]),onClick:a=>S(r),key:r.id},[l(u,{class:"chat-item-icon",name:"message"}),e("span",Kt,g(r.subject||r.last_chat_message),1)],10,Jt))),128))])]),_:1},512)])}}},Yt=N(Gt,[["__scopeId","data-v-8a5dd127"]]),Wt=p=>(ee("data-v-47f207c0"),p=p(),te(),p),Zt={class:"message-input-wrapper"},Xt={class:"message-action"},eo={class:"loading-action"},to=["disabled"],oo=Wt(()=>e("span",null,"发送",-1)),so=[oo],no={__name:"message-input",props:{value:{type:String,default:""},loading:{type:Boolean,default:!1}},emits:["send","update:value"],setup(p,{emit:E}){const b=E,s=p,f=X(()=>s.loading||s.value.trim().length===0),S=_=>{b("update:value",_.target.value.trim())},k=_=>{if(_.key==="Enter"&&!_.shiftKey){if(!_.target.value.trim())return;_.preventDefault(),c()}else _.key==="Enter"&&_.shiftKey&&(_.preventDefault(),b("update:value",s.value+`
`))},c=()=>{b("send",s.value.trim())};return(_,u)=>{const r=Qe,a=fe;return t(),o("div",Zt,[l(r,{value:p.value,"auto-size":{minRows:5,maxRows:5},placeholder:"在此输入您想了解的内容，Shift+Enter换行",onChange:S,onKeydown:k},null,8,["value"]),e("div",Xt,[e("span",eo,[l(a,{spinning:p.loading},null,8,["spinning"])]),p.loading?y("",!0):(t(),o("button",{key:0,class:"send-msg-btn",disabled:f.value,onClick:c},so,8,to))])])}}},lo=N(no,[["__scopeId","data-v-47f207c0"]]),U=p=>(ee("data-v-c821359c"),p=p(),te(),p),ao={class:"prompt-log-content"},io={class:"prompt-log-items"},co={class:"prompt-log-label"},ro=U(()=>e("span",null,"SYSTEM ",-1)),_o={class:"prompt-log-item"},uo={class:"prompt-log-items"},po={class:"prompt-log-label"},mo=U(()=>e("span",null,"上下文 ",-1)),go={class:"prompt-log-items"},vo={class:"prompt-log-label"},ho=U(()=>e("span",null,"USER ",-1)),fo={class:"prompt-log-item"},yo={class:"prompt-log-items"},bo={class:"prompt-log-label"},ko=U(()=>e("span",null,"ASSISTANT ",-1)),$o={class:"prompt-log-item"},wo={key:0,class:"prompt-log-items"},qo={class:"prompt-log-label"},So=U(()=>e("span",null,"Recall time ",-1)),Co={class:"prompt-log-item"},xo={key:1,class:"prompt-log-items"},To={class:"prompt-log-label"},Io=U(()=>e("span",null,"Request time ",-1)),Mo={class:"prompt-log-item"},Lo={class:"prompt-log-items"},Eo={class:"prompt-log-label"},Oo=U(()=>e("span",null,"Error ",-1)),Ro={class:"prompt-log-item"},Ao={__name:"prompt-log-alert",setup(p,{expose:E}){const b=x(!1),s=Me({prompt:"",library:[],context_qa:[],cur_question:"",cur_answer:"",error:""}),f=()=>{b.value=!1},S=()=>{s.prompt="",s.library=[],s.context_qa=[],s.cur_question="",s.cur_answer="",s.error="",s.recall_time="",s.request_time=""};return E({open:c=>{S(),s.error=c.error,s.recall_time=c.recall_time?(c.recall_time/1e3).toFixed(2):"",s.request_time=c.request_time?(c.request_time/1e3).toFixed(2):"";let _=c.debug||[];for(let u=0;u<_.length;u++){let r=_[u];r.type=="library"?s.library.push(r.content):r.type=="context_qa"?s.context_qa.push(r):s[r.type]=r.content}b.value=!0}}),(c,_)=>{const u=ye,r=ke;return t(),J(r,{class:"prompt-log-alert",open:b.value,"onUpdate:open":_[0]||(_[0]=a=>b.value=a),title:"Prompt 日志",placement:"right",width:"746px",closable:!1},{extra:m(()=>[e("span",{class:"close-btn",onClick:f},[l(w(he))])]),default:m(()=>[e("div",ao,[e("div",io,[e("div",co,[ro,l(u,null,{title:m(()=>[L("系统提示词和文档分段。")]),default:m(()=>[l(w(H),{class:"question-icon"})]),_:1})]),e("div",_o,[e("p",null,g(s.prompt),1)]),(t(!0),o(q,null,O(s.library,(a,I)=>(t(),o("div",{class:"prompt-log-item",key:I},[e("p",null,g(a),1)]))),128))]),e("div",uo,[e("div",po,[mo,l(u,null,{title:m(()=>[L("传递的历史提问消息")]),default:m(()=>[l(w(H),{class:"question-icon"})]),_:1})]),(t(!0),o(q,null,O(s.context_qa,(a,I)=>(t(),o("div",{class:"prompt-log-item",key:I},[e("p",null,"Q："+g(a.question),1),e("p",null,"A："+g(a.answer),1)]))),128))]),e("div",go,[e("div",vo,[ho,l(u,null,{title:m(()=>[L("本次用户的提问")]),default:m(()=>[l(w(H),{class:"question-icon"})]),_:1})]),e("div",fo,[e("p",null,g(s.cur_question),1)])]),e("div",yo,[e("div",bo,[ko,l(u,null,{title:m(()=>[L("语言模型输出的答案")]),default:m(()=>[l(w(H),{class:"question-icon"})]),_:1})]),e("div",$o,[e("p",null,g(s.cur_answer),1)])]),s.recall_time>0?(t(),o("div",wo,[e("div",qo,[So,l(u,null,{title:m(()=>[L("从知识库中检索到有效分段所需要的时间，包括对分段进行排序时间。")]),default:m(()=>[l(w(H),{class:"question-icon"})]),_:1})]),e("div",Co,[e("p",null,g(s.recall_time)+"s",1)])])):y("",!0),s.request_time>0?(t(),o("div",xo,[e("div",To,[Io,l(u,null,{title:m(()=>[L("从发送问题和上下文信息给大模型到大模型开始返回答案的时间。")]),default:m(()=>[l(w(H),{class:"question-icon"})]),_:1})]),e("div",Mo,[e("p",null,g(s.request_time)+"s",1)])])):y("",!0),e("div",Lo,[e("div",Eo,[Oo,l(u,null,{title:m(()=>[L("报错信息，调用聊天接口报错时会显示。")]),default:m(()=>[l(w(H),{class:"question-icon"})]),_:1})]),e("div",Ro,[e("p",null,g(s.error),1)])])])]),_:1},8,["open"])}}},Bo=N(Ao,[["__scopeId","data-v-c821359c"]]),Do={class:"library-info-content"},Po={class:"file-list"},Fo=["onClick"],Ho={key:0},No={key:1},Uo={class:"document-items"},Qo={class:"document-item-header"},jo={class:"left-box"},Vo={class:"document-title"},zo={key:0,class:"document-title"},Jo={class:"document-size"},Ko={class:"right-box"},Go=["onClick"],Yo={class:"document-item-body"},Wo={class:"document-similarity"},Zo={key:0,class:"document-content"},Xo={key:1,class:"document-content"},es={class:"document-content"},ts={class:"fragment-img"},os=["src"],ss={class:"iframe-box"},ns={__name:"library-info-alert",setup(p,{expose:E}){const b=ve(),{robot:s,user:f}=b;Le();const S=x(!1),k=x([]),c=x(null),_=()=>{k.value=[],c.value=null},u=(v,$)=>{if(_(),k.value=v.map(D=>{let R=null;return D.answer_source_data&&(R=JSON.parse(D.answer_source_data)),{...D,answer_source_data:R}}),c.value=$.id,S.value=!0,$.answer_source_data){a.value=JSON.parse($.answer_source_data)||[];return}I($)},r=v=>{if(v.id!=c.value){if(c.value=v.id,v.answer_source_data){a.value=v.answer_source_data||[];return}I(v)}},a=x([]),I=v=>{je({message_id:v.message_id,file_id:v.id,robot_key:s.robot_key,openid:s.openid}).then($=>{a.value=$.data||[]})},B=()=>{let v=k.value.filter($=>$.id==c.value)[0]||{};v.file_name?window.open(`#/library/preview?id=${c.value}`):window.open(`#/library/details/categary-manage?id=${v.library_id}`)},Q=X(()=>{let v=k.value.filter($=>$.id==c.value)[0]||{};return v.file_name?v.file_name:v.library_name+"-精选"}),j=x(""),P=x(!1),W=v=>{P.value=!0,j.value="/manage/getLibRawFileOnePage?id="+c.value+"&page="+v.page_num+"&admin_user_id="+f.admin_user_id},G=()=>{S.value=!1};return E({open:u}),(v,$)=>{const D=ae,R=ke,d=be,T=Pe,M=me("viewer");return t(),o(q,null,[l(R,{class:"library-info-alert",open:S.value,"onUpdate:open":$[0]||($[0]=i=>S.value=i),title:"答案来源",placement:"right",width:"746px",closable:!1,bodyStyle:{background:"#F2F4F7"}},{extra:m(()=>[e("span",{class:"close-btn",onClick:G},[l(w(he))])]),default:m(()=>[e("div",Do,[e("div",Po,[(t(!0),o(q,null,O(k.value,i=>(t(),o("div",{class:K(["file-item",{active:c.value==i.id}]),key:i.id,onClick:A=>r(i)},[i.file_name?(t(),o("span",Ho,g(i.file_name),1)):(t(),o("span",No,g(i.library_name)+"-精选",1))],10,Fo))),128))]),e("div",Uo,[(t(!0),o(q,null,O(a.value,i=>(t(),o("div",{class:"document-item",key:i.id},[e("div",Qo,[e("div",jo,[e("span",Vo,"id："+g(i.id),1),i.title?(t(),o("span",zo,g(i.title),1)):y("",!0),e("span",Jo," 共"+g(i.word_total)+"个字符 ",1)]),e("div",Ko,[i.page_num>0?(t(),o("a",{key:0,onClick:A=>W(i)},"预览原文件>",8,Go)):y("",!0),e("a",{onClick:B},"查看源文档>")])]),e("div",Yo,[e("div",Wo,[L(" 相似度： "),l(D,{name:"similarity",style:{"font-size":"16px"}}),L(g(i.similarity),1)]),i.question?(t(),o("div",Zo,"Q："+g(i.question),1)):y("",!0),i.answer?(t(),o("div",Xo,"A："+g(i.answer),1)):y("",!0),e("div",es,g(i.content),1),Z((t(),o("div",ts,[(t(!0),o(q,null,O(i.images,(A,V)=>(t(),o("img",{key:V,src:A,alt:""},null,8,os))),128))])),[[M]])])]))),128))])])]),_:1},8,["open"]),l(T,{open:P.value,"onUpdate:open":$[1]||($[1]=i=>P.value=i),title:Q.value,footer:null,width:740},{default:m(()=>[e("div",ss,[l(d,null,{default:m(()=>[l(w(Ve),{source:j.value},null,8,["source"])]),_:1})])]),_:1},8,["open","title"])],64)}}},ls=N(ns,[["__scopeId","data-v-e8bc69ca"]]),as=p=>(ee("data-v-7257bb7b"),p=p(),te(),p),is={class:"chat-page-wrapper"},cs={class:"chat-page-header"},rs={class:"breadcrumb-box"},_s={class:"chat-page"},us={class:"page-left"},ds={class:"page-left-top"},ps={class:"page-left-body"},ms=as(()=>e("div",{class:"page-left-footer"},null,-1)),gs={class:"page-body"},vs={class:"chat-box-body"},hs={style:{"margin-top":"30px"},class:"chat-box-footer"},fs={__name:"index",setup(p){const b=ue().query,s=Je(),{getRobot:f,robotInfo:S}=s,k=Be(),c=ve(),_=Fe();let u=!0;const r=x(""),a=x(null),{createChat:I,sendMessage:B,getMyChatList:Q,openChat:j,onGetChatMessage:P,changeRobotPrompt:W,$reset:G}=c,{messageList:v,sendLock:$,myChatList:D,robot:R,dialogue_id:d}=Ee(c),T=ue(),M=x(!1),i=async()=>{if(!r.value)return He("请输入消息内容");let h=await ze({robot_key:R.value.robot_key,openid:R.value.openid,question:r.value,form_ids:R.value.form_ids,dialogue_id:d.value});if(h.data&&h.data.words)return Ne.error(`提交的内容包含敏感词：[${h.data.words.join(";")}] 请修改后再提交`);u=!0,B({message:r.value,global:JSON.stringify(b)}),r.value=""},A=async()=>{u=!0,r.value="";let h=T.query||{},F=_.user_id,Y={robot_key:h.robot_key,avatar:h.avatar,name:h.name,nickname:h.nickname,is_background:1,openid:F,dialogue_id:0};ce(),await I(Y)},V=async h=>{if(d.value==h.dialogue_id)return;u=!0;let Y={robot_key:(T.query||{}).robot_key,avatar:h.avatar,name:h.name,nickname:h.nickname,is_background:h.is_background,openid:h.openid,dialogue_id:h.id};ce(),await j(Y),await P()&&ie()},n=h=>{u=!0,B({message:h})};x(!1);const C=()=>{ie()},z=async()=>{u=!1;let h=v.value[0].uid;await P()&&$e(h)},oe=()=>{},ie=()=>{a.value&&u&&a.value.scrollToBottom()},$e=h=>{a.value&&a.value.scrollToMessage(h)},ce=()=>{a.value&&a.value.resetScroll()},we=()=>{Q()},re=x(null),qe=h=>{re.value.open(h)},_e=x(null),Se=(h,F)=>{_e.value.open(h,F)};return ge(()=>v.value,()=>{}),Oe(async()=>{A(),Q(),await f(b.id),M.value=!0,k.on("updateAiMessage",C)}),Re(()=>{G(),k.off("updateAiMessage",C)}),(h,F)=>{const Y=Ae("router-link"),se=Ge,Ce=Ke,xe=Ue;return t(),o("div",is,[e("div",cs,[e("div",rs,[l(Ce,null,{default:m(()=>[l(se,null,{default:m(()=>[l(Y,{to:"/robot/list"},{default:m(()=>[L("机器人管理")]),_:1})]),_:1}),l(se,null,{default:m(()=>[L(g(w(R).robot_name),1)]),_:1})]),_:1})])]),e("div",_s,[e("div",us,[e("div",ds,[l(xe,{type:"primary",block:"",ghost:"",onClick:A},{default:m(()=>[l(w(Ye)),L(" 新建对话")]),_:1})]),e("div",ps,[l(Yt,{list:w(D),active:w(d),onOpenChat:V,onOnScrollEnd:we},null,8,["list","active"])]),ms]),e("div",gs,[e("div",vs,[l(Vt,{ref_key:"messageListRef",ref:a,messages:w(v),robotInfo:w(S),onClickMsgMeun:n,onScrollStart:z,onScrollEnd:oe,onOpenPromptLog:qe,onOpenLibrary:Se},null,8,["messages","robotInfo"])]),e("div",hs,[l(lo,{value:r.value,"onUpdate:value":F[0]||(F[0]=Te=>r.value=Te),onSend:i,loading:w($)},null,8,["value","loading"])])]),e("div",null,[y("",!0)])]),l(Bo,{ref_key:"promptLogAlertRef",ref:re},null,512),l(ls,{ref_key:"libraryInfoAlertRef",ref:_e},null,512)])}}},nn=N(fs,[["__scopeId","data-v-7257bb7b"]]);export{nn as default};
