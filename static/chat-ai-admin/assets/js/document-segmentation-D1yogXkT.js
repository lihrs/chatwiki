import{a5 as ge,a4 as be,e as l,x as ye,b as Se,D as xe,a8 as qe,M as h,N as S,k as o,a7 as A,W as u,S as k,u as we,Z as K,Q as Fe,Y as z,F as X,$ as Le,a1 as Ee,a2 as Te}from"./vue-chunks-BjMuQ6KD.js";import{S as De,D as Ce,E as ze,a as Ie}from"./edit-fragment-alert-Bv6RlMlR.js";import{b as Ne,bL as Oe,M as I,E as ee,bM as Be,bN as Ae,bO as Re,k as te,bP as Me,bQ as Ve}from"../../index-CfxQ5aRu.js";import{B as Qe,_ as je}from"./index-Q8_wcZdl.js";import{S as Je}from"./index-BLP-Fxny.js";import{L as Pe}from"./LeftOutlined-qzkQKHcF.js";import"./empty-CzGZrENG.js";import"./model-select-c6lAzYs5.js";import"./index-d7geF-HW.js";import"./index-BuS_bfCI.js";import"./Trigger-Dy6Dc2CN.js";import"./ResizeObserver.es-B1PUzC5B.js";import"./index-D6-G2N0k.js";import"./slide-BYYxYcj9.js";import"./index-CXSrVsd0.js";import"./CheckOutlined-BLsT0eZM.js";import"./DownOutlined-Gk0UBxct.js";import"./SearchOutlined-B7dGgS_P.js";import"./FormItemContext-DQ1b1ToO.js";import"./move-BjmscfYf.js";import"./index-D8Y0HnA5.js";import"./index-BWdnNCYH.js";import"./index-BMSQkwth.js";import"./index-Capld-U4.js";import"./index-QsoU6-T8.js";import"./UpOutlined-CY9GinGn.js";import"./index-xqeVJHPz.js";import"./isPlainObject-xAKL-sfk.js";import"./responsiveObserve-X1b6Czsg.js";import"./collapseMotion-BH6Vz7El.js";import"./index-D1MiuDW_.js";import"./colors-C9XVGyX_.js";import"./QuestionCircleOutlined-Deh272L3.js";import"./index-DcUUFn-g.js";import"./Input-C5WaaE9Z.js";import"./inputProps-D7qr__m5.js";import"./Search-DozVr2pE.js";import"./TextArea-CN_AI7y7.js";import"./Password-BCnVcrNJ.js";import"./index-Qxwv7brO.js";import"./index-CL2f_cnE.js";import"./index-BLNMWHkL.js";import"./index-DqFgAaLP.js";import"./DownloadOutlined-BrqGknZq.js";import"./index-BMYKVcHu.js";import"./index-Bx_z5H0C.js";import"./shallowequal-B6gQS78g.js";import"./dropdown-DsYo-imx.js";import"./RightOutlined-BHf0iqSq.js";import"./pick-CoYCIHvO.js";import"./PlusOutlined-xiVHYVI8.js";import"./axios-Cm0UX6qg.js";import"./qs-DjdPq-RR.js";import"./crypto-js-BemCeW_6.js";import"./dayjs-DK4rpucX.js";const ae=x=>(Ee("data-v-2f55be46"),x=x(),Te(),x),$e={key:0,class:"loading-wrap"},We={class:"document-segmentation"},Ue={class:"breadcrumb-block"},Ye={class:"page-title"},Ze=ae(()=>u("span",{class:"title"},"文档分段与清洗",-1)),Ge={class:"page-container"},He={class:"page-left"},Ke={class:"page-right"},Xe={class:"document-fragment-preview"},et={class:"preview-header"},tt=ae(()=>u("span",{class:"label-text"},"分段预览",-1)),at={class:"fragment-number"},nt={key:1,class:"loading-box"},it="你是一位文章分段助手，根据文章内容的语义进行合理分段，确保每个分段表述一个完整的语义，每个分段字数控制在500字左右，最大不超过1000字。请严格按照文章内容进行分段，不要对文章内容进行加工，分段完成后输出分段后的内容。",lt={__name:"document-segmentation",setup(x){const ne=Oe(),q=ge(),N=be(),{setInitDocumentFragmentList:R}=ne,{document_id:w}=q.query,F=l(!0),L=l(1),M=l(1);let v=!1,a={id:w,separators_no:"",chunk_size:512,chunk_overlap:50,is_qa_doc:0,question_lable:"",similar_label:"",answer_lable:"",enable_extract_image:!0,ai_chunk_size:5e3,ai_chunk_model:"",ai_chunk_model_config_id:"",ai_chunk_prumpt:it,ai_chunk_task_id:""},V=!1;const r=l(null),ie=e=>{typeof e.separators_no=="object"&&(e.separators_no=e.separators_no.join(",")),V=!0,a={...a,...e},v?I.confirm({title:"提醒",icon:o(ee),content:"文档片段已被编辑重新获取文档片段会丢失当前修改过的文档片段内容，确定要重新获取吗？",okText:"确定",okType:"danger",cancelText:"取消",onOk(){v=!1,y("create")},onCancel(){}}):(v=!1,y("create"))};let le=60*10,Q=0,j=null;const E=l({}),T=l(0),J=()=>{F.value||(F.value=!0),Be({id:w}).then(async e=>{const{status:t}=e.data;if(T.value=e.data.library_type,E.value=e.data,a={...a,separators_no:e.data.separators_no||"11,12",chunk_size:+e.data.chunk_size||512,ai_chunk_size:+e.data.ai_chunk_size||5e3,chunk_overlap:+e.data.chunk_overlap||50,is_qa_doc:T.value==2?1:0,question_lable:e.data.question_lable,similar_label:e.data.similar_label,answer_lable:e.data.answer_lable,question_column:e.data.question_column,similar_column:e.data.similar_column,answer_column:e.data.answer_column,enable_extract_image:e.data.enable_extract_image=="true",qa_index_type:+e.data.qa_index_type,chunk_type:+e.data.chunk_type,semantic_chunk_size:+e.data.semantic_chunk_size||512,semantic_chunk_overlap:+e.data.semantic_chunk_overlap||50,semantic_chunk_threshold:+e.data.semantic_chunk_threshold||90,semantic_chunk_use_model:e.data.semantic_chunk_use_model||"",ai_chunk_prumpt:e.data.ai_chunk_prumpt||"",ai_chunk_model:e.data.ai_chunk_model||"",semantic_chunk_model_config_id:e.data.semantic_chunk_model_config_id>0?e.data.semantic_chunk_model_config_id:"",ai_chunk_model_config_id:e.data.ai_chunk_model_config_id>0?e.data.ai_chunk_model_config_id:"",ai_chunk_task_id:e.data.ai_chunk_task_id||""},e.data.chunk_type==0&&(a={...a,separators_no:e.data.normal_chunk_default_separators_no,chunk_size:e.data.normal_chunk_default_chunk_size,chunk_overlap:e.data.normal_chunk_default_chunk_overlap,chunk_type:+e.data.default_chunk_type,semantic_chunk_size:+e.data.semantic_chunk_default_chunk_size,semantic_chunk_overlap:+e.data.semantic_chunk_default_chunk_overlap,semantic_chunk_threshold:+e.data.semantic_chunk_default_threshold,semantic_chunk_use_model:e.data.default_use_model||"",semantic_chunk_model_config_id:e.data.default_model_config_id>0?e.data.default_model_config_id:""}),t==0){if(Q++,Q>le){I.error({title:"提醒",content:"文档解析速度慢请稍后再试"});return}setTimeout(()=>{J()},1e3)}else t==4||t==2?(F.value=!1,L.value=parseInt(e.data.is_table_file),j=e.data.library_id,T.value==2?(a.question_lable||a.question_column)&&y():y()):N.replace("/library/details?id="+e.data.library_id);e.data.is_table_file==1&&oe()})};ye(async()=>{await J()});const P=l([]),oe=()=>{Ae({id:w}).then(e=>{let t=[];for(let n in e.data)t.push({lable:e.data[n],value:n});P.value=t})},$=l(!1),g=l(!1),O=l(""),b=l(null);let d=null;const i=l([]),D=l([]),m=l(0),se=Se(()=>m.value<=0),y=e=>{let t={...a,semantic_chunk_model_config_id:a.semantic_chunk_model_config_id?+a.semantic_chunk_model_config_id:0,ai_chunk_model_config_id:a.ai_chunk_model_config_id?+a.ai_chunk_model_config_id:0};return a.chunk_type==3&&(a.ai_chunk_task_id&&!e&&(t.ai_chunk_task_id=a.ai_chunk_task_id),e&&e==="create"&&(t.ai_chunk_preview=!0,delete t.ai_chunk_task_id)),Re(t).then(n=>{var c;D.value=n.data.list||[],R(D.value),i.value=n.data.list||[],m.value=n.data.list.length||0,a.chunk_type==3&&(O.value=((c=n.data.split_params)==null?void 0:c.ai_chunk_task_id)||"",g.value=!0,r.value.reLoading=!0,b.value=null,!a.ai_chunk_task_id&&L.value!=1||e&&e==="create"?(i.value=[],m.value=0,re()):(g.value=!1,r.value.reLoading=!1))}).finally(()=>{a.chunk_type!=3&&(r.value.reLoading=!1,r.value.saveLoading=!1)})},_e=e=>{M.value=e},ue=async()=>{var e;try{const t=await de();return t.data.err_msg?(b.value=t.data.err_msg,!0):((e=t.data.list)==null?void 0:e.length)>0?(D.value=t.data.list||[],R(D.value),i.value=t.data.list||[],m.value=t.data.list.length||0,!0):!1}catch{return b.value="请求异常，停止轮询",!0}};function ce(e){return e.split("message:")[1]}const re=()=>{const e=async()=>{if(!await ue())d=setTimeout(e,3e3);else if(g.value=!1,r.value.reLoading=!1,r.value.saveLoading=!1,d!==null&&(clearTimeout(d),d=null),$.value&&Z(),b.value){let n=ce(b.value);I.error({title:"分段失败提示",content:n?`模型调用失败，失败原因：${n}`:"模型调用失败"})}};e()},de=()=>Ve({id:a.id,task_id:O.value}),W=l(null);let s=null;const me=(e,t)=>{let{title:n,content:c,question:p,answer:f,images:_,similar_question_list:C}=e;s=t,W.value.open({title:n,content:c,question:p,answer:f,images:_,similar_question_list:C})},pe=({title:e,content:t,question:n,answer:c,images:p,similar_question_list:f})=>{(i.value[s].title!=e||i.value[s].content!=t||i.value[s].question!=n||i.value[s].answer!=c)&&(v=!0),i.value[s].title=e,i.value[s].content=t,i.value[s].question=n,i.value[s].answer=c,i.value[s].images=p,i.value[s].similar_question_list=f?f.split(`
`):[],i.value[s].word_total=c.length+n.length+t.length},fe=e=>{I.confirm({title:"提醒",icon:o(ee),content:"确定要删除这个片段吗?",okText:"确定",okType:"danger",cancelText:"取消",onOk(){v=!0,i.value.splice(e,1)},onCancel(){}})},B=l(""),he=e=>{B.value=e},U=l(!1),Y=()=>{let e=r.value.formState;e=JSON.parse(JSON.stringify(e)),typeof e.separators_no=="object"&&(e.separators_no=e.separators_no.join(",")),a={...a,...e}},Z=async()=>{if((m.value<=0||a.chunk_type!=M.value)&&(Y(),await y()),Y(),B.value)return te.error(B.value);if(a.chunk_type==3&&!i.value.length)return $.value=!0,!1;O.value!==a.ai_chunk_task_id&&delete a.ai_chunk_task_id;let e={...a,semantic_chunk_model_config_id:a.semantic_chunk_model_config_id?+a.semantic_chunk_model_config_id:0,ai_chunk_model_config_id:a.ai_chunk_model_config_id?+a.ai_chunk_model_config_id:0,is_table_file:L.value};delete e.id;let t={id:w,word_total:m.value,split_params:JSON.stringify(e),list:JSON.stringify(i.value)};e.is_qa_doc==1&&(t.qa_index_type=e.qa_index_type),U.value=!0,Me(t).then(()=>{if(te.success("保存成功"),q.query.source=="preview"&&!V){H();return}let n=1;q.query.page&&(n=q.query.page),N.replace("/library/details?id="+j+"&page="+n)}).finally(()=>{U.value=!1}).catch(n=>{n.data&&n.data.index&&ke(n.data.index)})},G=l(null),ke=e=>{e=e-1;let t=G.value.querySelectorAll(".fragment-item");t.length>=e&&t[e].scrollIntoView({behavior:"smooth",block:"start",inline:"nearest"})},H=()=>{N.back()};return xe(()=>{d&&(clearTimeout(d),d=null)}),(e,t)=>{const n=Je,c=qe("router-link"),p=je,f=Qe;return h(),S(X,null,[F.value?(h(),S("div",$e,[o(n)])):A("",!0),u("div",We,[u("div",Ue,[o(f,null,{default:k(()=>[o(p,null,{default:k(()=>[o(c,{to:"/library/list"},{default:k(()=>[z(" 知识库管理 ")]),_:1})]),_:1}),o(p,null,{default:k(()=>[o(c,{to:{path:"/library/details/knowledge-document",query:{id:E.value.library_id}}},{default:k(()=>[z(K(E.value.library_name)+"知识库",1)]),_:1},8,["to"])]),_:1}),o(p,null,{default:k(()=>[z("分段设置")]),_:1})]),_:1})]),u("div",Ye,[o(we(Pe),{onClick:H}),Ze]),u("div",Ge,[u("div",He,[o(De,{excellQaLists:P.value,libFileInfo:E.value,library_type:T.value,mode:L.value,ref_key:"segmentationSettingRef",ref:r,onChange:ie,onChangeChunkType:_e,onSave:Z,onValidate:he},null,8,["excellQaLists","libFileInfo","library_type","mode"])]),u("div",Ke,[u("div",Xe,[u("div",et,[tt,u("span",at,"共"+K(m.value)+"个分段",1)]),se.value&&!g.value?(h(),Fe(Ie,{key:0})):A("",!0),g.value?(h(),S("div",nt,[o(n),z("数据处理中...")])):A("",!0),u("div",{class:"preview-box",ref_key:"previewBoxRef",ref:G},[(h(!0),S(X,null,Le(i.value,(_,C)=>(h(),S("div",{class:"fragment-item",key:_.number},[o(Ce,{number:_.number,title:_.title,content:_.content,total:_.word_total,question:_.question,answer:_.answer,images:_.images,similar_question_list:_.similar_question_list,onDelete:ve=>fe(C),onEdit:ve=>me(_,C)},null,8,["number","title","content","total","question","answer","images","similar_question_list","onDelete","onEdit"])]))),128))],512)])])]),o(ze,{ref_key:"editFragmentAlertRef",ref:W,onOk:pe},null,512)])],64)}}},sa=Ne(lt,[["__scopeId","data-v-2f55be46"]]);export{sa as default};
