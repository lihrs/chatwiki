import{e as _e,d as L,z as G,w as Z,q as W,N as u,O as _,F as V,j as r,k as me,u as K,U as g,Z as B,X as t,S as D,a6 as P,a1 as H,a5 as le,_ as O,G as ue,Y as pe,V as ve,ao as fe,M as ne,a8 as ae,D as he}from"./vue-chunks-BRsu9_To.js";import{B as ge,d as ee,k as oe,dG as ye,b as Q,aA as ke,df as be,bz as X,aB as xe,aD as $e,dH as Se,bC as Le,dI as we,a0 as Ae,bH as Ce,bE as Me,bF as Re}from"../../index-CvfGQnmW.js";import{c as ie}from"./index-CiT4vUhP.js";import{M as Ne}from"./model-select-DyyTdKgZ.js";import{S as qe}from"./SettingOutlined-BEM-iOsd.js";import"./index-ESeBgLel.js";import{_ as Ie,R as Ue}from"./RadioButton-Bh1r7hrP.js";import{Q as J}from"./QuestionCircleOutlined-DsT-V90y.js";import{S as Be,a as Oe,i as Te}from"./index-Bic_ld4j.js";import{_ as ze}from"./index-C37-Fm3T.js";import{_ as Ee}from"./TextArea-B40Dha8W.js";import{_ as re}from"./index-B-ykUzgY.js";import{_ as Fe}from"./index-WowefPIW.js";import{_ as je}from"./index-D2a_iSIQ.js";import{_ as Ke}from"./index-ChS1NVDw.js";import{M as Ve}from"./index-BMSQkwth.js";import"./index-DUS5CIPm.js";import{I as De}from"./Input-DT-w6V-X.js";import{u as Pe}from"./useEventBus-BwH2zX88.js";import{C as He,_ as Je}from"./index-C_DWe9ZR.js";import{I as Ge}from"./index-VM7ozw2f.js";import"./axios-Dq7h7Pqt.js";import"./qs-BrxkIg-9.js";import"./crypto-js-ClNpte_9.js";import"./dayjs-B6IotFah.js";import"./index-BjEoDhm5.js";import"./FormItemContext-CFzzmp00.js";import"./Checkbox-CD3yZxoG.js";import"./Trigger-C5a0DMKm.js";import"./ResizeObserver.es-B1PUzC5B.js";import"./index-B0doyz59.js";import"./slide-vrDadJH3.js";import"./index-DaOSj_2K.js";import"./CheckOutlined-N7bppPAu.js";import"./DownOutlined-DKJ0lkJp.js";import"./SearchOutlined-B9P7O4A9.js";import"./move-CunrTozH.js";import"./inputProps-DJXIqADS.js";import"./colors-Cy2bPHOW.js";import"./UpOutlined-BZVglKCC.js";import"./Search-BVbdzfe3.js";import"./isPlainObject-C_BoBcyP.js";import"./Password-Bl0n4Nu8.js";import"./index-BNsyVryY.js";import"./LeftOutlined-CaA0Q_W1.js";import"./RightOutlined-DQOW11d0.js";const Qe={class:"prompt-form"},Ye={class:"prompt-form-item"},Xe={class:"prompt-form-item"},Ze={class:"prompt-form-item-content"},We={key:0,class:"prompt-form-item-tip"},et={class:"prompt-form-item"},tt={class:"prompt-form-item-label"},st={class:"form-item-body"},at={class:"number-box"},ot={class:"number-slider-box"},lt={class:"number-input-box"},nt={class:"prompt-form-item"},it={class:"prompt-form-item-label"},rt={class:"form-item-body"},dt={class:"number-box"},ct={class:"number-slider-box"},_t={class:"number-input-box"},mt={class:"recall-settings-box"},ut={class:"form-box prompt-form"},pt={class:"form-item is-required"},vt={class:"form-item-body"},ft={class:"retrieval-mode-items"},ht=["onClick"],gt={class:"retrieval-mode-title"},yt={class:"title-text"},kt={class:"retrieval-mode-desc"},bt={class:"form-item"},xt={class:"form-item-label"},$t={class:"form-item-body"},St={class:"number-box"},Lt={class:"number-slider-box"},wt={class:"number-input-box"},At={key:0,class:"form-item"},Ct={class:"form-item-label"},Mt={class:"form-item-body"},Rt={class:"number-box"},Nt={class:"number-slider-box"},qt={class:"number-input-box"},It={class:"form-item"},Ut={class:"form-item-label"},Bt={key:0,class:"form-item-body"},Ot=["src"],Tt=_e({__name:"search-drawer",props:{librarySearchData:{type:Object,default:null},defaultLibrarySearchData:{type:Object,default:null}},setup(b){const n=b,A=L([{iconName:"mix-icon",title:"混合检索",value:1,isRecommendation:!0,desc:"同时执行三种检索模式，使用RRF算法进行排序，从三种查询结果中选择更匹配用户问题的结果。混合检索兼顾语义相似性与逻辑关联性，通过互补优势提升检索的准确性和生成结果的可信度"},{iconName:"vector-icon",title:"向量检索",value:2,desc:"将用户提问转成向量之后与知识库分段匹配相似度，返回相似度高的结果。向量检索擅长语义相似性匹配和大规模非结构化数据处理，但缺乏可解释性和精准关系验证"},{iconName:"graph-icon",title:"知识图谱检索",value:4,desc:"通过关系推理，检索出与用户问题相关联的知识。知识图谱检索擅长精准的实体关系推理和逻辑验证，但对非结构化文本和语义模糊查询支持较弱"},{iconName:"search-check-icon",title:"全文检索",value:3,desc:"通过分词匹配文档中的词汇，返回包含这些词汇的文本片段"}]),q=L(!1),s=G({use_model:"",model_config_id:"",prompt_type:"0",prompt:"",temperature:.5,max_token:2e3,context_pair:0,search_type:1,top_k:5,size:0,similarity:.4,rerank_status:0,rerank_use_model:void 0,rerank_model_config_id:void 0}),N=L([]),C=()=>{ie({model_type:"RERANK"}).then(a=>{let e=a.data||[];N.value=e.map(M=>({id:M.model_config.id,name:M.model_info.model_name,icon:M.model_info.model_icon_url,children:M.model_info.rerank_model_list}))})},w=(a,e)=>{s.use_model=e.modelName,s.model_config_id=e.modelId,k()},T=L([]),j=a=>{var e,M,I,E,F;if(T.value=a,!((e=n.librarySearchData)!=null&&e.model_config_id)||!((M=n.librarySearchData)!=null&&M.use_model)){if(T.value.length>0){let l=T.value[0];if(l){let i=l.children[0];s.use_model=i.name,s.model_config_id=i.model_config_id}}}else s.use_model=((I=n.librarySearchData)==null?void 0:I.use_model)+"$$",s.model_config_id=((E=n.librarySearchData)==null?void 0:E.model_config_id)+"$$",s.use_model=s.use_model.split("$$")[0],s.model_config_id=(F=n.librarySearchData)==null?void 0:F.model_config_id.split("$$")[0]},y=a=>{s.search_type=a,k()},d=(a,e)=>{s.rerank_model_config_id=e.rerank_model_config_id,k()},m=a=>{let e={...a};e.max_token=parseFloat(e.max_token),e.temperature=parseFloat(e.temperature),e.context_pair=parseFloat(e.context_pair),e.search_type=parseFloat(e.search_type),e.rerank_status=parseFloat(e.rerank_status),e.similarity=parseFloat(e.similarity),e.top_k=parseFloat(e.size),e.rerank_use_model===""&&(e.rerank_use_model=void 0),Object.keys(e).forEach(M=>{s[M]=e[M]})},k=()=>{let a={...s};if(!a.prompt&&s.prompt_type=="1")return oe.error("请输入自定义提示词");(s.search_type==3||s.search_type==4)&&delete a.similarity,s.prompt_type=="0"&&delete a.prompt,a.size=a.top_k,ye(a).then(e=>{oe.success("保存成功")})},v=a=>{},p=()=>{q.value=!0};return Z(()=>n.librarySearchData,a=>{var e;(e=n.librarySearchData)!=null&&e.id&&m({...ue(n.librarySearchData)})}),W(()=>{C()}),(a,e)=>{const M=ge,I=Ue,E=Ie,F=Ee,l=re,i=Fe,x=je,f=ee,R=Ke,$=Oe,c=Te,S=Be,U=ze;return _(),u(V,null,[r(M,{onClick:p,icon:me(K(qe))},{default:g(()=>e[15]||(e[15]=[B("搜索设置")])),_:1,__:[15]},8,["icon"]),r(U,{open:q.value,"onUpdate:open":e[14]||(e[14]=o=>q.value=o),class:"custom-class","root-class-name":"root-class-name",title:"搜索设置",width:"472",placement:"right",onAfterOpenChange:v},{default:g(()=>[t("div",Qe,[e[24]||(e[24]=t("div",{class:"prompt-form-label"},"模型设置",-1)),t("div",Ye,[e[16]||(e[16]=t("div",{class:"prompt-form-item-label"},[t("span",{style:{color:"red"}},"* "),t("span",null,"模型选择")],-1)),r(Ne,{modelType:"LLM",modeName:s.use_model,"onUpdate:modeName":e[0]||(e[0]=o=>s.use_model=o),modeId:s.model_config_id,"onUpdate:modeId":e[1]||(e[1]=o=>s.model_config_id=o),style:{width:"100%"},onLoaded:j,onChange:w},null,8,["modeName","modeId"])]),t("div",Xe,[e[19]||(e[19]=t("div",{class:"prompt-form-item-label"},[t("span",{style:{color:"red"}},"* "),t("span",null,"提示词")],-1)),r(E,{value:s.prompt_type,"onUpdate:value":e[2]||(e[2]=o=>s.prompt_type=o),onChange:k},{default:g(()=>[r(I,{value:"0"},{default:g(()=>e[17]||(e[17]=[B("默认提示词")])),_:1,__:[17]}),r(I,{value:"1"},{default:g(()=>e[18]||(e[18]=[B("自定义提示词")])),_:1,__:[18]})]),_:1},8,["value"]),t("div",Ze,[s.prompt_type=="0"?(_(),u("div",We,"将提交的内容进行智能总结,不要随意发挥")):(_(),D(F,{key:1,onBlur:k,maxLength:500,style:{height:"80px"},value:s.prompt,"onUpdate:value":e[3]||(e[3]=o=>s.prompt=o),placeholder:"请输入自定义提示词"},null,8,["value"]))])]),t("div",et,[t("div",tt,[e[21]||(e[21]=t("span",null,"温度",-1)),r(l,null,{title:g(()=>e[20]||(e[20]=[B("温度越低，回答越严谨。温度越高，回答越发散。")])),default:g(()=>[r(K(J),{class:"question-icon"})]),_:1})]),t("div",st,[t("div",at,[t("div",ot,[r(i,{onBlur:k,class:"custom-slider",value:s.temperature,"onUpdate:value":e[4]||(e[4]=o=>s.temperature=o),min:0,max:2,step:.1},null,8,["value"])]),t("div",lt,[r(x,{onBlur:k,value:s.temperature,"onUpdate:value":e[5]||(e[5]=o=>s.temperature=o),min:0,max:2,step:.1},null,8,["value"])])])])]),t("div",nt,[t("div",it,[e[23]||(e[23]=t("span",null,"最大token",-1)),r(l,null,{title:g(()=>e[22]||(e[22]=[t("div",null,"问题+答案的最大token数，如果出现回答被截断，可调高此值",-1)])),default:g(()=>[r(K(J),{class:"question-icon"})]),_:1})]),t("div",rt,[t("div",dt,[t("div",ct,[r(i,{onBlur:k,class:"custom-slider",value:s.max_token,"onUpdate:value":e[6]||(e[6]=o=>s.max_token=o),min:0,max:100*1024},null,8,["value"])]),t("div",_t,[r(x,{onBlur:k,value:s.max_token,"onUpdate:value":e[7]||(e[7]=o=>s.max_token=o),min:0,max:100*1024},null,8,["value"])])])])])]),t("div",mt,[t("div",ut,[e[32]||(e[32]=t("div",{class:"prompt-form-label"},"召回设置",-1)),t("div",pt,[e[25]||(e[25]=t("div",{class:"form-item-label"},[t("span",null,"检索模式")],-1)),t("div",vt,[t("div",ft,[(_(!0),u(V,null,H(A.value,o=>(_(),u("div",{class:le(["retrieval-mode-item",{active:s.search_type==o.value}]),key:o.value,onClick:z=>y(o.value)},[s.search_type==o.value?(_(),D(f,{key:0,class:"check-arrow",name:"check-arrow-filled"})):P("",!0),t("div",gt,[r(f,{name:o.iconName,class:"title-icon"},null,8,["name"]),t("span",yt,O(o.title),1),o.isRecommendation?(_(),D(f,{key:0,class:"recommendation-icon",name:"recommendation"})):P("",!0)]),t("div",kt,O(o.desc),1)],10,ht))),128))])])]),t("div",bt,[t("div",xt,[e[27]||(e[27]=t("span",null,"Top K ",-1)),r(l,null,{title:g(()=>e[26]||(e[26]=[B("最多从知识库中召回分段数，最低为1，最高为10。召回分段数越多，消耗的token也会越多。")])),default:g(()=>[r(K(J),{class:"question-icon"})]),_:1})]),t("div",$t,[t("div",St,[t("div",Lt,[r(i,{onBlur:k,class:"custom-slider",value:s.top_k,"onUpdate:value":e[8]||(e[8]=o=>s.top_k=o),min:1,max:10},null,8,["value"])]),t("div",wt,[r(x,{onBlur:k,value:s.top_k,"onUpdate:value":e[9]||(e[9]=o=>s.top_k=o),min:1,max:10},null,8,["value"])])])])]),s.search_type!=3&&s.search_type!=4?(_(),u("div",At,[t("div",Ct,[e[29]||(e[29]=t("span",null,"相似度阈值 ",-1)),r(l,null,{title:g(()=>e[28]||(e[28]=[B("召回时，只会召回相似度大于阈值的文本分段。取值范围：0~1，阈值越大回答的越准确，建议不超过0.9")])),default:g(()=>[r(K(J),{class:"question-icon"})]),_:1})]),t("div",Mt,[t("div",Rt,[t("div",Nt,[r(i,{onBlur:k,class:"custom-slider",value:s.similarity,"onUpdate:value":e[10]||(e[10]=o=>s.similarity=o),min:0,max:1,step:.01},null,8,["value"])]),t("div",qt,[r(x,{onBlur:k,value:s.similarity,"onUpdate:value":e[11]||(e[11]=o=>s.similarity=o),min:0,max:1,step:.01},null,8,["value"])])])])])):P("",!0),t("div",It,[t("div",Ut,[e[31]||(e[31]=t("span",null,"Rerank模型 ",-1)),r(l,null,{title:g(()=>e[30]||(e[30]=[B("召回时，只会召回相似度大于阈值的文本分段。取值范围：0~1，阈值越大回答的越准确，建议不超过0.9")])),default:g(()=>[r(K(J),{class:"question-icon"})]),_:1}),r(R,{onChange:k,style:{float:"right"},checkedValue:1,unCheckedValue:0,checked:s.rerank_status,"onUpdate:checked":e[12]||(e[12]=o=>s.rerank_status=o),"checked-children":"开","un-checked-children":"关"},null,8,["checked"])]),s.rerank_status==1?(_(),u("div",Bt,[r(S,{value:s.rerank_use_model,"onUpdate:value":e[13]||(e[13]=o=>s.rerank_use_model=o),placeholder:"请选择Rerank模型",onChange:d,style:{width:"100%"}},{default:g(()=>[(_(!0),u(V,null,H(N.value,o=>(_(),D(c,{key:o.id},{label:g(()=>[t("span",null,[t("img",{class:"model-icon",src:o.icon,alt:""},null,8,Ot)])]),default:g(()=>[(_(!0),u(V,null,H(o.children,z=>(_(),D($,{value:z,rerank_model_config_id:o.id,key:z},{default:g(()=>[t("span",null,O(z),1)]),_:2},1032,["value","rerank_model_config_id"]))),128))]),_:2},1024))),128))]),_:1},8,["value"])])):P("",!0)])])])]),_:1},8,["open"])],64)}}}),zt=Q(Tt,[["__scopeId","data-v-7fb4822d"]]),Et={class:"no-data"},Ft={class:"no-data-text"},jt={__name:"list-empty",props:{text:{type:String,default:"暂无数据"},size:{type:[Number,String],default:100}},setup(b){const n=b;return(A,q)=>{const s=ee;return _(),u("div",Et,[r(s,{name:"empty-document",style:pe({"font-size":`${n.size}px`,color:"white"})},null,8,["style"]),t("div",Ft,[ve(A.$slots,"default",{},()=>[B(O(n.text),1)],!0)])])}}},Kt=Q(jt,[["__scopeId","data-v-22b194ba"]]),Vt={class:"search-box-warpper"},Dt={class:"search-box-content"},Pt={class:"search-set-box"},Ht={key:0,class:"search-content"},Jt={class:"search-input-box"},Gt={key:1,class:"search-content search-main"},Qt={class:"search-input-box"},Yt={key:1,class:"search-content-box"},Xt={class:"search-tip-box"},Zt={key:0,class:"tip"},Wt={key:1,class:"tip complete"},es={key:0,class:"container"},ts={key:1,class:"intelligent-answer"},ss=["innerHTML"],as={key:1},os={class:"section-box"},ls={key:0,class:"section-label"},ns={class:"section-item-nav"},is={class:"section-item-nav-left"},rs=["onClick"],ds={key:0},cs={class:"section-item-nav-right"},_s=["innerHTML"],ms={__name:"search-box",props:{librarySearchData:{type:Object,default:null},messageObj:{type:Object,default:null},library_ids:{type:Array,default:()=>[]},isError:{type:Boolean,default:!1}},emits:["search","defaultParmas"],setup(b,{expose:n,emit:A}){const q=A,s=b,N=new Ve({html:!0,linkify:!0,typographer:!0}),C=L(""),w=L(""),T=L(!1),j=L(!1),y=L({});Z(()=>s.messageObj.content,()=>{C.value=N.render(s.messageObj.content)}),Z(()=>s.messageObj.error,l=>{l&&X(l)});const d=async()=>{if(!s.library_ids.length)return X("请在左侧的知识库选择项内至少选择一个知识库");if(!w.value)return X("请输入消息内容");q("search",w.value),T.value=!0};function m(l){return l.match(/^-?\d+(?:\.\d{0,2})?/)[0]}const k=(l,i)=>{if(!l||!i.trim())return l;const x=i.replace(/[.*+?^${}()|[\]\\]/g,"\\$&"),f=new RegExp(`(${x})`,"gi");return l.replace(f,'<span class="highlight">$1</span>')},v=l=>{if(!l.file_name){window.open(`#/library/details/categary-manage?id=${l.library_id}`);return}window.open(`#/library/preview?id=${l.file_id}`)},p=L(s.librarySearchData),a=G({rerank_status:"",rerank_use_model:"",prompt:"",model_config_id:"",use_model:"",temperature:.5,max_token:2e3,similarity:.4,search_type:1}),e=L({}),M=l=>{p.value=l;let i={model_config_id:l.model_config_id||a.model_config_id,use_model:l.use_model||a.use_model,temperature:l.temperature||a.temperature,max_token:l.max_token||a.max_token,size:200,similarity:l.similarity||a.similarity,search_type:l.search_type||a.search_type,question:w.value,id:s.library_ids.join(","),recall_type:1};l.rerank_status&&(i.rerank_status=l.rerank_status),l.rerank_use_model&&(i.rerank_use_model=l.rerank_use_model),l.prompt&&(i.prompt=l.prompt),l.rerank_status==1&&(i.rerank_model_config_id=l.rerank_model_config_id),j.value=!0,e.value=Object.assign(i),q("defaultParmas",e.value),be(i).then(x=>{y.value=x.data}).catch(()=>{}).finally(()=>{j.value=!1})},I=L([]);function E(l,i,x){const f=new Set(l.map(R=>R.model_define));return i.filter(R=>{let $=R[x];f.has($)&&l.filter(c=>{if(c.model_define==$)return c.children=xe(c.children,R.children),!1})}),l}const F=async()=>{await ie({model_type:"LLM"}).then(l=>{let i=l.data||[],x=[];I.value=i.map(f=>{x=[];for(let R=0;R<f.model_info.llm_model_list.length;R++){const $=f.model_info.llm_model_list[R];x.push({name:$,deployment_name:f.model_config.deployment_name,model_config_id:f.model_config.id,model_define:f.model_info.model_define})}return{model_config_id:f.model_config.id,name:f.model_info.model_name,model_define:f.model_info.model_define,icon:f.model_info.model_icon_url,children:x,deployment_name:f.model_config.deployment_name}}),I.value=E(ke(I.value,"model_define"),I.value,"model_define")})};return W(async()=>{var l,i,x,f,R;if(await F(),!((l=p.value)!=null&&l.model_config_id)||!((i=p.value)!=null&&i.use_model)){if(I.value.length>0){let $=I.value[0];if($){let c=$.children[0];a.use_model=c.name,a.model_config_id=c.model_config_id}}}else a.use_model=((x=p.value)==null?void 0:x.use_model)+"$$",a.model_config_id=((f=p.value)==null?void 0:f.model_config_id)+"$$",a.use_model=a.use_model.split("$$")[0],a.model_config_id=(R=p.value)==null?void 0:R.model_config_id.split("$$")[0]}),n({handleRecallTest:M}),(l,i)=>{const x=ee,f=De,R=re;return _(),u("div",Vt,[t("div",Dt,[t("div",Pt,[r(zt,{librarySearchData:p.value},null,8,["librarySearchData"])]),T.value?(_(),u("div",Gt,[t("div",Qt,[r(f,{class:"search-input",onPressEnter:d,value:w.value,"onUpdate:value":i[1]||(i[1]=$=>w.value=$),"allow-clear":"",placeholder:"输入关键词搜索"},{suffix:g(()=>[t("div",{class:"search-icon-box",onClick:d},[r(x,{class:"search-icon",name:"search-right"})])]),_:1},8,["value"])]),!C.value&&b.messageObj.finish&&!y.value.length?(_(),D(Kt,{key:0,style:{"margin-top":"100px"},size:"250"},{default:g(()=>i[4]||(i[4]=[t("div",null,[t("p",{style:{color:"#262626","font-size":"16px","font-weight":"600","line-height":"24px"}},"暂无任何内容")],-1)])),_:1,__:[4]})):(_(),u("div",Yt,[t("div",Xt,[r(x,{class:"nav-icon",name:"search-tip"}),b.messageObj.finish?(_(),u("span",Wt,"智能回答生成完毕")):(_(),u("span",Zt,"智能回答生成中..."))]),!b.messageObj.content&&!b.messageObj.finish&&!b.isError?(_(),u("div",es,i[5]||(i[5]=[fe('<div class="rect-container rect1" data-v-f065da1f><div class="rect" data-v-f065da1f></div></div><div class="rect-container rect2" data-v-f065da1f><div class="rect" data-v-f065da1f></div></div><div class="rect-container rect3" data-v-f065da1f><div class="rect" data-v-f065da1f></div></div>',3)]))):(_(),u("div",ts,[C.value?(_(),u("div",{key:0,innerHTML:C.value},null,8,ss)):(_(),u("div",as,"暂无任何内容"))])),t("div",os,[i[7]||(i[7]=t("div",{class:"tips"},[t("div",{class:"tips-text"},"以上内容由大模型生成"),t("div",{class:"tips-line"})],-1)),y.value.length?(_(),u("div",ls,[i[6]||(i[6]=B("相关分段 ")),t("div",null,"("+O(y.value.length)+")",1)])):P("",!0),(_(!0),u(V,null,H(y.value,$=>(_(),u("div",{class:"section-item",key:$.id},[t("div",ns,[t("div",is,[r(x,{class:"section-item-icon",name:"document"}),t("div",{class:"section-item-label",onClick:c=>v($)},[B(O($.file_name),1),$.file_name?P("",!0):(_(),u("span",ds,O($.library_name)+"-精选",1))],8,rs)]),t("div",cs,"相似度："+O(m($.similarity)),1)]),r(R,{overlayClassName:"search-content-tip",placement:"top"},{title:g(()=>[B(O($.content),1)]),default:g(()=>[t("div",{class:"section-item-content",innerHTML:k($.content,w.value)},null,8,_s)]),_:2},1024)]))),128))])]))])):(_(),u("div",Ht,[i[2]||(i[2]=t("div",{class:"search-label"},"知识搜索",-1)),i[3]||(i[3]=t("div",{class:"search-tip"},"快速搜索所选择的知识库中内容",-1)),t("div",Jt,[r(f,{class:"search-input",onPressEnter:d,value:w.value,"onUpdate:value":i[0]||(i[0]=$=>w.value=$),"allow-clear":"",placeholder:"输入关键词搜索"},{suffix:g(()=>[t("div",{class:"search-icon-box",onClick:d},[r(x,{class:"search-icon",name:"search-right"})])]),_:1},8,["value"])])]))])])}}},us=Q(ms,[["__scopeId","data-v-f065da1f"]]),ps={class:"cu-tabs"},vs=["onClick"],fs={__name:"contain-tabs",props:{value:{type:[Number,String],required:!0},tabs:{type:Array,required:!0,default:()=>[]}},emits:["update:value","change"],setup(b,{emit:n}){const A=n,q=b,s=N=>{A("update:value",N),A("change",N)};return(N,C)=>(_(),u("div",ps,[(_(!0),u(V,null,H(b.tabs,w=>(_(),u("div",{class:le(["tab-item",{active:q.value===w.value}]),onClick:T=>s(w.value),key:w.value},O(w.title),11,vs))),128))]))}},hs=Q(fs,[["__scopeId","data-v-9397dcbb"]]),gs=ne("searchStore",{state:()=>({indeterminate:!1,checkAll:!1,checkedList:[],activeKey:"all"}),getters:{getIndeterminate(){return this.indeterminate},getCheckAll(){return this.checkAll},getCheckedList(){return this.checkedList},getActiveKey(){return this.activeKey}},actions:{setIndeterminate(b){this.indeterminate=b},setCheckAll(b){this.checkAll=b},setCheckedList(b){this.checkedList=b},setActiveKey(b){this.activeKey=b}},persist:{enabled:!0,strategies:[{key:"searchStore",storage:localStorage,paths:["indeterminate","checkAll","checkedList","activeKey"]}]}}),ys=ne("search-lirary",()=>{const b=Pe(),n=G({reasoning_content:"",show_reasoning:!1,content:"",quote_file:[],id:"",finish:!1,debug:[],error:[],recall_time:0,request_time:0,loading:!1});let A=null;const q=L(0),s=L(""),N=G({context_pair:"",create_time:"",id:"",max_token:"",model_config_id:"",rerank_model_config_id:"",rerank_status:"",rerank_use_model:"",search_type:"",similarity:"",size:"",temperature:"",update_time:"",use_model:"",user_id:""}),C=(y,d)=>{if(y=="reasoning_content"){let m=n.reasoning_content||"";n.reasoning_content=m+d,n.show_reasoning=!0}if(y=="sending"){let m=n.content||"";n.content=m+d}if(y=="quote_file"&&(n.quote_file=d.length>0?d:[]),y=="ai_message"){if(d.menu_json&&d.msg_type==2){let m=JSON.parse(d.menu_json);n.question=m.question}n.id=d.id,n.content=d.content,d.quote_file&&typeof d.quote_file=="string"&&(n.quote_file=JSON.parse(d.quote_file))}y=="finish"&&(n.finish=!0),y=="debug"&&(n.debug=d.length>0?d:[]),y=="error"&&(n.error=d.length>0?d:[]),y=="recall_time"&&(n.recall_time=d||0),y=="request_time"&&(n.request_time=d||0),b.emit("updateAiMessage",n)},w=()=>{n.loading=!1};return{searchFormState:N,dialogue_id:q,openid:s,messageObj:n,getLibrarySearchFn:async()=>{A&&(A.abort(),A=null);const y=await we();try{let d=y.data;Object.assign(N,{...d})}catch(d){Promise.reject(d)}return y},searchMessage:(y,d,m)=>{$e(32),n.content="",n.finish=!1;let k={model_config_id:m.model_config_id,use_model:m.use_model,temperature:m.temperature,max_token:m.max_token,size:m.size,similarity:m.similarity,search_type:m.search_type,question:y,id:d.join(","),recall_type:1};m.rerank_status&&(k.rerank_status=m.rerank_status),m.rerank_use_model&&(k.rerank_use_model=m.rerank_use_model),m.prompt&&(k.prompt=m.prompt),m.rerank_status==1&&(k.rerank_model_config_id=m.rerank_model_config_id),A=Se(k),A.onMessage=v=>{if(v.event!=="sending"&&Le(v),v.event=="dialogue_id"&&(q.value=v.data),v.event=="reasoning_content"&&C("reasoning_content",v.data),v.event=="sending"&&C("sending",v.data),v.event=="ai_message"){let p=JSON.parse(v.data);C("ai_message",p)}if(v.event=="quote_file"){let p=JSON.parse(v.data);C("quote_file",p)}if(v.event=="finish"&&C("finish",v.data),v.event=="debug"){let p=JSON.parse(v.data);C("debug",p)}if(v.event=="error"){let p=v.data;C("error",p)}if(v.event=="recall_time"){let p=v.data;C("recall_time",p)}},A.onClose=()=>{w(),A=null}}}}),ks={class:"chat-monitor-page"},bs={class:"page-left"},xs={class:"toolbar-box"},$s={class:"library-checkbox-box"},Ss={class:"app-list-box"},Ls={class:"list-box",ref:"scrollContainer"},ws={class:"list-item"},As={class:"list-item-box"},Cs={class:"library-icon"},Ms=["onClick"],Rs={class:"page-body"},Ns={__name:"index",setup(b){const n=gs();let{getIndeterminate:A,getCheckAll:q,getCheckedList:s,getActiveKey:N}=ae(n);const C=ys(),{getLibrarySearchFn:w,searchMessage:T}=C,{messageObj:j}=ae(C),y=L(null),d=L(null),m=L("all"),k=L([{title:"全部",value:"all"},{title:"普通",value:"0"},{title:"问答",value:"2"}]),v=L({}),p=L([]),a=G({indeterminate:!1,checkAll:!1,checkedList:[]}),e=c=>{v.value=c},M=L(!1),I=async c=>{var U;M.value=!1;let S=await w();if(d.value=S.data,d.value.id||(d.value=Object.assign(v.value)),!d.value.model_config_id||!d.value.use_model)return M.value=!0,X("请在搜索设置中配置好相应配置后再使用");(U=y.value)==null||U.handleRecallTest(d.value),T(c,a.checkedList,d.value)},E=c=>{Object.assign(a,{checkedList:c.target.checked?p.value.map(S=>S.id):[],indeterminate:!!a.checkedList.length&&a.checkedList.length<p.value.length}),n.setCheckedList(a.checkedList),n.setIndeterminate(a.indeterminate)},F=c=>{n.setCheckedList(c)},l=c=>{window.open(`#/library/details/knowledge-document?id=${c}`)};Z(()=>a.checkedList,c=>{a.indeterminate=!!c.length&&c.length<p.value.length,a.checkAll=c.length>=p.value.length,n.setIndeterminate(a.indeterminate),n.setCheckAll(a.checkAll)});const i=()=>{p.value.forEach(c=>{c.type==0,c.type==2}),k.value=[{title:"全部",value:"all"},{title:"普通",value:"0"},{title:"问答",value:"2"}]},x=(c,S)=>{if(S.length===0)return!1;const U=new Set(c);return S.every(o=>U.has(o))},f=(c,S)=>!S.some(U=>c.includes(U)),R=async()=>{let c=m.value==="all"?"":m.value;await Ae({type:c}).then(S=>{var z;let U=S.data||[];U.forEach(h=>{h.file_size_str=Ce(h.file_size),h.avatar||(h.avatar=h.type==0?Me:Re)}),p.value=U;const o=p.value.map(h=>h.id);if((z=s.value)!=null&&z.length&&(o!=null&&o.length)){const h=s.value,Y=o,de=x(h,Y),ce=f(h,Y),te=h.length>=Y.length&&de,se={checkAll:te,indeterminate:!te&&!ce};n.$patch(se),Object.assign(a,se)}else{const h={checkAll:!1,indeterminate:!1};n.$patch(h),Object.assign(a,h)}a.checkedList=s.value,a.indeterminate=A.value,!q.value&&s.value.length==0&&!A.value&&N.value=="all"&&(n.setCheckAll(!0),a.checkedList=o,n.setCheckedList(o)),m.value==="all"&&i()})},$=c=>{n.setActiveKey(c),R()};return W(async()=>{N.value&&(m.value=N.value),await R();let c=await w();d.value=c.data}),he(()=>{}),(c,S)=>{const U=He,o=Ge,z=Je;return _(),u("div",ks,[t("div",bs,[t("div",xs,[r(hs,{tabs:k.value,value:m.value,"onUpdate:value":S[0]||(S[0]=h=>m.value=h),onChange:$},null,8,["tabs","value"])]),t("div",$s,[t("div",Ss,[r(U,{checked:a.checkAll,"onUpdate:checked":S[1]||(S[1]=h=>a.checkAll=h),indeterminate:a.indeterminate,onChange:E},{default:g(()=>S[3]||(S[3]=[B(" 全选/取消 ")])),_:1,__:[3]},8,["checked","indeterminate"])]),r(z,{value:a.checkedList,"onUpdate:value":S[2]||(S[2]=h=>a.checkedList=h),onChange:F},{default:g(()=>[t("div",Ls,[(_(!0),u(V,null,H(p.value,h=>(_(),u("div",{class:"list-item-wraapper",key:h.id},[t("div",ws,[r(U,{value:h.id},null,8,["value"]),t("div",As,[t("div",Cs,[r(o,{preview:!1,width:32,src:h.avatar},null,8,["src"])]),t("div",{class:"library-name",onClick:Y=>l(h.id)},O(h.library_name),9,Ms)])])]))),128))],512)]),_:1},8,["value"])])]),t("div",Rs,[r(us,{ref_key:"searchBoxRef",ref:y,onDefaultParmas:e,onSearch:I,isError:M.value,messageObj:K(j),librarySearchData:d.value,library_ids:a.checkedList},null,8,["isError","messageObj","librarySearchData","library_ids"])])])}}},wa=Q(Ns,[["__scopeId","data-v-1cd61309"]]);export{wa as default};
