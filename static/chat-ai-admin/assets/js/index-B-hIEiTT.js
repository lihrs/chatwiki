import{d as y,z as Q,q as F,w as G,N as p,O as i,X as e,j as g,U as D,F as O,a1 as P,u as U,S as ee,Z as M,_ as k,ag as te,a5 as Se,H as Y,a6 as R,x as J,a3 as Te,a8 as ke,D as xe,a2 as De}from"./vue-chunks-BRsu9_To.js";import{n as $,k as $e,b as V,bx as K,B as Ce,M as we}from"../../index-CvfGQnmW.js";import{a as Ee,_ as Le}from"./RadioButton-Bh1r7hrP.js";import{R as He}from"./dayjs-CXIbBuBE.js";import{_ as se}from"./empty-DkpCLaix.js";import{_ as Ie}from"./useIM-CqczBMrf.js";import{S as Me}from"./index-MLftqXg-.js";import{u as Be}from"./robot-CVYMQ0Uf.js";import{u as Re}from"./chat-Cze4y0gU.js";import{c as Oe}from"./index-DC3UON7S.js";import{S as Ue,a as Ae}from"./index-Bic_ld4j.js";import{R as qe}from"./index-CYSNJ1BK.js";import{_ as ze}from"./Search-BVbdzfe3.js";import{_ as Pe}from"./index-BjEoDhm5.js";import"./axios-Dq7h7Pqt.js";import"./qs-BrxkIg-9.js";import"./crypto-js-ClNpte_9.js";import"./dayjs-B6IotFah.js";import"./FormItemContext-CFzzmp00.js";import"./Checkbox-CD3yZxoG.js";import"./index-CN9-mtWv.js";import"./index-Be8_2it1.js";import"./colors-Cy2bPHOW.js";import"./CheckOutlined-N7bppPAu.js";import"./Trigger-C5a0DMKm.js";import"./ResizeObserver.es-B1PUzC5B.js";import"./shallowequal-C0xnIuy8.js";import"./index-B0doyz59.js";import"./move-CunrTozH.js";import"./slide-vrDadJH3.js";import"./index-DaOSj_2K.js";import"./index-BX8Pzc6J.js";import"./index-8-RdvZT5.js";import"./useEventBus-BwH2zX88.js";import"./DownOutlined-DKJ0lkJp.js";import"./SearchOutlined-B9P7O4A9.js";import"./Input-DT-w6V-X.js";import"./inputProps-DJXIqADS.js";import"./isPlainObject-C_BoBcyP.js";const Ve={class:"zm-date"},Ne={class:"date-btn"},je={class:"date-content"},Ye={__name:"date",props:{datekey:{type:String,default:"1"}},emits:["dateChange"],setup(w,{emit:E}){const x=w,u=y(1),d=E;let b=Q([{label:"今日",value:!0,key:2,start_time:$().startOf("day"),end_time:$().endOf("day")},{label:"昨日",value:!1,key:3,start_time:$().subtract(1,"day").startOf("day"),end_time:$().startOf("day").subtract(1,"millisecond")},{label:"近7日",value:!1,key:4,start_time:$().subtract(6,"day").startOf("day"),end_time:$().endOf("day").subtract(1,"millisecond")}]);const v=y(null),l=y(null),s=y([]),h=f=>f>=$().subtract(0,"day"),L=()=>{let f=u.value,t=null;b.forEach(_=>{_.key==f&&(t=_)}),t&&(s.value=[t.start_time,t.end_time],v.value=t.start_time.unix(),l.value=t.end_time.unix()),I()},H=f=>{const t=$(f[0]).startOf("day");if($(f[1]).endOf("day").diff(t,"days")>29)s.value[0]=f[0].startOf("day"),s.value[1]=t.add(29,"days").endOf("day"),v.value=s.value[0].unix(),l.value=s.value[1].unix(),$e.error("最多只能选择30天");else{const S=$(f[0]).startOf("day").unix(),a=$(f[1]).endOf("day").unix();s.value=f,v.value=S,l.value=a}u.value=1,I()},I=()=>{d("dateChange",{start_time:v.value,end_time:l.value})};return F(()=>{u.value=parseInt(x.datekey),L()}),G(()=>x.datekey,(f,t)=>{u.value=parseInt(x.datekey.split("-")[0]),L()}),(f,t)=>{const _=Ee,S=Le,a=He;return i(),p("div",Ve,[e("div",Ne,[g(S,{value:u.value,"onUpdate:value":t[0]||(t[0]=c=>u.value=c),onChange:L},{default:D(()=>[(i(!0),p(O,null,P(U(b),c=>(i(),ee(_,{class:"date-btn-button",value:c.key,key:c.key},{default:D(()=>[M(k(c.label),1)]),_:2},1032,["value"]))),128))]),_:1},8,["value"])]),e("div",je,[g(a,{value:s.value,"onUpdate:value":t[1]||(t[1]=c=>s.value=c),onChange:H,format:"YYYY-MM-DD",disabledDate:h,allowClear:!1},null,8,["value"])])])}}},Fe={key:0,class:"empty-box"},Ge=["onClick"],We={class:"user-item-left"},Xe=["src"],Ze={class:"user-item-right"},Je={class:"user-name-box"},Ke={class:"user-name"},Qe={class:"user-timer"},et={class:"user-info"},tt={class:"user-source-box"},st={class:"user-source-content"},ot={__name:"user",props:{userList:{type:Array,default:[]}},emits:["userClick","userScroll","userScrollStart","userScrollEnd"],setup(w,{emit:E}){const x=y(null),u=w,d=E,b=y([]),v=y({}),l=t=>{v.value=t,d("userClick",t)},s={scrollTop:0,scrollHeight:0,clientHeight:0,scrollStartDiff:60,scrollEndDiff:60,scrollDirection:""};let h=null;function L(t){h&&(clearTimeout(h),h=null),h=setTimeout(()=>{s.scrollTop-t.target.scrollTop>0&&(s.scrollDirection="up"),s.scrollTop-t.target.scrollTop<0&&(s.scrollDirection="down"),s.scrollTop=t.target.scrollTop,s.scrollHeight=t.target.scrollHeight,s.clientHeight=t.target.clientHeight,d("userScroll",{...s}),Math.abs(s.scrollTop)<=s.scrollStartDiff+100&&s.scrollDirection==="up"&&H(),Math.abs(s.scrollHeight-s.scrollTop-s.clientHeight)<=s.scrollEndDiff&&s.scrollDirection==="down"&&I()},50)}function H(){u.userList.length!=0&&d("userScrollStart",{msg:u.userList[0]})}function I(){u.userList.length!=0&&d("userScrollEnd",{msg:u.userList[u.userList.length-1]})}G(()=>u.userList,t=>{b.value=t,b.value.length>0&&b.value.length<=20&&(l(b.value[0]),v.value=b.value[0])},{immediate:!0});const f=t=>{let _;switch(t){case"yun_h5":_="WebAPP";break;case"yun_pc":_="嵌入网站";break}return _};return F(()=>{b.value=u.userList}),(t,_)=>{const S=te("ftime");return i(),p("div",{class:"user-content",ref_key:"scrollUserBoxRef",ref:x,onScroll:L},[b.value.length===0?(i(),p("div",Fe,_[0]||(_[0]=[e("img",{src:se,alt:""},null,-1),e("div",{class:"title"},"暂无结果，请重试",-1)]))):(i(!0),p(O,{key:1},P(b.value,a=>(i(),p("div",{class:Se(["user-item",{active:a.openid==v.value.openid}]),onClick:c=>l(a),key:a.session_id},[e("div",We,[e("img",{class:"user-img",src:a.avatar,alt:""},null,8,Xe)]),e("div",Ze,[e("div",Je,[e("div",Ke,k(a.name),1),Y((i(),p("div",Qe,[M(k(a.last_chat_time),1)])),[[S,"MM-DD HH:mm"]])]),e("div",et,k(a.last_chat_message),1),e("div",tt,[_[1]||(_[1]=e("div",{class:"user-source-title"},"来自：",-1)),e("div",st,k(f(a.app_type)),1)])])],10,Ge))),128))],544)}}},lt=V(ot,[["__scopeId","data-v-e837d5ae"]]),at={class:"message-box"},nt={class:"message-top-box"},rt={class:"message-top-title"},it={key:0,class:"message-top-source"},ct={class:"message-list"},ut={key:0,class:"empty-box"},dt=["id"],_t={class:"itme-right"},pt={class:"message-info"},mt={class:"item-body"},vt={class:"message-content"},ft={class:"user-avatar-box"},gt=["src"],yt=["id"],ht={class:"itme-left"},bt=["src"],St={class:"itme-right"},Tt={class:"message-info"},kt={class:"item-body"},xt={key:0,class:"message-content"},Dt=["innerHTML"],$t={key:2,class:"message-content"},Ct=["src"],wt={key:2,class:"loading-box"},Et={__name:"message-list",props:{messages:{type:Array,default:()=>[]},robotInfo:{type:Object,default:()=>{}},isEmpty:{type:Boolean,default:()=>!1},sessionSource:{type:String,default:()=>null},channelItem:{type:Array,default:()=>[]}},emits:["scroll","scrollStart","scrollEnd"],setup(w,{expose:E,emit:x}){const u=x,d=w,b=y(!1),v=y(null),l={scrollTop:0,scrollHeight:0,clientHeight:0,scrollStartDiff:60,scrollEndDiff:60,scrollDirection:""};let s=null,h=!1;const L=a=>{let c;for(let o=0;o<d.channelItem.length;o++){const T=d.channelItem[o];T.app_type===a&&(c=T.app_name)}return c};function H(a){h||(s&&(clearTimeout(s),s=null),s=setTimeout(()=>{l.scrollTop-a.target.scrollTop>0&&(l.scrollDirection="up"),l.scrollTop-a.target.scrollTop<0&&(l.scrollDirection="down"),l.scrollTop=a.target.scrollTop,l.scrollHeight=a.target.scrollHeight,l.clientHeight=a.target.clientHeight,u("scroll",{...l}),Math.abs(l.scrollTop)<=l.scrollStartDiff&&l.scrollDirection==="up"&&I(),Math.abs(l.scrollHeight-l.scrollTop-l.clientHeight)<=l.scrollEndDiff&&l.scrollDirection==="down"&&f()},100))}function I(){d.messages.length!=0&&u("scrollStart",{msg:d.messages[0]})}function f(){d.messages.length!=0&&u("scrollEnd",{msg:d.messages[d.messages.length-1]})}const t=()=>{v.value&&J(()=>{h=!0,v.value.scrollTop=v.value.scrollHeight+1,setTimeout(()=>{l.scrollTop=v.value.scrollTop,h=!1},50)})};function _(a,c){J(()=>{h=!0,c||(c="top");let o=v.value,T=document.querySelector("#msg-"+a);T&&(c=="top"?o.scrollTop=T.offsetTop:o.scrollTop=T.offsetTop-o.clientHeight+T.clientHeight),setTimeout(()=>{l.scrollTop=v.value.scrollTop,h=!1},50)})}function S(){l.scrollTop=0,l.scrollDirection=""}return E({scrollToBottom:t,scrollToMessage:_,resetScroll:S}),(a,c)=>{const o=Me,T=te("viewer");return i(),p("div",at,[e("div",nt,[e("div",rt,k(d.robotInfo.robot_name),1),w.sessionSource?(i(),p("div",it,"("+k(L(w.sessionSource))+")",1)):R("",!0)]),e("div",{class:"message-list-wrapper",ref_key:"scrollBoxRef",ref:v,onScroll:H},[e("div",ct,[d.isEmpty||!d.messages?(i(),p("div",ut,c[0]||(c[0]=[e("img",{src:se,alt:""},null,-1),e("div",{class:"title"},"暂无结果，请重试",-1)]))):(i(!0),p(O,{key:1},P(d.messages,m=>(i(),p(O,{key:m.uid},[m.is_customer==1?(i(),p("div",{key:0,class:"message-item user-message",id:"msg-"+m.uid},[e("div",_t,[e("div",pt,[e("span",null,k(U(K)(m.create_time)),1),e("span",null,k(m.name),1)]),e("div",mt,[e("div",vt,k(m.content),1)])]),e("div",ft,[e("img",{class:"user-avatar",src:m.avatar},null,8,gt)])],8,dt)):(i(),p("div",{key:1,class:"message-item robot-message",id:"msg-"+m.uid},[e("div",ht,[g(o,{size:"small",spinning:m.loading},{default:D(()=>[e("img",{class:"robot-avatar",src:m.robot_avatar},null,8,bt)]),_:2},1032,["spinning"])]),e("div",St,[e("div",Tt,[e("span",null,k(U(K)(m.create_time)),1),e("span",null,k(m.name),1)]),e("div",kt,[m.msg_type==1?Y((i(),p("div",xt,[g(Ie,{content:m.content},null,8,["content"])])),[[T]]):R("",!0),m.msg_type==2?(i(),p("div",{key:1,class:"message-content",innerHTML:m.menu_json.content},null,8,Dt)):R("",!0),m.msg_type==3?(i(),p("div",$t,[Y(e("img",{class:"msg-img",src:m.content,alt:""},null,8,Ct),[[T]])])):R("",!0)])])],8,yt))],64))),128)),b.value?(i(),p("div",wt,[g(o)])):R("",!0)])],544)])}}},Lt=V(Et,[["__scopeId","data-v-9b2c823e"]]),Ht={class:"team-members-pages"},It={class:"set-model"},Mt={class:"set-model-body"},Bt={class:"set-date"},Rt={class:"set-date-body"},Ot={class:"set-name"},Ut={class:"set-reset"},At={class:"list-box"},qt={class:"user-box"},zt={class:"records-box"},Pt={__name:"session-record",setup(w){const E=y(!1),x=De(),u=Te(),d=u.query,b=Be(),{robotInfo:v}=b,l=Re(),{messageList:s}=ke(l);let h=!0;const{createMsg:L,onGetChatMessage:H,getRecordList:I,getChannelList:f}=l,t=y(null),_=y([]),S=y([]),a=y(""),c=y("1"),o=Q({robot_id:d.id,app_type:"all",app_id:"",start_time:"",end_time:"",name:"",page:1,size:20}),T=y(!1),m=n=>{o.start_time=n.start_time,o.end_time=n.end_time,j()},oe=()=>{o.app_type="all",o.name="",o.page=1,c.value="1-"+Math.random()},A=y(!1),N=y(!1),le=async()=>{let n=W();N.value=!0,await Oe(n),A.value=!0,N.value=!1},ae=()=>{x.push({path:"/robot/config/export-record",query:d})},j=()=>{o.page=1,X()},ne=n=>{o.app_type=n,j()},re=()=>{},ie=n=>{a.value=n.app_type,ve(n)},ce=async()=>{},ue=()=>{T.value&&(o.page++,X())},de=async()=>{h=!1;let n=s.value[0].uid;await H()&&pe(n)},_e=()=>{t.value&&h&&t.value.scrollToBottom()},pe=n=>{t.value&&t.value.scrollToMessage(n)},me=()=>{t.value&&t.value.resetScroll()};let q=null;const ve=async n=>{h=!0;let B={robot_key:(u.query||{}).robot_key,avatar:n.avatar,name:n.name,nickname:n.name,is_background:1,openid:n.openid};me(),await L(B),q&&(clearTimeout(q),q=null),q=setTimeout(async()=>{await H()&&_e()},100)},fe=async()=>{const n=await f();_.value=[{app_type:"all",app_name:"全部渠道"},...n.data]},W=()=>{let n={robot_id:o.robot_id,start_time:o.start_time,end_time:o.end_time,name:o.name,page:o.page,size:o.size};return o.app_type!=="all"&&(n.app_type=o.app_type),n},X=async()=>{let n=W(),r=await I(n),B=r.data.list||[];o.page==1&&(S.value=[]),S.value=[...S.value,...B],E.value=S.value.length==0,T.value=r.data.has_more};return G(()=>s.value,()=>{}),F(async()=>{fe()}),xe(()=>{}),(n,r)=>{const B=Ae,Z=Ue,ge=ze,z=Ce,ye=Pe,he=qe,be=we;return i(),p("div",Ht,[g(ye,{justify:"flex-start",class:"screen-box"},{default:D(()=>[e("div",It,[r[4]||(r[4]=e("div",{class:"label set-model-label"},"渠道：",-1)),e("div",Mt,[g(Z,{value:o.app_type,"onUpdate:value":r[0]||(r[0]=C=>o.app_type=C),placeholder:"全部渠道",onChange:ne,style:{width:"200px"}},{default:D(()=>[(i(!0),p(O,null,P(_.value,C=>(i(),ee(B,{key:C.app_type,value:C.app_type},{default:D(()=>[e("span",null,k(C.app_name),1)]),_:2},1032,["value"]))),128))]),_:1},8,["value"])])]),e("div",Bt,[r[5]||(r[5]=e("div",{class:"label set-date-label"},[e("span",null,"日期：")],-1)),e("div",Rt,[g(Ye,{onDateChange:m,datekey:c.value},null,8,["datekey"])])]),e("div",Ot,[g(ge,{value:o.name,"onUpdate:value":r[1]||(r[1]=C=>o.name=C),placeholder:"请输入用户名称搜索",style:{width:"200px"},onSearch:j},null,8,["value"])]),e("div",Ut,[g(z,{onClick:oe},{default:D(()=>r[6]||(r[6]=[M("重置")])),_:1,__:[6]}),g(z,{onClick:le,loading:N.value},{default:D(()=>r[7]||(r[7]=[M("导出")])),_:1,__:[7]},8,["loading"])])]),_:1}),e("div",At,[e("div",qt,[g(lt,{userList:S.value,onUserScrollStart:ce,onUserScrollEnd:ue,onUserClick:ie},null,8,["userList"])]),e("div",zt,[g(Lt,{ref_key:"messageListRef",ref:t,isEmpty:E.value,messages:U(s),robotInfo:U(v),channelItem:_.value,sessionSource:a.value,onScrollStart:de,onScrollEnd:re},null,8,["isEmpty","messages","robotInfo","channelItem","sessionSource"])])]),g(be,{open:A.value,"onUpdate:open":r[3]||(r[3]=C=>A.value=C),title:null,footer:null,width:640},{default:D(()=>[g(he,{status:"success",title:"导出任务创建成功","sub-title":"系统会在后台导出。导出数据量越大，耗时越久。您可以稍后点击导出记录查看并下载导出的文件。"},{extra:D(()=>[g(z,{style:{"margin-right":"16px"},onClick:r[2]||(r[2]=C=>A.value=!1)},{default:D(()=>r[8]||(r[8]=[M("知道了")])),_:1,__:[8]}),g(z,{onClick:ae,type:"primary"},{default:D(()=>r[9]||(r[9]=[M("去下载")])),_:1,__:[9]})]),_:1})]),_:1},8,["open"])])}}},Vt=V(Pt,[["__scopeId","data-v-c117c73a"]]),Nt={class:"user-model-page"},jt={class:"list-wrapper"},Yt={__name:"index",setup(w){return(E,x)=>(i(),p("div",Nt,[x[0]||(x[0]=e("div",{class:"page-title"},"会话记录",-1)),e("div",jt,[g(Vt)])]))}},Hs=V(Yt,[["__scopeId","data-v-bcc51f14"]]);export{Hs as default};
