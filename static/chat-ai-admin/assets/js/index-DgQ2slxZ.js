import{f as ve,e as S,B as Q,w as Z,x as te,M as d,N as p,k as i,S as y,Y as B,l as he,u as D,W as e,Q as P,F as V,$ as J,a6 as ie,a7 as H,Z as O,aa as fe,a1 as re,a2 as ce,X as ge,U as ye,aq as ke,K as de,a9 as ne,D as be}from"./vue-chunks-BjMuQ6KD.js";import{k as le,dF as xe,B as $e,d as se,b as Y,bA as X,de as Se,aA as Le,aB as we,aD as Ae,dG as Ce,dH as Me,a0 as Re,bH as Ie,bF as Ne,bG as qe}from"../../index-CfxQ5aRu.js";import{c as _e}from"./index-d7geF-HW.js";import{M as Ue}from"./model-select-c6lAzYs5.js";import"./index-DPiF7UEG.js";import{R as Be,_ as Oe}from"./RadioButton-_iRIgmgW.js";import{S as Te}from"./SettingOutlined-fTdHQK4u.js";import{Q as G}from"./QuestionCircleOutlined-Deh272L3.js";import{_ as Fe}from"./TextArea-CN_AI7y7.js";import{_ as me}from"./index-D1MiuDW_.js";import{_ as ze}from"./index-DVvZbe-E.js";import{_ as Ee}from"./index-QsoU6-T8.js";import{_ as Ke}from"./index-BCGkuM1J.js";import{S as je,h as De,_ as Ve}from"./index-BuS_bfCI.js";import{_ as Pe}from"./index-Ch1-3QsQ.js";import{M as He}from"./index-BMSQkwth.js";import"./index-DcUUFn-g.js";import{I as Je}from"./Input-C5WaaE9Z.js";import{u as Ge}from"./useEventBus-DCQvkgIt.js";import{C as Qe,_ as Ye}from"./index-CxLzlFzW.js";import{_ as We}from"./index-CkNFqYv3.js";import"./axios-Cm0UX6qg.js";import"./qs-DjdPq-RR.js";import"./crypto-js-BemCeW_6.js";import"./dayjs-DK4rpucX.js";import"./index-D8Y0HnA5.js";import"./FormItemContext-DQ1b1ToO.js";import"./Checkbox-DQe8ZxR1.js";import"./index-D6-G2N0k.js";import"./index-CXSrVsd0.js";import"./ResizeObserver.es-B1PUzC5B.js";import"./inputProps-D7qr__m5.js";import"./Trigger-Dy6Dc2CN.js";import"./colors-C9XVGyX_.js";import"./UpOutlined-CY9GinGn.js";import"./DownOutlined-Gk0UBxct.js";import"./slide-BYYxYcj9.js";import"./CheckOutlined-BLsT0eZM.js";import"./SearchOutlined-B7dGgS_P.js";import"./move-BjmscfYf.js";import"./Search-DozVr2pE.js";import"./isPlainObject-xAKL-sfk.js";import"./Password-BCnVcrNJ.js";import"./index-BSl1-tWC.js";import"./css-DbBMd65r.js";import"./LeftOutlined-qzkQKHcF.js";import"./RightOutlined-BHf0iqSq.js";const T=_=>(re("data-v-5a852543"),_=_(),ce(),_),Xe={class:"prompt-form"},Ze=T(()=>e("div",{class:"prompt-form-label"},"模型设置",-1)),et={class:"prompt-form-item"},tt=T(()=>e("div",{class:"prompt-form-item-label"},[e("span",{style:{color:"red"}},"* "),e("span",null,"模型选择")],-1)),st={class:"prompt-form-item"},at=T(()=>e("div",{class:"prompt-form-item-label"},[e("span",{style:{color:"red"}},"* "),e("span",null,"提示词")],-1)),ot={class:"prompt-form-item-content"},nt={key:0,class:"prompt-form-item-tip"},lt={class:"prompt-form-item"},it={class:"prompt-form-item-label"},rt=T(()=>e("span",null,"温度",-1)),ct={class:"form-item-body"},dt={class:"number-box"},_t={class:"number-slider-box"},mt={class:"number-input-box"},ut={class:"prompt-form-item"},pt={class:"prompt-form-item-label"},vt=T(()=>e("span",null,"最大token",-1)),ht=T(()=>e("div",null,"问题+答案的最大token数，如果出现回答被截断，可调高此值",-1)),ft={class:"form-item-body"},gt={class:"number-box"},yt={class:"number-slider-box"},kt={class:"number-input-box"},bt={class:"recall-settings-box"},xt={class:"form-box prompt-form"},$t=T(()=>e("div",{class:"prompt-form-label"},"召回设置",-1)),St={class:"form-item is-required"},Lt=T(()=>e("div",{class:"form-item-label"},[e("span",null,"检索模式")],-1)),wt={class:"form-item-body"},At={class:"retrieval-mode-items"},Ct=["onClick"],Mt={class:"retrieval-mode-title"},Rt={class:"title-text"},It={class:"retrieval-mode-desc"},Nt={class:"form-item"},qt={class:"form-item-label"},Ut=T(()=>e("span",null,"Top K ",-1)),Bt={class:"form-item-body"},Ot={class:"number-box"},Tt={class:"number-slider-box"},Ft={class:"number-input-box"},zt={key:0,class:"form-item"},Et={class:"form-item-label"},Kt=T(()=>e("span",null,"相似度阈值 ",-1)),jt={class:"form-item-body"},Dt={class:"number-box"},Vt={class:"number-slider-box"},Pt={class:"number-input-box"},Ht={class:"form-item"},Jt={class:"form-item-label"},Gt=T(()=>e("span",null,"Rerank模型 ",-1)),Qt={key:0,class:"form-item-body"},Yt=["src"],Wt=ve({__name:"search-drawer",props:{librarySearchData:{type:Object,default:null},defaultLibrarySearchData:{type:Object,default:null}},setup(_){const l=_,w=S([{iconName:"mix-icon",title:"混合检索",value:1,isRecommendation:!0,desc:"同时执行三种检索模式，使用RRF算法进行排序，从三种查询结果中选择更匹配用户问题的结果。混合检索兼顾语义相似性与逻辑关联性，通过互补优势提升检索的准确性和生成结果的可信度"},{iconName:"vector-icon",title:"向量检索",value:2,desc:"将用户提问转成向量之后与知识库分段匹配相似度，返回相似度高的结果。向量检索擅长语义相似性匹配和大规模非结构化数据处理，但缺乏可解释性和精准关系验证"},{iconName:"graph-icon",title:"知识图谱检索",value:4,desc:"通过关系推理，检索出与用户问题相关联的知识。知识图谱检索擅长精准的实体关系推理和逻辑验证，但对非结构化文本和语义模糊查询支持较弱"},{iconName:"search-check-icon",title:"全文检索",value:3,desc:"通过分词匹配文档中的词汇，返回包含这些词汇的文本片段"}]),N=S(!1),t=Q({use_model:"",model_config_id:"",prompt_type:"0",prompt:"",temperature:.5,max_token:2e3,context_pair:0,search_type:1,top_k:5,size:0,similarity:.4,rerank_status:0,rerank_use_model:void 0,rerank_model_config_id:void 0}),I=S([]),A=()=>{_e({model_type:"RERANK"}).then(a=>{let s=a.data||[];I.value=s.map(M=>({id:M.model_config.id,name:M.model_info.model_name,icon:M.model_info.model_icon_url,children:M.model_info.rerank_model_list}))})},L=(a,s)=>{t.use_model=s.modelName,t.model_config_id=s.modelId,b()},F=S([]),j=a=>{var s,M,q,E,K;if(F.value=a,!((s=l.librarySearchData)!=null&&s.model_config_id)||!((M=l.librarySearchData)!=null&&M.use_model)){if(F.value.length>0){let n=F.value[0];if(n){let u=n.children[0];t.use_model=u.name,t.model_config_id=u.model_config_id}}}else t.use_model=((q=l.librarySearchData)==null?void 0:q.use_model)+"$$",t.model_config_id=((E=l.librarySearchData)==null?void 0:E.model_config_id)+"$$",t.use_model=t.use_model.split("$$")[0],t.model_config_id=(K=l.librarySearchData)==null?void 0:K.model_config_id.split("$$")[0]},k=a=>{t.search_type=a,b()},r=(a,s)=>{t.rerank_model_config_id=s.rerank_model_config_id,b()},m=a=>{let s={...a};s.max_token=parseFloat(s.max_token),s.temperature=parseFloat(s.temperature),s.context_pair=parseFloat(s.context_pair),s.search_type=parseFloat(s.search_type),s.rerank_status=parseFloat(s.rerank_status),s.similarity=parseFloat(s.similarity),s.top_k=parseFloat(s.size),s.rerank_use_model===""&&(s.rerank_use_model=void 0),Object.keys(s).forEach(M=>{t[M]=s[M]})},b=()=>{let a={...t};if(!a.prompt&&t.prompt_type=="1")return le.error("请输入自定义提示词");(t.search_type==3||t.search_type==4)&&delete a.similarity,t.prompt_type=="0"&&delete a.prompt,a.size=a.top_k,xe(a).then(s=>{le.success("保存成功")})},h=a=>{},v=()=>{N.value=!0};return Z(()=>l.librarySearchData,a=>{var s;(s=l.librarySearchData)!=null&&s.id&&m({...fe(l.librarySearchData)})}),te(()=>{A()}),(a,s)=>{const M=$e,q=Be,E=Oe,K=Fe,n=me,u=ze,x=Ee,f=se,R=Ke,$=je,c=De,C=Ve,U=Pe;return d(),p(V,null,[i(M,{onClick:v,icon:he(D(Te))},{default:y(()=>[B("搜索设置")]),_:1},8,["icon"]),i(U,{open:N.value,"onUpdate:open":s[14]||(s[14]=o=>N.value=o),class:"custom-class","root-class-name":"root-class-name",title:"搜索设置",width:"472",placement:"right",onAfterOpenChange:h},{default:y(()=>[e("div",Xe,[Ze,e("div",et,[tt,i(Ue,{modelType:"LLM",modeName:t.use_model,"onUpdate:modeName":s[0]||(s[0]=o=>t.use_model=o),modeId:t.model_config_id,"onUpdate:modeId":s[1]||(s[1]=o=>t.model_config_id=o),style:{width:"100%"},onLoaded:j,onChange:L},null,8,["modeName","modeId"])]),e("div",st,[at,i(E,{value:t.prompt_type,"onUpdate:value":s[2]||(s[2]=o=>t.prompt_type=o),onChange:b},{default:y(()=>[i(q,{value:"0"},{default:y(()=>[B("默认提示词")]),_:1}),i(q,{value:"1"},{default:y(()=>[B("自定义提示词")]),_:1})]),_:1},8,["value"]),e("div",ot,[t.prompt_type=="0"?(d(),p("div",nt,"将提交的内容进行智能总结,不要随意发挥")):(d(),P(K,{key:1,onBlur:b,maxLength:500,style:{height:"80px"},value:t.prompt,"onUpdate:value":s[3]||(s[3]=o=>t.prompt=o),placeholder:"请输入自定义提示词"},null,8,["value"]))])]),e("div",lt,[e("div",it,[rt,i(n,null,{title:y(()=>[B("温度越低，回答越严谨。温度越高，回答越发散。")]),default:y(()=>[i(D(G),{class:"question-icon"})]),_:1})]),e("div",ct,[e("div",dt,[e("div",_t,[i(u,{onBlur:b,class:"custom-slider",value:t.temperature,"onUpdate:value":s[4]||(s[4]=o=>t.temperature=o),min:0,max:2,step:.1},null,8,["value"])]),e("div",mt,[i(x,{onBlur:b,value:t.temperature,"onUpdate:value":s[5]||(s[5]=o=>t.temperature=o),min:0,max:2,step:.1},null,8,["value"])])])])]),e("div",ut,[e("div",pt,[vt,i(n,null,{title:y(()=>[ht]),default:y(()=>[i(D(G),{class:"question-icon"})]),_:1})]),e("div",ft,[e("div",gt,[e("div",yt,[i(u,{onBlur:b,class:"custom-slider",value:t.max_token,"onUpdate:value":s[6]||(s[6]=o=>t.max_token=o),min:0,max:100*1024},null,8,["value"])]),e("div",kt,[i(x,{onBlur:b,value:t.max_token,"onUpdate:value":s[7]||(s[7]=o=>t.max_token=o),min:0,max:100*1024},null,8,["value"])])])])])]),e("div",bt,[e("div",xt,[$t,e("div",St,[Lt,e("div",wt,[e("div",At,[(d(!0),p(V,null,J(w.value,o=>(d(),p("div",{class:ie(["retrieval-mode-item",{active:t.search_type==o.value}]),key:o.value,onClick:z=>k(o.value)},[t.search_type==o.value?(d(),P(f,{key:0,class:"check-arrow",name:"check-arrow-filled"})):H("",!0),e("div",Mt,[i(f,{name:o.iconName,class:"title-icon"},null,8,["name"]),e("span",Rt,O(o.title),1),o.isRecommendation?(d(),P(f,{key:0,class:"recommendation-icon",name:"recommendation"})):H("",!0)]),e("div",It,O(o.desc),1)],10,Ct))),128))])])]),e("div",Nt,[e("div",qt,[Ut,i(n,null,{title:y(()=>[B("最多从知识库中召回分段数，最低为1，最高为10。召回分段数越多，消耗的token也会越多。")]),default:y(()=>[i(D(G),{class:"question-icon"})]),_:1})]),e("div",Bt,[e("div",Ot,[e("div",Tt,[i(u,{onBlur:b,class:"custom-slider",value:t.top_k,"onUpdate:value":s[8]||(s[8]=o=>t.top_k=o),min:1,max:10},null,8,["value"])]),e("div",Ft,[i(x,{onBlur:b,value:t.top_k,"onUpdate:value":s[9]||(s[9]=o=>t.top_k=o),min:1,max:10},null,8,["value"])])])])]),t.search_type!=3&&t.search_type!=4?(d(),p("div",zt,[e("div",Et,[Kt,i(n,null,{title:y(()=>[B("召回时，只会召回相似度大于阈值的文本分段。取值范围：0~1，阈值越大回答的越准确，建议不超过0.9")]),default:y(()=>[i(D(G),{class:"question-icon"})]),_:1})]),e("div",jt,[e("div",Dt,[e("div",Vt,[i(u,{onBlur:b,class:"custom-slider",value:t.similarity,"onUpdate:value":s[10]||(s[10]=o=>t.similarity=o),min:0,max:1,step:.01},null,8,["value"])]),e("div",Pt,[i(x,{onBlur:b,value:t.similarity,"onUpdate:value":s[11]||(s[11]=o=>t.similarity=o),min:0,max:1,step:.01},null,8,["value"])])])])])):H("",!0),e("div",Ht,[e("div",Jt,[Gt,i(n,null,{title:y(()=>[B("召回时，只会召回相似度大于阈值的文本分段。取值范围：0~1，阈值越大回答的越准确，建议不超过0.9")]),default:y(()=>[i(D(G),{class:"question-icon"})]),_:1}),i(R,{onChange:b,style:{float:"right"},checkedValue:1,unCheckedValue:0,checked:t.rerank_status,"onUpdate:checked":s[12]||(s[12]=o=>t.rerank_status=o),"checked-children":"开","un-checked-children":"关"},null,8,["checked"])]),t.rerank_status==1?(d(),p("div",Qt,[i(C,{value:t.rerank_use_model,"onUpdate:value":s[13]||(s[13]=o=>t.rerank_use_model=o),placeholder:"请选择Rerank模型",onChange:r,style:{width:"100%"}},{default:y(()=>[(d(!0),p(V,null,J(I.value,o=>(d(),P(c,{key:o.id},{label:y(()=>[e("span",null,[e("img",{class:"model-icon",src:o.icon,alt:""},null,8,Yt)])]),default:y(()=>[(d(!0),p(V,null,J(o.children,z=>(d(),P($,{value:z,rerank_model_config_id:o.id,key:z},{default:y(()=>[e("span",null,O(z),1)]),_:2},1032,["value","rerank_model_config_id"]))),128))]),_:2},1024))),128))]),_:1},8,["value"])])):H("",!0)])])])]),_:1},8,["open"])],64)}}}),Xt=Y(Wt,[["__scopeId","data-v-5a852543"]]),Zt={class:"no-data"},es={class:"no-data-text"},ts={__name:"list-empty",props:{text:{type:String,default:"暂无数据"},size:{type:[Number,String],default:100}},setup(_){const l=_;return(w,N)=>{const t=se;return d(),p("div",Zt,[i(t,{name:"empty-document",style:ge({"font-size":`${l.size}px`,color:"white"})},null,8,["style"]),e("div",es,[ye(w.$slots,"default",{},()=>[B(O(l.text),1)],!0)])])}}},ss=Y(ts,[["__scopeId","data-v-f4fa2763"]]),ee=_=>(re("data-v-ff35c87f"),_=_(),ce(),_),as={class:"search-box-warpper"},os={class:"search-box-content"},ns={class:"search-set-box"},ls={key:0,class:"search-content"},is=ee(()=>e("div",{class:"search-label"},"知识搜索",-1)),rs=ee(()=>e("div",{class:"search-tip"},"快速搜索所选择的知识库中内容",-1)),cs={class:"search-input-box"},ds={key:1,class:"search-content search-main"},_s={class:"search-input-box"},ms=ee(()=>e("div",null,[e("p",{style:{color:"#262626","font-size":"16px","font-weight":"600","line-height":"24px"}},"暂无任何内容")],-1)),us={key:1,class:"search-content-box"},ps={class:"search-tip-box"},vs={key:0,class:"tip"},hs={key:1,class:"tip complete"},fs={key:0,class:"container"},gs=ke('<div class="rect-container rect1" data-v-ff35c87f><div class="rect" data-v-ff35c87f></div></div><div class="rect-container rect2" data-v-ff35c87f><div class="rect" data-v-ff35c87f></div></div><div class="rect-container rect3" data-v-ff35c87f><div class="rect" data-v-ff35c87f></div></div>',3),ys=[gs],ks={key:1,class:"intelligent-answer"},bs=["innerHTML"],xs={key:1},$s={class:"section-box"},Ss=ee(()=>e("div",{class:"tips"},[e("div",{class:"tips-text"},"以上内容由大模型生成"),e("div",{class:"tips-line"})],-1)),Ls={key:0,class:"section-label"},ws={class:"section-item-nav"},As={class:"section-item-nav-left"},Cs=["onClick"],Ms={key:0},Rs={class:"section-item-nav-right"},Is=["innerHTML"],Ns={__name:"search-box",props:{librarySearchData:{type:Object,default:null},messageObj:{type:Object,default:null},library_ids:{type:Array,default:()=>[]},isError:{type:Boolean,default:!1}},emits:["search","defaultParmas"],setup(_,{expose:l,emit:w}){const N=w,t=_,I=new He({html:!0,linkify:!0,typographer:!0}),A=S(""),L=S(""),F=S(!1),j=S(!1),k=S({});Z(()=>t.messageObj.content,()=>{A.value=I.render(t.messageObj.content)}),Z(()=>t.messageObj.error,n=>{n&&X(n)});const r=async()=>{if(!t.library_ids.length)return X("请在左侧的知识库选择项内至少选择一个知识库");if(!L.value)return X("请输入消息内容");N("search",L.value),F.value=!0};function m(n){return n.match(/^-?\d+(?:\.\d{0,2})?/)[0]}const b=(n,u)=>{if(!n||!u.trim())return n;const x=u.replace(/[.*+?^${}()|[\]\\]/g,"\\$&"),f=new RegExp(`(${x})`,"gi");return n.replace(f,'<span class="highlight">$1</span>')},h=n=>{if(!n.file_name){window.open(`#/library/details/categary-manage?id=${n.library_id}`);return}window.open(`#/library/preview?id=${n.file_id}`)},v=S(t.librarySearchData),a=Q({rerank_status:"",rerank_use_model:"",prompt:"",model_config_id:"",use_model:"",temperature:.5,max_token:2e3,similarity:.4,search_type:1}),s=S({}),M=n=>{v.value=n;let u={model_config_id:n.model_config_id||a.model_config_id,use_model:n.use_model||a.use_model,temperature:n.temperature||a.temperature,max_token:n.max_token||a.max_token,size:200,similarity:n.similarity||a.similarity,search_type:n.search_type||a.search_type,question:L.value,id:t.library_ids.join(","),recall_type:1};n.rerank_status&&(u.rerank_status=n.rerank_status),n.rerank_use_model&&(u.rerank_use_model=n.rerank_use_model),n.prompt&&(u.prompt=n.prompt),n.rerank_status==1&&(u.rerank_model_config_id=n.rerank_model_config_id),j.value=!0,s.value=Object.assign(u),N("defaultParmas",s.value),Se(u).then(x=>{k.value=x.data}).catch(()=>{}).finally(()=>{j.value=!1})},q=S([]);function E(n,u,x){const f=new Set(n.map(R=>R.model_define));return u.filter(R=>{let $=R[x];f.has($)&&n.filter(c=>{if(c.model_define==$)return c.children=we(c.children,R.children),!1})}),n}const K=async()=>{await _e({model_type:"LLM"}).then(n=>{let u=n.data||[],x=[];q.value=u.map(f=>{x=[];for(let R=0;R<f.model_info.llm_model_list.length;R++){const $=f.model_info.llm_model_list[R];x.push({name:$,deployment_name:f.model_config.deployment_name,model_config_id:f.model_config.id,model_define:f.model_info.model_define})}return{model_config_id:f.model_config.id,name:f.model_info.model_name,model_define:f.model_info.model_define,icon:f.model_info.model_icon_url,children:x,deployment_name:f.model_config.deployment_name}}),q.value=E(Le(q.value,"model_define"),q.value,"model_define")})};return te(async()=>{var n,u,x,f,R;if(await K(),!((n=v.value)!=null&&n.model_config_id)||!((u=v.value)!=null&&u.use_model)){if(q.value.length>0){let $=q.value[0];if($){let c=$.children[0];a.use_model=c.name,a.model_config_id=c.model_config_id}}}else a.use_model=((x=v.value)==null?void 0:x.use_model)+"$$",a.model_config_id=((f=v.value)==null?void 0:f.model_config_id)+"$$",a.use_model=a.use_model.split("$$")[0],a.model_config_id=(R=v.value)==null?void 0:R.model_config_id.split("$$")[0]}),l({handleRecallTest:M}),(n,u)=>{const x=se,f=Je,R=me;return d(),p("div",as,[e("div",os,[e("div",ns,[i(Xt,{librarySearchData:v.value},null,8,["librarySearchData"])]),F.value?(d(),p("div",ds,[e("div",_s,[i(f,{class:"search-input",onPressEnter:r,value:L.value,"onUpdate:value":u[1]||(u[1]=$=>L.value=$),"allow-clear":"",placeholder:"输入关键词搜索"},{suffix:y(()=>[e("div",{class:"search-icon-box",onClick:r},[i(x,{class:"search-icon",name:"search-right"})])]),_:1},8,["value"])]),!A.value&&_.messageObj.finish&&!k.value.length?(d(),P(ss,{key:0,style:{"margin-top":"100px"},size:"250"},{default:y(()=>[ms]),_:1})):(d(),p("div",us,[e("div",ps,[i(x,{class:"nav-icon",name:"search-tip"}),_.messageObj.finish?(d(),p("span",hs,"智能回答生成完毕")):(d(),p("span",vs,"智能回答生成中..."))]),!_.messageObj.content&&!_.messageObj.finish&&!_.isError?(d(),p("div",fs,ys)):(d(),p("div",ks,[A.value?(d(),p("div",{key:0,innerHTML:A.value},null,8,bs)):(d(),p("div",xs,"暂无任何内容"))])),e("div",$s,[Ss,k.value.length?(d(),p("div",Ls,[B("相关分段 "),e("div",null,"("+O(k.value.length)+")",1)])):H("",!0),(d(!0),p(V,null,J(k.value,$=>(d(),p("div",{class:"section-item",key:$.id},[e("div",ws,[e("div",As,[i(x,{class:"section-item-icon",name:"document"}),e("div",{class:"section-item-label",onClick:c=>h($)},[B(O($.file_name),1),$.file_name?H("",!0):(d(),p("span",Ms,O($.library_name)+"-精选",1))],8,Cs)]),e("div",Rs,"相似度："+O(m($.similarity)),1)]),i(R,{overlayClassName:"search-content-tip",placement:"top"},{title:y(()=>[B(O($.content),1)]),default:y(()=>[e("div",{class:"section-item-content",innerHTML:b($.content,L.value)},null,8,Is)]),_:2},1024)]))),128))])]))])):(d(),p("div",ls,[is,rs,e("div",cs,[i(f,{class:"search-input",onPressEnter:r,value:L.value,"onUpdate:value":u[0]||(u[0]=$=>L.value=$),"allow-clear":"",placeholder:"输入关键词搜索"},{suffix:y(()=>[e("div",{class:"search-icon-box",onClick:r},[i(x,{class:"search-icon",name:"search-right"})])]),_:1},8,["value"])])]))])])}}},qs=Y(Ns,[["__scopeId","data-v-ff35c87f"]]),Us={class:"cu-tabs"},Bs=["onClick"],Os={__name:"contain-tabs",props:{value:{type:[Number,String],required:!0},tabs:{type:Array,required:!0,default:()=>[]}},emits:["update:value","change"],setup(_,{emit:l}){const w=l,N=_,t=I=>{w("update:value",I),w("change",I)};return(I,A)=>(d(),p("div",Us,[(d(!0),p(V,null,J(_.tabs,L=>(d(),p("div",{class:ie(["tab-item",{active:N.value===L.value}]),onClick:F=>t(L.value),key:L.value},O(L.title),11,Bs))),128))]))}},Ts=Y(Os,[["__scopeId","data-v-a6e0ef08"]]),Fs=de("searchStore",{state:()=>({indeterminate:!1,checkAll:!1,checkedList:[],activeKey:"all"}),getters:{getIndeterminate(){return this.indeterminate},getCheckAll(){return this.checkAll},getCheckedList(){return this.checkedList},getActiveKey(){return this.activeKey}},actions:{setIndeterminate(_){this.indeterminate=_},setCheckAll(_){this.checkAll=_},setCheckedList(_){this.checkedList=_},setActiveKey(_){this.activeKey=_}},persist:{enabled:!0,strategies:[{key:"searchStore",storage:localStorage,paths:["indeterminate","checkAll","checkedList","activeKey"]}]}}),zs=de("search-lirary",()=>{const _=Ge(),l=Q({reasoning_content:"",show_reasoning:!1,content:"",quote_file:[],id:"",finish:!1,debug:[],error:[],recall_time:0,request_time:0,loading:!1});let w=null;const N=S(0),t=S(""),I=Q({context_pair:"",create_time:"",id:"",max_token:"",model_config_id:"",rerank_model_config_id:"",rerank_status:"",rerank_use_model:"",search_type:"",similarity:"",size:"",temperature:"",update_time:"",use_model:"",user_id:""}),A=(k,r)=>{if(k=="reasoning_content"){let m=l.reasoning_content||"";l.reasoning_content=m+r,l.show_reasoning=!0}if(k=="sending"){let m=l.content||"";l.content=m+r}if(k=="quote_file"&&(l.quote_file=r.length>0?r:[]),k=="ai_message"){if(r.menu_json&&r.msg_type==2){let m=JSON.parse(r.menu_json);l.question=m.question}l.id=r.id,l.content=r.content,r.quote_file&&typeof r.quote_file=="string"&&(l.quote_file=JSON.parse(r.quote_file))}k=="finish"&&(l.finish=!0),k=="debug"&&(l.debug=r.length>0?r:[]),k=="error"&&(l.error=r.length>0?r:[]),k=="recall_time"&&(l.recall_time=r||0),k=="request_time"&&(l.request_time=r||0),_.emit("updateAiMessage",l)},L=()=>{l.loading=!1};return{searchFormState:I,dialogue_id:N,openid:t,messageObj:l,getLibrarySearchFn:async()=>{w&&(w.abort(),w=null);const k=await Me();try{let r=k.data;Object.assign(I,{...r})}catch(r){Promise.reject(r)}return k},searchMessage:(k,r,m)=>{Ae(32),l.content="",l.finish=!1;let b={model_config_id:m.model_config_id,use_model:m.use_model,temperature:m.temperature,max_token:m.max_token,size:m.size,similarity:m.similarity,search_type:m.search_type,question:k,id:r.join(","),recall_type:1};m.rerank_status&&(b.rerank_status=m.rerank_status),m.rerank_use_model&&(b.rerank_use_model=m.rerank_use_model),m.prompt&&(b.prompt=m.prompt),m.rerank_status==1&&(b.rerank_model_config_id=m.rerank_model_config_id),w=Ce(b),w.onMessage=h=>{if(h.event,h.event=="dialogue_id"&&(N.value=h.data),h.event=="reasoning_content"&&A("reasoning_content",h.data),h.event=="sending"&&A("sending",h.data),h.event=="ai_message"){let v=JSON.parse(h.data);A("ai_message",v)}if(h.event=="quote_file"){let v=JSON.parse(h.data);A("quote_file",v)}if(h.event=="finish"&&A("finish",h.data),h.event=="debug"){let v=JSON.parse(h.data);A("debug",v)}if(h.event=="error"){let v=h.data;A("error",v)}if(h.event=="recall_time"){let v=h.data;A("recall_time",v)}},w.onClose=()=>{L(),w=null}}}}),Es={class:"chat-monitor-page"},Ks={class:"page-left"},js={class:"toolbar-box"},Ds={class:"library-checkbox-box"},Vs={class:"app-list-box"},Ps={class:"list-box",ref:"scrollContainer"},Hs={class:"list-item"},Js={class:"list-item-box"},Gs={class:"library-icon"},Qs=["onClick"],Ys={class:"page-body"},Ws={__name:"index",setup(_){const l=Fs();let{getIndeterminate:w,getCheckAll:N,getCheckedList:t,getActiveKey:I}=ne(l);const A=zs(),{getLibrarySearchFn:L,searchMessage:F}=A,{messageObj:j}=ne(A),k=S(null),r=S(null),m=S("all"),b=S([{title:"全部",value:"all"},{title:"普通",value:"0"},{title:"问答",value:"2"}]),h=S({}),v=S([]),a=Q({indeterminate:!1,checkAll:!1,checkedList:[]}),s=c=>{h.value=c},M=S(!1),q=async c=>{var U;M.value=!1;let C=await L();if(r.value=C.data,r.value.id||(r.value=Object.assign(h.value)),!r.value.model_config_id||!r.value.use_model)return M.value=!0,X("请在搜索设置中配置好相应配置后再使用");(U=k.value)==null||U.handleRecallTest(r.value),F(c,a.checkedList,r.value)},E=c=>{Object.assign(a,{checkedList:c.target.checked?v.value.map(C=>C.id):[],indeterminate:!!a.checkedList.length&&a.checkedList.length<v.value.length}),l.setCheckedList(a.checkedList),l.setIndeterminate(a.indeterminate)},K=c=>{l.setCheckedList(c)},n=c=>{window.open(`#/library/details/knowledge-document?id=${c}`)};Z(()=>a.checkedList,c=>{a.indeterminate=!!c.length&&c.length<v.value.length,a.checkAll=c.length>=v.value.length,l.setIndeterminate(a.indeterminate),l.setCheckAll(a.checkAll)});const u=()=>{v.value.forEach(c=>{c.type==0,c.type==2}),b.value=[{title:"全部",value:"all"},{title:"普通",value:"0"},{title:"问答",value:"2"}]},x=(c,C)=>{if(C.length===0)return!1;const U=new Set(c);return C.every(o=>U.has(o))},f=(c,C)=>!C.some(U=>c.includes(U)),R=async()=>{let c=m.value==="all"?"":m.value;await Re({type:c}).then(C=>{var z;let U=C.data||[];U.forEach(g=>{g.file_size_str=Ie(g.file_size),g.avatar||(g.avatar=g.type==0?Ne:qe)}),v.value=U;const o=v.value.map(g=>g.id);if((z=t.value)!=null&&z.length&&(o!=null&&o.length)){const g=t.value,W=o,ue=x(g,W),pe=f(g,W),ae=g.length>=W.length&&ue,oe={checkAll:ae,indeterminate:!ae&&!pe};l.$patch(oe),Object.assign(a,oe)}else{const g={checkAll:!1,indeterminate:!1};l.$patch(g),Object.assign(a,g)}a.checkedList=t.value,a.indeterminate=w.value,!N.value&&t.value.length==0&&!w.value&&I.value=="all"&&(l.setCheckAll(!0),a.checkedList=o,l.setCheckedList(o)),m.value==="all"&&u()})},$=c=>{l.setActiveKey(c),R()};return te(async()=>{I.value&&(m.value=I.value),await R();let c=await L();r.value=c.data}),be(()=>{}),(c,C)=>{const U=Qe,o=We,z=Ye;return d(),p("div",Es,[e("div",Ks,[e("div",js,[i(Ts,{tabs:b.value,value:m.value,"onUpdate:value":C[0]||(C[0]=g=>m.value=g),onChange:$},null,8,["tabs","value"])]),e("div",Ds,[e("div",Vs,[i(U,{checked:a.checkAll,"onUpdate:checked":C[1]||(C[1]=g=>a.checkAll=g),indeterminate:a.indeterminate,onChange:E},{default:y(()=>[B(" 全选/取消 ")]),_:1},8,["checked","indeterminate"])]),i(z,{value:a.checkedList,"onUpdate:value":C[2]||(C[2]=g=>a.checkedList=g),onChange:K},{default:y(()=>[e("div",Ps,[(d(!0),p(V,null,J(v.value,g=>(d(),p("div",{class:"list-item-wraapper",key:g.id},[e("div",Hs,[i(U,{value:g.id},null,8,["value"]),e("div",Js,[e("div",Gs,[i(o,{preview:!1,width:32,src:g.avatar},null,8,["src"])]),e("div",{class:"library-name",onClick:W=>n(g.id)},O(g.library_name),9,Qs)])])]))),128))],512)]),_:1},8,["value"])])]),e("div",Ys,[i(qs,{ref_key:"searchBoxRef",ref:k,onDefaultParmas:s,onSearch:q,isError:M.value,messageObj:D(j),librarySearchData:r.value,library_ids:a.checkedList},null,8,["isError","messageObj","librarySearchData","library_ids"])])])}}},Ja=Y(Ws,[["__scopeId","data-v-1a7abe4e"]]);export{Ja as default};
