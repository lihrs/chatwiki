import{e as ve,b as fe,d as w,z as X,w as ae,q as ne,N as y,O as u,F as P,S as K,a6 as j,j as l,U as f,Z as I,k as he,u as F,X as t,H as ge,I as ye,a1 as H,a5 as me,_ as N,G as ke,Y as be,V as xe,ao as Se,M as ue,a8 as ce,D as $e}from"./vue-chunks-BRsu9_To.js";import{l as we,B as Le,d as ie,M as Ce,k as le,dI as Ae,b as Z,aC as Me,dh as Re,bB as se,aD as Ie,aF as Ue,dJ as qe,bE as Ne,dK as Oe,a1 as Be,bJ as Te,bG as ze,bH as Ee}from"../../index-CbM0qccj.js";import{h as _e}from"./index-CouxJwbb.js";import{M as Fe}from"./model-select-DqyA85p0.js";import{S as Ve}from"./SettingOutlined-Bx4Xb67l.js";import{Q as J}from"./QuestionCircleOutlined-DAN3cK41.js";import"./index-CZpzcZAF.js";import{_ as De,R as Ke}from"./RadioButton-c_YfeD6h.js";import{S as je,a as Pe,i as Je}from"./index-COrrDFD4.js";import{_ as He}from"./index-DzDAfQV_.js";import{_ as Ge}from"./index-CF1bX7HW.js";import{_ as pe}from"./index-B45goIcH.js";import{_ as Qe}from"./index-CbwlRwZs.js";import{_ as Ye}from"./TextArea-DKZz8aSm.js";import{_ as Xe}from"./index-Bb-sLq2n.js";import{_ as Ze}from"./index-BxSmnBhf.js";import{M as We}from"./index-BMSQkwth.js";import"./index-DO7J6xZI.js";import{I as et}from"./Input-D_KQrLFV.js";import{u as tt}from"./useEventBus-BwH2zX88.js";import{C as st,_ as at}from"./index-CX8r5mKl.js";import{I as ot}from"./index-BoX7NOvX.js";import"./axios-Dq7h7Pqt.js";import"./qs-BrxkIg-9.js";import"./crypto-js-ClNpte_9.js";import"./dayjs-B6IotFah.js";import"./FormItemContext-BeebXrYO.js";import"./Checkbox-DsO9D5Eq.js";import"./Trigger-DVan7LyJ.js";import"./ResizeObserver.es-B1PUzC5B.js";import"./index-HsVdjVrn.js";import"./slide-OTRsfSPM.js";import"./index-BgnEJwOh.js";import"./CheckOutlined-SkhEuqvE.js";import"./DownOutlined-1SYVU9mx.js";import"./SearchOutlined-Cx-fYxwR.js";import"./move-CEOd1o_x.js";import"./colors-NG3gZ969.js";import"./inputProps-BMAUs6L6.js";import"./UpOutlined-zAGcK8OC.js";import"./Search-DZduAnXW.js";import"./isPlainObject-DC4y5mMn.js";import"./Password-DPDqvIJe.js";import"./index-B7tou5PT.js";import"./LeftOutlined-DJrr2Itp.js";import"./RightOutlined-CgINgq5G.js";const lt={class:"prompt-form"},nt={class:"form-item"},it={class:"form-item-label"},rt={class:"prompt-form-item"},dt={class:"prompt-form-item"},ct={class:"prompt-form-item-content"},mt={key:0,class:"prompt-form-item-tip"},ut={class:"prompt-form-item"},_t={class:"prompt-form-item-label"},pt={class:"form-item-body"},vt={class:"number-box"},ft={class:"number-slider-box"},ht={class:"number-input-box"},gt={class:"prompt-form-item"},yt={class:"prompt-form-item-label"},kt={class:"form-item-body"},bt={class:"number-box"},xt={class:"number-slider-box"},St={class:"number-input-box"},$t={class:"recall-settings-box"},wt={class:"form-box prompt-form"},Lt={class:"form-item is-required"},Ct={class:"form-item-body"},At={class:"retrieval-mode-items"},Mt=["onClick"],Rt={class:"retrieval-mode-title"},It={class:"title-text"},Ut={class:"retrieval-mode-desc"},qt={class:"form-item"},Nt={class:"form-item-label"},Ot={class:"form-item-body"},Bt={class:"number-box"},Tt={class:"number-slider-box"},zt={class:"number-input-box"},Et={key:0,class:"form-item"},Ft={class:"form-item-label"},Vt={class:"form-item-body"},Dt={class:"number-box"},Kt={class:"number-slider-box"},jt={class:"number-input-box"},Pt={class:"form-item"},Jt={class:"form-item-label"},Ht={key:0,class:"form-item-body"},Gt=["src"],Qt=ve({__name:"search-drawer",props:{librarySearchData:{type:Object,default:null},defaultLibrarySearchData:{type:Object,default:null}},setup($){let{role_permission:r,role_type:C}=we();const U=fe(()=>C==1||r.includes("SearchSets")),k=$,R=w([{iconName:"mix-icon",title:"混合检索",value:1,isRecommendation:!0,desc:"同时执行三种检索模式，使用RRF算法进行排序，从三种查询结果中选择更匹配用户问题的结果。混合检索兼顾语义相似性与逻辑关联性，通过互补优势提升检索的准确性和生成结果的可信度"},{iconName:"vector-icon",title:"向量检索",value:2,desc:"将用户提问转成向量之后与知识库分段匹配相似度，返回相似度高的结果。向量检索擅长语义相似性匹配和大规模非结构化数据处理，但缺乏可解释性和精准关系验证"},{iconName:"graph-icon",title:"知识图谱检索",value:4,desc:"通过关系推理，检索出与用户问题相关联的知识。知识图谱检索擅长精准的实体关系推理和逻辑验证，但对非结构化文本和语义模糊查询支持较弱"},{iconName:"search-check-icon",title:"全文检索",value:3,desc:"通过分词匹配文档中的词汇，返回包含这些词汇的文本片段"}]),L=w(!1),s=X({use_model:"",model_config_id:"",prompt_type:"0",prompt:"",temperature:.5,max_token:2e3,context_pair:0,search_type:1,top_k:5,size:0,similarity:.4,rerank_status:0,rerank_use_model:void 0,rerank_model_config_id:void 0,summary_switch:0}),z=w([]),V=()=>{_e({model_type:"RERANK"}).then(c=>{let e=c.data||[];z.value=e.map(g=>({id:g.model_config.id,name:g.model_info.model_name,icon:g.model_info.model_icon_url,children:g.model_info.rerank_model_list}))})},x=(c,e)=>{s.use_model=e.modelName,s.model_config_id=e.modelId,a()},n=w([]),_=c=>{var e,g,p,d,S;if(n.value=c,!((e=k.librarySearchData)!=null&&e.model_config_id)||!((g=k.librarySearchData)!=null&&g.use_model)){if(n.value.length>0){let A=n.value[0];if(A){let M=A.children[0];s.use_model=M.name,s.model_config_id=M.model_config_id}}}else s.use_model=((p=k.librarySearchData)==null?void 0:p.use_model)+"$$",s.model_config_id=((d=k.librarySearchData)==null?void 0:d.model_config_id)+"$$",s.use_model=s.use_model.split("$$")[0],s.model_config_id=(S=k.librarySearchData)==null?void 0:S.model_config_id.split("$$")[0]},q=c=>{s.search_type=c,a()},b=(c,e)=>{s.rerank_model_config_id=e.rerank_model_config_id,a()},h=c=>{let e={...c};e.max_token=parseFloat(e.max_token),e.temperature=parseFloat(e.temperature),e.context_pair=parseFloat(e.context_pair),e.search_type=parseFloat(e.search_type),e.rerank_status=parseFloat(e.rerank_status),e.similarity=parseFloat(e.similarity),e.top_k=parseFloat(e.size),e.summary_switch=+e.summary_switch,e.rerank_use_model===""&&(e.rerank_use_model=void 0),Object.keys(e).forEach(g=>{s[g]=e[g]})},a=()=>{let c={...s};if(!c.prompt&&s.prompt_type=="1")return le.error("请输入自定义提示词");(s.search_type==3||s.search_type==4)&&delete c.similarity,s.prompt_type=="0"&&delete c.prompt,c.size=c.top_k,Ae(c).then(e=>{le.success("保存成功")})},B=w(!1),O=w(""),T=()=>{s.prompt_type=="1"?(O.value=s.prompt,B.value=!0):a()},G=()=>{if(O.value)s.prompt=O.value,B.value=!1,a();else return le.error("请输入提示语")},Q=()=>{s.prompt_type="0",B.value=!1},i=c=>{},m=()=>{L.value=!0};return ae(()=>k.librarySearchData,c=>{var e;(e=k.librarySearchData)!=null&&e.id&&h({...ke(k.librarySearchData)})}),ne(()=>{V()}),(c,e)=>{const g=Le,p=pe,d=Qe,S=Ge,A=Ke,M=De,D=Ye,v=Xe,E=Ze,Y=ie,oe=Pe,re=Je,W=je,de=Ce,ee=He;return u(),y(P,null,[U.value?(u(),K(g,{key:0,onClick:m,icon:he(F(Ve))},{default:f(()=>e[18]||(e[18]=[I("搜索设置")])),_:1,__:[18]},8,["icon"])):j("",!0),l(ee,{open:L.value,"onUpdate:open":e[17]||(e[17]=o=>L.value=o),class:"custom-class","root-class-name":"root-class-name",title:"搜索设置",width:"472",placement:"right",onAfterOpenChange:i},{default:f(()=>[t("div",lt,[e[29]||(e[29]=t("div",{class:"prompt-form-label"},"模型设置",-1)),t("div",nt,[t("div",it,[l(S,{align:"center"},{default:f(()=>[e[20]||(e[20]=t("span",null,"AI智能总结",-1)),l(p,null,{title:f(()=>e[19]||(e[19]=[I("开启后，搜索知识库时，由大模型自动总结文档，并给出总结后的结果")])),default:f(()=>[l(F(J),{class:"question-icon"})]),_:1}),l(d,{style:{"margin-left":"24px"},onChange:x,checked:s.summary_switch,"onUpdate:checked":e[0]||(e[0]=o=>s.summary_switch=o),checkedValue:1,unCheckedValue:0,"checked-children":"开","un-checked-children":"关"},null,8,["checked"])]),_:1,__:[20]})])]),ge(t("div",null,[t("div",rt,[e[21]||(e[21]=t("div",{class:"prompt-form-item-label"},[t("span",{style:{color:"red"}},"* "),t("span",null,"模型选择")],-1)),l(Fe,{modelType:"LLM",modeName:s.use_model,"onUpdate:modeName":e[1]||(e[1]=o=>s.use_model=o),modeId:s.model_config_id,"onUpdate:modeId":e[2]||(e[2]=o=>s.model_config_id=o),style:{width:"100%"},onLoaded:_,onChange:x},null,8,["modeName","modeId"])]),t("div",dt,[e[24]||(e[24]=t("div",{class:"prompt-form-item-label"},[t("span",{style:{color:"red"}},"* "),t("span",null,"提示词")],-1)),l(M,{value:s.prompt_type,"onUpdate:value":e[3]||(e[3]=o=>s.prompt_type=o),onChange:T},{default:f(()=>[l(A,{value:"0"},{default:f(()=>e[22]||(e[22]=[I("默认提示词")])),_:1,__:[22]}),l(A,{value:"1"},{default:f(()=>e[23]||(e[23]=[I("自定义提示词")])),_:1,__:[23]})]),_:1},8,["value"]),t("div",ct,[s.prompt_type=="0"?(u(),y("div",mt,"将提交的内容进行智能总结,不要随意发挥")):(u(),K(D,{key:1,onBlur:a,maxLength:500,style:{height:"80px"},value:s.prompt,"onUpdate:value":e[4]||(e[4]=o=>s.prompt=o),placeholder:"请输入自定义提示词"},null,8,["value"]))])]),t("div",ut,[t("div",_t,[e[26]||(e[26]=t("span",null,"温度",-1)),l(p,null,{title:f(()=>e[25]||(e[25]=[I("温度越低，回答越严谨。温度越高，回答越发散。")])),default:f(()=>[l(F(J),{class:"question-icon"})]),_:1})]),t("div",pt,[t("div",vt,[t("div",ft,[l(v,{onBlur:a,class:"custom-slider",value:s.temperature,"onUpdate:value":e[5]||(e[5]=o=>s.temperature=o),min:0,max:2,step:.1},null,8,["value"])]),t("div",ht,[l(E,{onBlur:a,value:s.temperature,"onUpdate:value":e[6]||(e[6]=o=>s.temperature=o),min:0,max:2,step:.1},null,8,["value"])])])])]),t("div",gt,[t("div",yt,[e[28]||(e[28]=t("span",null,"最大token",-1)),l(p,null,{title:f(()=>e[27]||(e[27]=[t("div",null,"问题+答案的最大token数，如果出现回答被截断，可调高此值",-1)])),default:f(()=>[l(F(J),{class:"question-icon"})]),_:1})]),t("div",kt,[t("div",bt,[t("div",xt,[l(v,{onBlur:a,class:"custom-slider",value:s.max_token,"onUpdate:value":e[7]||(e[7]=o=>s.max_token=o),min:0,max:100*1024},null,8,["value"])]),t("div",St,[l(E,{onBlur:a,value:s.max_token,"onUpdate:value":e[8]||(e[8]=o=>s.max_token=o),min:0,max:100*1024},null,8,["value"])])])])])],512),[[ye,s.summary_switch==1]])]),t("div",$t,[t("div",wt,[e[37]||(e[37]=t("div",{class:"prompt-form-label"},"召回设置",-1)),t("div",Lt,[e[30]||(e[30]=t("div",{class:"form-item-label"},[t("span",null,"检索模式")],-1)),t("div",Ct,[t("div",At,[(u(!0),y(P,null,H(R.value,o=>(u(),y("div",{class:me(["retrieval-mode-item",{active:s.search_type==o.value}]),key:o.value,onClick:te=>q(o.value)},[s.search_type==o.value?(u(),K(Y,{key:0,class:"check-arrow",name:"check-arrow-filled"})):j("",!0),t("div",Rt,[l(Y,{name:o.iconName,class:"title-icon"},null,8,["name"]),t("span",It,N(o.title),1),o.isRecommendation?(u(),K(Y,{key:0,class:"recommendation-icon",name:"recommendation"})):j("",!0)]),t("div",Ut,N(o.desc),1)],10,Mt))),128))])])]),t("div",qt,[t("div",Nt,[e[32]||(e[32]=t("span",null,"Top K ",-1)),l(p,null,{title:f(()=>e[31]||(e[31]=[I("最多从知识库中召回分段数，最低为1，最高为10。召回分段数越多，消耗的token也会越多。")])),default:f(()=>[l(F(J),{class:"question-icon"})]),_:1})]),t("div",Ot,[t("div",Bt,[t("div",Tt,[l(v,{onBlur:a,class:"custom-slider",value:s.top_k,"onUpdate:value":e[9]||(e[9]=o=>s.top_k=o),min:1,max:10},null,8,["value"])]),t("div",zt,[l(E,{onBlur:a,value:s.top_k,"onUpdate:value":e[10]||(e[10]=o=>s.top_k=o),min:1,max:10},null,8,["value"])])])])]),s.search_type!=3&&s.search_type!=4?(u(),y("div",Et,[t("div",Ft,[e[34]||(e[34]=t("span",null,"相似度阈值 ",-1)),l(p,null,{title:f(()=>e[33]||(e[33]=[I("召回时，只会召回相似度大于阈值的文本分段。取值范围：0~1，阈值越大回答的越准确，建议不超过0.9")])),default:f(()=>[l(F(J),{class:"question-icon"})]),_:1})]),t("div",Vt,[t("div",Dt,[t("div",Kt,[l(v,{onBlur:a,class:"custom-slider",value:s.similarity,"onUpdate:value":e[11]||(e[11]=o=>s.similarity=o),min:0,max:1,step:.01},null,8,["value"])]),t("div",jt,[l(E,{onBlur:a,value:s.similarity,"onUpdate:value":e[12]||(e[12]=o=>s.similarity=o),min:0,max:1,step:.01},null,8,["value"])])])])])):j("",!0),t("div",Pt,[t("div",Jt,[e[36]||(e[36]=t("span",null,"Rerank模型 ",-1)),l(p,null,{title:f(()=>e[35]||(e[35]=[I("召回时，只会召回相似度大于阈值的文本分段。取值范围：0~1，阈值越大回答的越准确，建议不超过0.9")])),default:f(()=>[l(F(J),{class:"question-icon"})]),_:1}),l(d,{onChange:a,style:{float:"right"},checkedValue:1,unCheckedValue:0,checked:s.rerank_status,"onUpdate:checked":e[13]||(e[13]=o=>s.rerank_status=o),"checked-children":"开","un-checked-children":"关"},null,8,["checked"])]),s.rerank_status==1?(u(),y("div",Ht,[l(W,{value:s.rerank_use_model,"onUpdate:value":e[14]||(e[14]=o=>s.rerank_use_model=o),placeholder:"请选择Rerank模型",onChange:b,style:{width:"100%"}},{default:f(()=>[(u(!0),y(P,null,H(z.value,o=>(u(),K(re,{key:o.id},{label:f(()=>[l(S,{align:"center",gap:8},{default:f(()=>[t("img",{class:"model-icon",src:o.icon,alt:""},null,8,Gt),I(N(o.name),1)]),_:2},1024)]),default:f(()=>[(u(!0),y(P,null,H(o.children,te=>(u(),K(oe,{value:te,rerank_model_config_id:o.id,key:te},{default:f(()=>[t("span",null,N(te),1)]),_:2},1032,["value","rerank_model_config_id"]))),128))]),_:2},1024))),128))]),_:1},8,["value"])])):j("",!0)])])]),l(de,{open:B.value,"onUpdate:open":e[16]||(e[16]=o=>B.value=o),onCancel:Q,title:"请输入自定义提示词",onOk:G},{default:f(()=>[l(D,{value:O.value,"onUpdate:value":e[15]||(e[15]=o=>O.value=o),placeholder:"请输入",style:{"min-height":"300px"},"allow-clear":""},null,8,["value"])]),_:1},8,["open"])]),_:1},8,["open"])],64)}}}),Yt=Z(Qt,[["__scopeId","data-v-cc7c1d60"]]),Xt={class:"no-data"},Zt={class:"no-data-text"},Wt={__name:"list-empty",props:{text:{type:String,default:"暂无数据"},size:{type:[Number,String],default:100}},setup($){const r=$;return(C,U)=>{const k=ie;return u(),y("div",Xt,[l(k,{name:"empty-document",style:be({"font-size":`${r.size}px`,color:"white"})},null,8,["style"]),t("div",Zt,[xe(C.$slots,"default",{},()=>[I(N(r.text),1)],!0)])])}}},es=Z(Wt,[["__scopeId","data-v-22b194ba"]]),ts={class:"search-box-warpper"},ss={class:"search-box-content"},as={class:"search-set-box"},os={key:0,class:"search-content"},ls={class:"search-input-box"},ns={key:1,class:"search-content search-main"},is={class:"search-input-box"},rs={key:1,class:"search-content-box"},ds={class:"search-tip-box"},cs={key:0,class:"tip"},ms={key:1,class:"tip complete"},us={key:0,class:"container"},_s={key:1,class:"intelligent-answer"},ps=["innerHTML"],vs={key:1},fs={class:"section-box"},hs={key:0,class:"section-label"},gs={class:"section-item-nav"},ys={class:"section-item-nav-left"},ks=["onClick"],bs={key:0},xs={class:"section-item-nav-right"},Ss=["innerHTML"],$s={__name:"search-box",props:{librarySearchData:{type:Object,default:null},messageObj:{type:Object,default:null},library_ids:{type:Array,default:()=>[]},isError:{type:Boolean,default:!1}},emits:["search","defaultParmas"],setup($,{expose:r,emit:C}){const U=C,k=$,R=new We({html:!0,linkify:!0,typographer:!0}),L=w(""),s=w(""),z=w(!1),V=w(!1),x=w({});ae(()=>k.messageObj.content,()=>{L.value=R.render(k.messageObj.content)}),ae(()=>k.messageObj.error,i=>{i&&se(i)});const n=async()=>{if(!k.library_ids.length)return se("请在左侧的知识库选择项内至少选择一个知识库");if(!s.value)return se("请输入消息内容");U("search",s.value),z.value=!0};function _(i){return i.match(/^-?\d+(?:\.\d{0,2})?/)[0]}const q=(i,m)=>{if(!i||!m.trim())return i;const c=m.replace(/[.*+?^${}()|[\]\\]/g,"\\$&"),e=new RegExp(`(${c})`,"gi");return i.replace(e,'<span class="highlight">$1</span>')},b=i=>{if(!i.file_name){window.open(`#/library/details/categary-manage?id=${i.library_id}`);return}window.open(`#/library/preview?id=${i.file_id}`)},h=w(k.librarySearchData),a=X({rerank_status:"",rerank_use_model:"",prompt:"",model_config_id:"",use_model:"",temperature:.5,max_token:2e3,similarity:.4,search_type:1,summary_switch:0}),B=w({}),O=i=>{h.value=i;let m={model_config_id:i.model_config_id||a.model_config_id,use_model:i.use_model||a.use_model,temperature:i.temperature||a.temperature,max_token:i.max_token||a.max_token,size:200,similarity:i.similarity||a.similarity,search_type:i.search_type||a.search_type,summary_switch:i.summary_switch||a.summary_switch,question:s.value,id:k.library_ids.join(","),recall_type:1};i.rerank_status&&(m.rerank_status=i.rerank_status),i.rerank_use_model&&(m.rerank_use_model=i.rerank_use_model),i.prompt&&(m.prompt=i.prompt),i.rerank_status==1&&(m.rerank_model_config_id=i.rerank_model_config_id),V.value=!0,B.value=Object.assign(m),U("defaultParmas",B.value),Re(m).then(c=>{x.value=c.data}).catch(()=>{}).finally(()=>{V.value=!1})},T=w([]);function G(i,m,c){const e=new Set(i.map(g=>g.model_define));return m.filter(g=>{let p=g[c];e.has(p)&&i.filter(d=>{if(d.model_define==p)return d.children=Ie(d.children,g.children),!1})}),i}const Q=async()=>{await _e({model_type:"LLM"}).then(i=>{let m=i.data||[],c=[];T.value=m.map(e=>{c=[];for(let g=0;g<e.model_info.llm_model_list.length;g++){const p=e.model_info.llm_model_list[g];c.push({name:p,deployment_name:e.model_config.deployment_name,model_config_id:e.model_config.id,model_define:e.model_info.model_define})}return{model_config_id:e.model_config.id,name:e.model_info.model_name,model_define:e.model_info.model_define,icon:e.model_info.model_icon_url,children:c,deployment_name:e.model_config.deployment_name}}),T.value=G(Me(T.value,"model_define"),T.value,"model_define")})};return ne(async()=>{await Q(),setTimeout(()=>{var i,m,c,e,g;if(h.value=k.librarySearchData,k.librarySearchData,!((i=h.value)!=null&&i.model_config_id)||!((m=h.value)!=null&&m.use_model)){if(T.value.length>0){let p=T.value[0];if(p){let d=p.children[0];a.use_model=d.name,a.model_config_id=d.model_config_id}}}else a.use_model=((c=h.value)==null?void 0:c.use_model)+"$$",a.model_config_id=((e=h.value)==null?void 0:e.model_config_id)+"$$",a.use_model=a.use_model.split("$$")[0],a.model_config_id=(g=h.value)==null?void 0:g.model_config_id.split("$$")[0]},500)}),r({handleRecallTest:O}),(i,m)=>{const c=ie,e=et,g=pe;return u(),y("div",ts,[t("div",ss,[t("div",as,[l(Yt,{librarySearchData:h.value},null,8,["librarySearchData"])]),z.value?(u(),y("div",ns,[t("div",is,[l(e,{class:"search-input",onPressEnter:n,value:s.value,"onUpdate:value":m[1]||(m[1]=p=>s.value=p),"allow-clear":"",placeholder:"输入关键词搜索"},{suffix:f(()=>[t("div",{class:"search-icon-box",onClick:n},[l(c,{class:"search-icon",name:"search-right"})])]),_:1},8,["value"])]),!L.value&&$.messageObj.finish&&!x.value.length?(u(),K(es,{key:0,style:{"margin-top":"100px"},size:"250"},{default:f(()=>m[4]||(m[4]=[t("div",null,[t("p",{style:{color:"#262626","font-size":"16px","font-weight":"600","line-height":"24px"}},"暂无任何内容")],-1)])),_:1,__:[4]})):(u(),y("div",rs,[t("div",ds,[l(c,{class:"nav-icon",name:"search-tip"}),$.messageObj.finish?(u(),y("span",ms,"智能回答生成完毕")):(u(),y("span",cs,"智能回答生成中..."))]),!$.messageObj.content&&!$.messageObj.finish&&!$.isError?(u(),y("div",us,m[5]||(m[5]=[Se('<div class="rect-container rect1" data-v-878c4db9><div class="rect" data-v-878c4db9></div></div><div class="rect-container rect2" data-v-878c4db9><div class="rect" data-v-878c4db9></div></div><div class="rect-container rect3" data-v-878c4db9><div class="rect" data-v-878c4db9></div></div>',3)]))):(u(),y("div",_s,[L.value?(u(),y("div",{key:0,innerHTML:L.value},null,8,ps)):(u(),y("div",vs,"暂无任何内容"))])),t("div",fs,[m[7]||(m[7]=t("div",{class:"tips"},[t("div",{class:"tips-text"},"以上内容由大模型生成"),t("div",{class:"tips-line"})],-1)),x.value.length?(u(),y("div",hs,[m[6]||(m[6]=I("相关分段 ")),t("div",null,"("+N(x.value.length)+")",1)])):j("",!0),(u(!0),y(P,null,H(x.value,p=>(u(),y("div",{class:"section-item",key:p.id},[t("div",gs,[t("div",ys,[l(c,{class:"section-item-icon",name:"document"}),t("div",{class:"section-item-label",onClick:d=>b(p)},[I(N(p.file_name),1),p.file_name?j("",!0):(u(),y("span",bs,N(p.library_name)+"-精选",1))],8,ks)]),t("div",xs,"相似度："+N(_(p.similarity)),1)]),l(g,{overlayClassName:"search-content-tip",placement:"top"},{title:f(()=>[I(N(p.content),1)]),default:f(()=>[t("div",{class:"section-item-content",innerHTML:q(p.content,s.value)},null,8,Ss)]),_:2},1024)]))),128))])]))])):(u(),y("div",os,[m[2]||(m[2]=t("div",{class:"search-label"},"知识搜索",-1)),m[3]||(m[3]=t("div",{class:"search-tip"},"快速搜索所选择的知识库中内容",-1)),t("div",ls,[l(e,{class:"search-input",onPressEnter:n,value:s.value,"onUpdate:value":m[0]||(m[0]=p=>s.value=p),"allow-clear":"",placeholder:"输入关键词搜索"},{suffix:f(()=>[t("div",{class:"search-icon-box",onClick:n},[l(c,{class:"search-icon",name:"search-right"})])]),_:1},8,["value"])])]))])])}}},ws=Z($s,[["__scopeId","data-v-878c4db9"]]),Ls={class:"cu-tabs"},Cs=["onClick"],As={__name:"contain-tabs",props:{value:{type:[Number,String],required:!0},tabs:{type:Array,required:!0,default:()=>[]}},emits:["update:value","change"],setup($,{emit:r}){const C=r,U=$,k=R=>{C("update:value",R),C("change",R)};return(R,L)=>(u(),y("div",Ls,[(u(!0),y(P,null,H($.tabs,s=>(u(),y("div",{class:me(["tab-item",{active:U.value===s.value}]),onClick:z=>k(s.value),key:s.value},N(s.title),11,Cs))),128))]))}},Ms=Z(As,[["__scopeId","data-v-9397dcbb"]]),Rs=ue("searchStore",{state:()=>({indeterminate:!1,checkAll:!1,checkedList:[],activeKey:"all"}),getters:{getIndeterminate(){return this.indeterminate},getCheckAll(){return this.checkAll},getCheckedList(){return this.checkedList},getActiveKey(){return this.activeKey}},actions:{setIndeterminate($){this.indeterminate=$},setCheckAll($){this.checkAll=$},setCheckedList($){this.checkedList=$},setActiveKey($){this.activeKey=$}},persist:{enabled:!0,strategies:[{key:"searchStore",storage:localStorage,paths:["indeterminate","checkAll","checkedList","activeKey"]}]}}),Is=ue("search-lirary",()=>{const $=tt(),r=X({reasoning_content:"",show_reasoning:!1,content:"",quote_file:[],id:"",finish:!1,debug:[],error:[],recall_time:0,request_time:0,loading:!1});let C=null;const U=w(0),k=w(""),R=X({context_pair:"",create_time:"",id:"",max_token:"",model_config_id:"",rerank_model_config_id:"",rerank_status:"",rerank_use_model:"",search_type:"",similarity:"",size:"",temperature:"",update_time:"",use_model:"",user_id:"",summary_switch:0}),L=(x,n)=>{if(x=="reasoning_content"){let _=r.reasoning_content||"";r.reasoning_content=_+n,r.show_reasoning=!0}if(x=="sending"){let _=r.content||"";r.content=_+n}if(x=="quote_file"&&(r.quote_file=n.length>0?n:[]),x=="ai_message"){if(n.menu_json&&n.msg_type==2){let _=JSON.parse(n.menu_json);r.question=_.question}r.id=n.id,r.content=n.content,n.quote_file&&typeof n.quote_file=="string"&&(r.quote_file=JSON.parse(n.quote_file))}x=="finish"&&(r.finish=!0),x=="debug"&&(r.debug=n.length>0?n:[]),x=="error"&&(r.error=n.length>0?n:[]),x=="recall_time"&&(r.recall_time=n||0),x=="request_time"&&(r.request_time=n||0),$.emit("updateAiMessage",r)},s=()=>{r.loading=!1};return{searchFormState:R,dialogue_id:U,openid:k,messageObj:r,getLibrarySearchFn:async()=>{C&&(C.abort(),C=null);const x=await Oe();try{let n=x.data;Object.assign(R,{...n})}catch(n){Promise.reject(n)}return x},searchMessage:(x,n,_)=>{Ue(32),r.content="",r.finish=!1;let q={model_config_id:_.model_config_id,use_model:_.use_model,temperature:_.temperature,max_token:_.max_token,size:_.size,similarity:_.similarity,search_type:_.search_type,question:x,id:n.join(","),recall_type:1,summary_switch:_.summary_switch};_.rerank_status&&(q.rerank_status=_.rerank_status),_.rerank_use_model&&(q.rerank_use_model=_.rerank_use_model),_.prompt&&(q.prompt=_.prompt),_.rerank_status==1&&(q.rerank_model_config_id=_.rerank_model_config_id),C=qe(q),C.onMessage=b=>{if(b.event!=="sending"&&Ne(b),b.event=="dialogue_id"&&(U.value=b.data),b.event=="reasoning_content"&&L("reasoning_content",b.data),b.event=="sending"&&L("sending",b.data),b.event=="ai_message"){let h=JSON.parse(b.data);L("ai_message",h)}if(b.event=="quote_file"){let h=JSON.parse(b.data);L("quote_file",h)}if(b.event=="finish"&&L("finish",b.data),b.event=="debug"){let h=JSON.parse(b.data);L("debug",h)}if(b.event=="error"){let h=b.data;L("error",h)}if(b.event=="recall_time"){let h=b.data;L("recall_time",h)}},C.onClose=()=>{s(),C=null}}}}),Us={class:"chat-monitor-page"},qs={class:"page-left"},Ns={class:"toolbar-box"},Os={class:"library-checkbox-box"},Bs={class:"app-list-box"},Ts={class:"list-box",ref:"scrollContainer"},zs={class:"list-item"},Es={class:"list-item-box"},Fs={class:"library-icon"},Vs=["onClick"],Ds={class:"page-body"},Ks={__name:"index",setup($){const r=Rs();let{getIndeterminate:C,getCheckAll:U,getCheckedList:k,getActiveKey:R}=ce(r);const L=Is(),{getLibrarySearchFn:s,searchMessage:z}=L,{messageObj:V}=ce(L),x=w(null),n=w(null),_=w("all"),q=w([{title:"全部",value:"all"},{title:"普通",value:"0"},{title:"问答",value:"2"}]),b=w({}),h=w([]),a=X({indeterminate:!1,checkAll:!1,checkedList:[]}),B=d=>{b.value=d},O=w(!1),T=async d=>{var A;O.value=!1;let S=await s();if(n.value=S.data,n.value.id||(n.value=Object.assign(b.value)),n.value,!n.value.model_config_id||!n.value.use_model)return O.value=!0,se("请在搜索设置中配置好相应配置后再使用");(A=x.value)==null||A.handleRecallTest(n.value),z(d,a.checkedList,n.value)},G=d=>{Object.assign(a,{checkedList:d.target.checked?h.value.map(S=>S.id):[],indeterminate:!!a.checkedList.length&&a.checkedList.length<h.value.length}),r.setCheckedList(a.checkedList),r.setIndeterminate(a.indeterminate)},Q=d=>{r.setCheckedList(d)},i=d=>{window.open(`#/library/details/knowledge-document?id=${d}`)};ae(()=>a.checkedList,d=>{a.indeterminate=!!d.length&&d.length<h.value.length,a.checkAll=d.length>=h.value.length,r.setIndeterminate(a.indeterminate),r.setCheckAll(a.checkAll)});const m=()=>{h.value.forEach(d=>{d.type==0,d.type==2}),q.value=[{title:"全部",value:"all"},{title:"普通",value:"0"},{title:"问答",value:"2"}]},c=(d,S)=>{if(S.length===0)return!1;const A=new Set(d);return S.every(M=>A.has(M))},e=(d,S)=>!S.some(A=>d.includes(A)),g=async()=>{let d=_.value==="all"?"":_.value;await Be({type:d}).then(S=>{var D;let A=S.data||[];A.forEach(v=>{v.file_size_str=Te(v.file_size),v.avatar||(v.avatar=v.type==0?ze:Ee)}),h.value=A;const M=h.value.map(v=>v.id);if((D=k.value)!=null&&D.length&&(M!=null&&M.length)){const v=k.value,E=M,Y=c(v,E),oe=e(v,E),W=v.length>=E.length&&Y,ee={checkAll:W,indeterminate:!W&&!oe};r.$patch(ee),Object.assign(a,ee)}else{const v={checkAll:!1,indeterminate:!1};r.$patch(v),Object.assign(a,v)}a.checkedList=k.value,a.indeterminate=C.value,!U.value&&k.value.length==0&&!C.value&&R.value=="all"&&(r.setCheckAll(!0),a.checkedList=M,r.setCheckedList(M)),_.value==="all"&&m()})},p=d=>{r.setActiveKey(d),g()};return ne(async()=>{R.value&&(_.value=R.value),await g();let d=await s();n.value=d.data}),$e(()=>{}),(d,S)=>{const A=st,M=ot,D=at;return u(),y("div",Us,[t("div",qs,[t("div",Ns,[l(Ms,{tabs:q.value,value:_.value,"onUpdate:value":S[0]||(S[0]=v=>_.value=v),onChange:p},null,8,["tabs","value"])]),t("div",Os,[t("div",Bs,[l(A,{checked:a.checkAll,"onUpdate:checked":S[1]||(S[1]=v=>a.checkAll=v),indeterminate:a.indeterminate,onChange:G},{default:f(()=>S[3]||(S[3]=[I(" 全选/取消 ")])),_:1,__:[3]},8,["checked","indeterminate"])]),l(D,{value:a.checkedList,"onUpdate:value":S[2]||(S[2]=v=>a.checkedList=v),onChange:Q},{default:f(()=>[t("div",Ts,[(u(!0),y(P,null,H(h.value,v=>(u(),y("div",{class:"list-item-wraapper",key:v.id},[t("div",zs,[l(A,{value:v.id},null,8,["value"]),t("div",Es,[t("div",Fs,[l(M,{preview:!1,width:32,src:v.avatar},null,8,["src"])]),t("div",{class:"library-name",onClick:E=>i(v.id)},N(v.library_name),9,Vs)])])]))),128))],512)]),_:1},8,["value"])])]),t("div",Ds,[l(ws,{ref_key:"searchBoxRef",ref:x,onDefaultParmas:B,onSearch:T,isError:O.value,messageObj:F(V),librarySearchData:n.value,library_ids:a.checkedList},null,8,["isError","messageObj","librarySearchData","library_ids"])])])}}},Ba=Z(Ks,[["__scopeId","data-v-a9d74f6c"]]);export{Ba as default};
