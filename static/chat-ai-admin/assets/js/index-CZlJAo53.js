import{e as _e,b as me,d as C,z as X,w as ee,q as te,N as p,O as _,F as D,S as j,a6 as V,j as i,U as k,Z as q,k as ue,u as K,X as t,a1 as Q,a5 as ie,_ as T,G as pe,Y as ve,V as fe,ao as he,M as re,a8 as ne,D as ge}from"./vue-chunks-BRsu9_To.js";import{l as ye,B as ke,d as se,k as le,dH as be,b as Z,aB as xe,dg as $e,bA as W,aC as Se,aE as Le,dI as we,bD as Ae,dJ as Ce,a1 as Me,bI as Re,bF as Ie,bG as Ne}from"../../index-CptKfSUC.js";import{h as de}from"./index-DDsrBuja.js";import{M as qe}from"./model-select-ClMVuS8r.js";import{S as Ue}from"./SettingOutlined-B67u9OCJ.js";import"./index-B0iUyVGC.js";import{_ as Be,R as Oe}from"./RadioButton-e2BmC77e.js";import{Q as Y}from"./QuestionCircleOutlined-DXvm_sAY.js";import{S as Te,a as ze,i as Ee}from"./index-R3fGpy-Z.js";import{_ as Fe}from"./index-BU9PsaLL.js";import{_ as je}from"./TextArea-DZQUCnMF.js";import{_ as ce}from"./index-SQEG4xim.js";import{_ as Ke}from"./index-hq4QCTK1.js";import{_ as Ve}from"./index-vBq9bZl8.js";import{_ as De}from"./index-CB2m4unW.js";import{_ as Pe}from"./index-k-2TYXj4.js";import{M as Je}from"./index-BMSQkwth.js";import"./index-CrGpUfGH.js";import{I as He}from"./Input-BFAHe0DY.js";import{u as Ge}from"./useEventBus-BwH2zX88.js";import{C as Qe,_ as Ye}from"./index-DN4kwDuY.js";import{I as Xe}from"./index-DWP-t6xF.js";import"./axios-Dq7h7Pqt.js";import"./qs-BrxkIg-9.js";import"./crypto-js-ClNpte_9.js";import"./dayjs-B6IotFah.js";import"./FormItemContext-gpTH9eHq.js";import"./Checkbox-iIXTQx8h.js";import"./Trigger-B5sPmMFr.js";import"./ResizeObserver.es-B1PUzC5B.js";import"./index-TvkCt6Hp.js";import"./slide-D4Zk8vlN.js";import"./index-CreR3MX_.js";import"./CheckOutlined-CR4N2RZP.js";import"./DownOutlined-DkWiBss_.js";import"./SearchOutlined-BkABIbhb.js";import"./move-Bc7ekOgk.js";import"./inputProps-DCrFQ5HR.js";import"./colors-CB658H7g.js";import"./UpOutlined-C2jweHdT.js";import"./Search-BuYDKTKT.js";import"./isPlainObject-iUjGA7o2.js";import"./Password-BJfMc7qR.js";import"./index-pWRbicsy.js";import"./LeftOutlined-BEImUYMc.js";import"./RightOutlined-Bjc8WMi4.js";const Ze={class:"prompt-form"},We={class:"prompt-form-item"},et={class:"prompt-form-item"},tt={class:"prompt-form-item-content"},st={key:0,class:"prompt-form-item-tip"},at={class:"prompt-form-item"},ot={class:"prompt-form-item-label"},nt={class:"form-item-body"},lt={class:"number-box"},it={class:"number-slider-box"},rt={class:"number-input-box"},dt={class:"prompt-form-item"},ct={class:"prompt-form-item-label"},_t={class:"form-item-body"},mt={class:"number-box"},ut={class:"number-slider-box"},pt={class:"number-input-box"},vt={class:"recall-settings-box"},ft={class:"form-box prompt-form"},ht={class:"form-item is-required"},gt={class:"form-item-body"},yt={class:"retrieval-mode-items"},kt=["onClick"],bt={class:"retrieval-mode-title"},xt={class:"title-text"},$t={class:"retrieval-mode-desc"},St={class:"form-item"},Lt={class:"form-item-label"},wt={class:"form-item-body"},At={class:"number-box"},Ct={class:"number-slider-box"},Mt={class:"number-input-box"},Rt={key:0,class:"form-item"},It={class:"form-item-label"},Nt={class:"form-item-body"},qt={class:"number-box"},Ut={class:"number-slider-box"},Bt={class:"number-input-box"},Ot={class:"form-item"},Tt={class:"form-item-label"},zt={key:0,class:"form-item-body"},Et=["src"],Ft=_e({__name:"search-drawer",props:{librarySearchData:{type:Object,default:null},defaultLibrarySearchData:{type:Object,default:null}},setup($){let{role_permission:r,role_type:M}=ye();const U=me(()=>M==1||r.includes("SearchSets")),b=$,I=C([{iconName:"mix-icon",title:"混合检索",value:1,isRecommendation:!0,desc:"同时执行三种检索模式，使用RRF算法进行排序，从三种查询结果中选择更匹配用户问题的结果。混合检索兼顾语义相似性与逻辑关联性，通过互补优势提升检索的准确性和生成结果的可信度"},{iconName:"vector-icon",title:"向量检索",value:2,desc:"将用户提问转成向量之后与知识库分段匹配相似度，返回相似度高的结果。向量检索擅长语义相似性匹配和大规模非结构化数据处理，但缺乏可解释性和精准关系验证"},{iconName:"graph-icon",title:"知识图谱检索",value:4,desc:"通过关系推理，检索出与用户问题相关联的知识。知识图谱检索擅长精准的实体关系推理和逻辑验证，但对非结构化文本和语义模糊查询支持较弱"},{iconName:"search-check-icon",title:"全文检索",value:3,desc:"通过分词匹配文档中的词汇，返回包含这些词汇的文本片段"}]),w=C(!1),s=X({use_model:"",model_config_id:"",prompt_type:"0",prompt:"",temperature:.5,max_token:2e3,context_pair:0,search_type:1,top_k:5,size:0,similarity:.4,rerank_status:0,rerank_use_model:void 0,rerank_model_config_id:void 0}),z=C([]),E=()=>{de({model_type:"RERANK"}).then(f=>{let e=f.data||[];z.value=e.map(R=>({id:R.model_config.id,name:R.model_info.model_name,icon:R.model_info.model_icon_url,children:R.model_info.rerank_model_list}))})},x=(f,e)=>{s.use_model=e.modelName,s.model_config_id=e.modelId,a()},l=C([]),m=f=>{var e,R,o,d,S;if(l.value=f,!((e=b.librarySearchData)!=null&&e.model_config_id)||!((R=b.librarySearchData)!=null&&R.use_model)){if(l.value.length>0){let u=l.value[0];if(u){let L=u.children[0];s.use_model=L.name,s.model_config_id=L.model_config_id}}}else s.use_model=((o=b.librarySearchData)==null?void 0:o.use_model)+"$$",s.model_config_id=((d=b.librarySearchData)==null?void 0:d.model_config_id)+"$$",s.use_model=s.use_model.split("$$")[0],s.model_config_id=(S=b.librarySearchData)==null?void 0:S.model_config_id.split("$$")[0]},B=f=>{s.search_type=f,a()},g=(f,e)=>{s.rerank_model_config_id=e.rerank_model_config_id,a()},v=f=>{let e={...f};e.max_token=parseFloat(e.max_token),e.temperature=parseFloat(e.temperature),e.context_pair=parseFloat(e.context_pair),e.search_type=parseFloat(e.search_type),e.rerank_status=parseFloat(e.rerank_status),e.similarity=parseFloat(e.similarity),e.top_k=parseFloat(e.size),e.rerank_use_model===""&&(e.rerank_use_model=void 0),Object.keys(e).forEach(R=>{s[R]=e[R]})},a=()=>{let f={...s};if(!f.prompt&&s.prompt_type=="1")return le.error("请输入自定义提示词");(s.search_type==3||s.search_type==4)&&delete f.similarity,s.prompt_type=="0"&&delete f.prompt,f.size=f.top_k,be(f).then(e=>{le.success("保存成功")})},P=f=>{},F=()=>{w.value=!0};return ee(()=>b.librarySearchData,f=>{var e;(e=b.librarySearchData)!=null&&e.id&&v({...pe(b.librarySearchData)})}),te(()=>{E()}),(f,e)=>{const R=ke,o=Oe,d=Be,S=je,u=ce,L=Ke,y=Ve,c=se,A=De,N=Pe,O=ze,J=Ee,h=Te,H=Fe;return _(),p(D,null,[U.value?(_(),j(R,{key:0,onClick:F,icon:ue(K(Ue))},{default:k(()=>e[15]||(e[15]=[q("搜索设置")])),_:1,__:[15]},8,["icon"])):V("",!0),i(H,{open:w.value,"onUpdate:open":e[14]||(e[14]=n=>w.value=n),class:"custom-class","root-class-name":"root-class-name",title:"搜索设置",width:"472",placement:"right",onAfterOpenChange:P},{default:k(()=>[t("div",Ze,[e[24]||(e[24]=t("div",{class:"prompt-form-label"},"模型设置",-1)),t("div",We,[e[16]||(e[16]=t("div",{class:"prompt-form-item-label"},[t("span",{style:{color:"red"}},"* "),t("span",null,"模型选择")],-1)),i(qe,{modelType:"LLM",modeName:s.use_model,"onUpdate:modeName":e[0]||(e[0]=n=>s.use_model=n),modeId:s.model_config_id,"onUpdate:modeId":e[1]||(e[1]=n=>s.model_config_id=n),style:{width:"100%"},onLoaded:m,onChange:x},null,8,["modeName","modeId"])]),t("div",et,[e[19]||(e[19]=t("div",{class:"prompt-form-item-label"},[t("span",{style:{color:"red"}},"* "),t("span",null,"提示词")],-1)),i(d,{value:s.prompt_type,"onUpdate:value":e[2]||(e[2]=n=>s.prompt_type=n),onChange:a},{default:k(()=>[i(o,{value:"0"},{default:k(()=>e[17]||(e[17]=[q("默认提示词")])),_:1,__:[17]}),i(o,{value:"1"},{default:k(()=>e[18]||(e[18]=[q("自定义提示词")])),_:1,__:[18]})]),_:1},8,["value"]),t("div",tt,[s.prompt_type=="0"?(_(),p("div",st,"将提交的内容进行智能总结,不要随意发挥")):(_(),j(S,{key:1,onBlur:a,maxLength:500,style:{height:"80px"},value:s.prompt,"onUpdate:value":e[3]||(e[3]=n=>s.prompt=n),placeholder:"请输入自定义提示词"},null,8,["value"]))])]),t("div",at,[t("div",ot,[e[21]||(e[21]=t("span",null,"温度",-1)),i(u,null,{title:k(()=>e[20]||(e[20]=[q("温度越低，回答越严谨。温度越高，回答越发散。")])),default:k(()=>[i(K(Y),{class:"question-icon"})]),_:1})]),t("div",nt,[t("div",lt,[t("div",it,[i(L,{onBlur:a,class:"custom-slider",value:s.temperature,"onUpdate:value":e[4]||(e[4]=n=>s.temperature=n),min:0,max:2,step:.1},null,8,["value"])]),t("div",rt,[i(y,{onBlur:a,value:s.temperature,"onUpdate:value":e[5]||(e[5]=n=>s.temperature=n),min:0,max:2,step:.1},null,8,["value"])])])])]),t("div",dt,[t("div",ct,[e[23]||(e[23]=t("span",null,"最大token",-1)),i(u,null,{title:k(()=>e[22]||(e[22]=[t("div",null,"问题+答案的最大token数，如果出现回答被截断，可调高此值",-1)])),default:k(()=>[i(K(Y),{class:"question-icon"})]),_:1})]),t("div",_t,[t("div",mt,[t("div",ut,[i(L,{onBlur:a,class:"custom-slider",value:s.max_token,"onUpdate:value":e[6]||(e[6]=n=>s.max_token=n),min:0,max:100*1024},null,8,["value"])]),t("div",pt,[i(y,{onBlur:a,value:s.max_token,"onUpdate:value":e[7]||(e[7]=n=>s.max_token=n),min:0,max:100*1024},null,8,["value"])])])])])]),t("div",vt,[t("div",ft,[e[32]||(e[32]=t("div",{class:"prompt-form-label"},"召回设置",-1)),t("div",ht,[e[25]||(e[25]=t("div",{class:"form-item-label"},[t("span",null,"检索模式")],-1)),t("div",gt,[t("div",yt,[(_(!0),p(D,null,Q(I.value,n=>(_(),p("div",{class:ie(["retrieval-mode-item",{active:s.search_type==n.value}]),key:n.value,onClick:G=>B(n.value)},[s.search_type==n.value?(_(),j(c,{key:0,class:"check-arrow",name:"check-arrow-filled"})):V("",!0),t("div",bt,[i(c,{name:n.iconName,class:"title-icon"},null,8,["name"]),t("span",xt,T(n.title),1),n.isRecommendation?(_(),j(c,{key:0,class:"recommendation-icon",name:"recommendation"})):V("",!0)]),t("div",$t,T(n.desc),1)],10,kt))),128))])])]),t("div",St,[t("div",Lt,[e[27]||(e[27]=t("span",null,"Top K ",-1)),i(u,null,{title:k(()=>e[26]||(e[26]=[q("最多从知识库中召回分段数，最低为1，最高为10。召回分段数越多，消耗的token也会越多。")])),default:k(()=>[i(K(Y),{class:"question-icon"})]),_:1})]),t("div",wt,[t("div",At,[t("div",Ct,[i(L,{onBlur:a,class:"custom-slider",value:s.top_k,"onUpdate:value":e[8]||(e[8]=n=>s.top_k=n),min:1,max:10},null,8,["value"])]),t("div",Mt,[i(y,{onBlur:a,value:s.top_k,"onUpdate:value":e[9]||(e[9]=n=>s.top_k=n),min:1,max:10},null,8,["value"])])])])]),s.search_type!=3&&s.search_type!=4?(_(),p("div",Rt,[t("div",It,[e[29]||(e[29]=t("span",null,"相似度阈值 ",-1)),i(u,null,{title:k(()=>e[28]||(e[28]=[q("召回时，只会召回相似度大于阈值的文本分段。取值范围：0~1，阈值越大回答的越准确，建议不超过0.9")])),default:k(()=>[i(K(Y),{class:"question-icon"})]),_:1})]),t("div",Nt,[t("div",qt,[t("div",Ut,[i(L,{onBlur:a,class:"custom-slider",value:s.similarity,"onUpdate:value":e[10]||(e[10]=n=>s.similarity=n),min:0,max:1,step:.01},null,8,["value"])]),t("div",Bt,[i(y,{onBlur:a,value:s.similarity,"onUpdate:value":e[11]||(e[11]=n=>s.similarity=n),min:0,max:1,step:.01},null,8,["value"])])])])])):V("",!0),t("div",Ot,[t("div",Tt,[e[31]||(e[31]=t("span",null,"Rerank模型 ",-1)),i(u,null,{title:k(()=>e[30]||(e[30]=[q("召回时，只会召回相似度大于阈值的文本分段。取值范围：0~1，阈值越大回答的越准确，建议不超过0.9")])),default:k(()=>[i(K(Y),{class:"question-icon"})]),_:1}),i(A,{onChange:a,style:{float:"right"},checkedValue:1,unCheckedValue:0,checked:s.rerank_status,"onUpdate:checked":e[12]||(e[12]=n=>s.rerank_status=n),"checked-children":"开","un-checked-children":"关"},null,8,["checked"])]),s.rerank_status==1?(_(),p("div",zt,[i(h,{value:s.rerank_use_model,"onUpdate:value":e[13]||(e[13]=n=>s.rerank_use_model=n),placeholder:"请选择Rerank模型",onChange:g,style:{width:"100%"}},{default:k(()=>[(_(!0),p(D,null,Q(z.value,n=>(_(),j(J,{key:n.id},{label:k(()=>[i(N,{align:"center",gap:8},{default:k(()=>[t("img",{class:"model-icon",src:n.icon,alt:""},null,8,Et),q(T(n.name),1)]),_:2},1024)]),default:k(()=>[(_(!0),p(D,null,Q(n.children,G=>(_(),j(O,{value:G,rerank_model_config_id:n.id,key:G},{default:k(()=>[t("span",null,T(G),1)]),_:2},1032,["value","rerank_model_config_id"]))),128))]),_:2},1024))),128))]),_:1},8,["value"])])):V("",!0)])])])]),_:1},8,["open"])],64)}}}),jt=Z(Ft,[["__scopeId","data-v-9add105f"]]),Kt={class:"no-data"},Vt={class:"no-data-text"},Dt={__name:"list-empty",props:{text:{type:String,default:"暂无数据"},size:{type:[Number,String],default:100}},setup($){const r=$;return(M,U)=>{const b=se;return _(),p("div",Kt,[i(b,{name:"empty-document",style:ve({"font-size":`${r.size}px`,color:"white"})},null,8,["style"]),t("div",Vt,[fe(M.$slots,"default",{},()=>[q(T(r.text),1)],!0)])])}}},Pt=Z(Dt,[["__scopeId","data-v-22b194ba"]]),Jt={class:"search-box-warpper"},Ht={class:"search-box-content"},Gt={class:"search-set-box"},Qt={key:0,class:"search-content"},Yt={class:"search-input-box"},Xt={key:1,class:"search-content search-main"},Zt={class:"search-input-box"},Wt={key:1,class:"search-content-box"},es={class:"search-tip-box"},ts={key:0,class:"tip"},ss={key:1,class:"tip complete"},as={key:0,class:"container"},os={key:1,class:"intelligent-answer"},ns=["innerHTML"],ls={key:1},is={class:"section-box"},rs={key:0,class:"section-label"},ds={class:"section-item-nav"},cs={class:"section-item-nav-left"},_s=["onClick"],ms={key:0},us={class:"section-item-nav-right"},ps=["innerHTML"],vs={__name:"search-box",props:{librarySearchData:{type:Object,default:null},messageObj:{type:Object,default:null},library_ids:{type:Array,default:()=>[]},isError:{type:Boolean,default:!1}},emits:["search","defaultParmas"],setup($,{expose:r,emit:M}){const U=M,b=$,I=new Je({html:!0,linkify:!0,typographer:!0}),w=C(""),s=C(""),z=C(!1),E=C(!1),x=C({});ee(()=>b.messageObj.content,()=>{w.value=I.render(b.messageObj.content)}),ee(()=>b.messageObj.error,o=>{o&&W(o)});const l=async()=>{if(!b.library_ids.length)return W("请在左侧的知识库选择项内至少选择一个知识库");if(!s.value)return W("请输入消息内容");U("search",s.value),z.value=!0};function m(o){return o.match(/^-?\d+(?:\.\d{0,2})?/)[0]}const B=(o,d)=>{if(!o||!d.trim())return o;const S=d.replace(/[.*+?^${}()|[\]\\]/g,"\\$&"),u=new RegExp(`(${S})`,"gi");return o.replace(u,'<span class="highlight">$1</span>')},g=o=>{if(!o.file_name){window.open(`#/library/details/categary-manage?id=${o.library_id}`);return}window.open(`#/library/preview?id=${o.file_id}`)},v=C(b.librarySearchData),a=X({rerank_status:"",rerank_use_model:"",prompt:"",model_config_id:"",use_model:"",temperature:.5,max_token:2e3,similarity:.4,search_type:1}),P=C({}),F=o=>{v.value=o;let d={model_config_id:o.model_config_id||a.model_config_id,use_model:o.use_model||a.use_model,temperature:o.temperature||a.temperature,max_token:o.max_token||a.max_token,size:200,similarity:o.similarity||a.similarity,search_type:o.search_type||a.search_type,question:s.value,id:b.library_ids.join(","),recall_type:1};o.rerank_status&&(d.rerank_status=o.rerank_status),o.rerank_use_model&&(d.rerank_use_model=o.rerank_use_model),o.prompt&&(d.prompt=o.prompt),o.rerank_status==1&&(d.rerank_model_config_id=o.rerank_model_config_id),E.value=!0,P.value=Object.assign(d),U("defaultParmas",P.value),$e(d).then(S=>{x.value=S.data}).catch(()=>{}).finally(()=>{E.value=!1})},f=C([]);function e(o,d,S){const u=new Set(o.map(L=>L.model_define));return d.filter(L=>{let y=L[S];u.has(y)&&o.filter(c=>{if(c.model_define==y)return c.children=Se(c.children,L.children),!1})}),o}const R=async()=>{await de({model_type:"LLM"}).then(o=>{let d=o.data||[],S=[];f.value=d.map(u=>{S=[];for(let L=0;L<u.model_info.llm_model_list.length;L++){const y=u.model_info.llm_model_list[L];S.push({name:y,deployment_name:u.model_config.deployment_name,model_config_id:u.model_config.id,model_define:u.model_info.model_define})}return{model_config_id:u.model_config.id,name:u.model_info.model_name,model_define:u.model_info.model_define,icon:u.model_info.model_icon_url,children:S,deployment_name:u.model_config.deployment_name}}),f.value=e(xe(f.value,"model_define"),f.value,"model_define")})};return te(async()=>{var o,d,S,u,L;if(await R(),!((o=v.value)!=null&&o.model_config_id)||!((d=v.value)!=null&&d.use_model)){if(f.value.length>0){let y=f.value[0];if(y){let c=y.children[0];a.use_model=c.name,a.model_config_id=c.model_config_id}}}else a.use_model=((S=v.value)==null?void 0:S.use_model)+"$$",a.model_config_id=((u=v.value)==null?void 0:u.model_config_id)+"$$",a.use_model=a.use_model.split("$$")[0],a.model_config_id=(L=v.value)==null?void 0:L.model_config_id.split("$$")[0]}),r({handleRecallTest:F}),(o,d)=>{const S=se,u=He,L=ce;return _(),p("div",Jt,[t("div",Ht,[t("div",Gt,[i(jt,{librarySearchData:v.value},null,8,["librarySearchData"])]),z.value?(_(),p("div",Xt,[t("div",Zt,[i(u,{class:"search-input",onPressEnter:l,value:s.value,"onUpdate:value":d[1]||(d[1]=y=>s.value=y),"allow-clear":"",placeholder:"输入关键词搜索"},{suffix:k(()=>[t("div",{class:"search-icon-box",onClick:l},[i(S,{class:"search-icon",name:"search-right"})])]),_:1},8,["value"])]),!w.value&&$.messageObj.finish&&!x.value.length?(_(),j(Pt,{key:0,style:{"margin-top":"100px"},size:"250"},{default:k(()=>d[4]||(d[4]=[t("div",null,[t("p",{style:{color:"#262626","font-size":"16px","font-weight":"600","line-height":"24px"}},"暂无任何内容")],-1)])),_:1,__:[4]})):(_(),p("div",Wt,[t("div",es,[i(S,{class:"nav-icon",name:"search-tip"}),$.messageObj.finish?(_(),p("span",ss,"智能回答生成完毕")):(_(),p("span",ts,"智能回答生成中..."))]),!$.messageObj.content&&!$.messageObj.finish&&!$.isError?(_(),p("div",as,d[5]||(d[5]=[he('<div class="rect-container rect1" data-v-f065da1f><div class="rect" data-v-f065da1f></div></div><div class="rect-container rect2" data-v-f065da1f><div class="rect" data-v-f065da1f></div></div><div class="rect-container rect3" data-v-f065da1f><div class="rect" data-v-f065da1f></div></div>',3)]))):(_(),p("div",os,[w.value?(_(),p("div",{key:0,innerHTML:w.value},null,8,ns)):(_(),p("div",ls,"暂无任何内容"))])),t("div",is,[d[7]||(d[7]=t("div",{class:"tips"},[t("div",{class:"tips-text"},"以上内容由大模型生成"),t("div",{class:"tips-line"})],-1)),x.value.length?(_(),p("div",rs,[d[6]||(d[6]=q("相关分段 ")),t("div",null,"("+T(x.value.length)+")",1)])):V("",!0),(_(!0),p(D,null,Q(x.value,y=>(_(),p("div",{class:"section-item",key:y.id},[t("div",ds,[t("div",cs,[i(S,{class:"section-item-icon",name:"document"}),t("div",{class:"section-item-label",onClick:c=>g(y)},[q(T(y.file_name),1),y.file_name?V("",!0):(_(),p("span",ms,T(y.library_name)+"-精选",1))],8,_s)]),t("div",us,"相似度："+T(m(y.similarity)),1)]),i(L,{overlayClassName:"search-content-tip",placement:"top"},{title:k(()=>[q(T(y.content),1)]),default:k(()=>[t("div",{class:"section-item-content",innerHTML:B(y.content,s.value)},null,8,ps)]),_:2},1024)]))),128))])]))])):(_(),p("div",Qt,[d[2]||(d[2]=t("div",{class:"search-label"},"知识搜索",-1)),d[3]||(d[3]=t("div",{class:"search-tip"},"快速搜索所选择的知识库中内容",-1)),t("div",Yt,[i(u,{class:"search-input",onPressEnter:l,value:s.value,"onUpdate:value":d[0]||(d[0]=y=>s.value=y),"allow-clear":"",placeholder:"输入关键词搜索"},{suffix:k(()=>[t("div",{class:"search-icon-box",onClick:l},[i(S,{class:"search-icon",name:"search-right"})])]),_:1},8,["value"])])]))])])}}},fs=Z(vs,[["__scopeId","data-v-f065da1f"]]),hs={class:"cu-tabs"},gs=["onClick"],ys={__name:"contain-tabs",props:{value:{type:[Number,String],required:!0},tabs:{type:Array,required:!0,default:()=>[]}},emits:["update:value","change"],setup($,{emit:r}){const M=r,U=$,b=I=>{M("update:value",I),M("change",I)};return(I,w)=>(_(),p("div",hs,[(_(!0),p(D,null,Q($.tabs,s=>(_(),p("div",{class:ie(["tab-item",{active:U.value===s.value}]),onClick:z=>b(s.value),key:s.value},T(s.title),11,gs))),128))]))}},ks=Z(ys,[["__scopeId","data-v-9397dcbb"]]),bs=re("searchStore",{state:()=>({indeterminate:!1,checkAll:!1,checkedList:[],activeKey:"all"}),getters:{getIndeterminate(){return this.indeterminate},getCheckAll(){return this.checkAll},getCheckedList(){return this.checkedList},getActiveKey(){return this.activeKey}},actions:{setIndeterminate($){this.indeterminate=$},setCheckAll($){this.checkAll=$},setCheckedList($){this.checkedList=$},setActiveKey($){this.activeKey=$}},persist:{enabled:!0,strategies:[{key:"searchStore",storage:localStorage,paths:["indeterminate","checkAll","checkedList","activeKey"]}]}}),xs=re("search-lirary",()=>{const $=Ge(),r=X({reasoning_content:"",show_reasoning:!1,content:"",quote_file:[],id:"",finish:!1,debug:[],error:[],recall_time:0,request_time:0,loading:!1});let M=null;const U=C(0),b=C(""),I=X({context_pair:"",create_time:"",id:"",max_token:"",model_config_id:"",rerank_model_config_id:"",rerank_status:"",rerank_use_model:"",search_type:"",similarity:"",size:"",temperature:"",update_time:"",use_model:"",user_id:""}),w=(x,l)=>{if(x=="reasoning_content"){let m=r.reasoning_content||"";r.reasoning_content=m+l,r.show_reasoning=!0}if(x=="sending"){let m=r.content||"";r.content=m+l}if(x=="quote_file"&&(r.quote_file=l.length>0?l:[]),x=="ai_message"){if(l.menu_json&&l.msg_type==2){let m=JSON.parse(l.menu_json);r.question=m.question}r.id=l.id,r.content=l.content,l.quote_file&&typeof l.quote_file=="string"&&(r.quote_file=JSON.parse(l.quote_file))}x=="finish"&&(r.finish=!0),x=="debug"&&(r.debug=l.length>0?l:[]),x=="error"&&(r.error=l.length>0?l:[]),x=="recall_time"&&(r.recall_time=l||0),x=="request_time"&&(r.request_time=l||0),$.emit("updateAiMessage",r)},s=()=>{r.loading=!1};return{searchFormState:I,dialogue_id:U,openid:b,messageObj:r,getLibrarySearchFn:async()=>{M&&(M.abort(),M=null);const x=await Ce();try{let l=x.data;Object.assign(I,{...l})}catch(l){Promise.reject(l)}return x},searchMessage:(x,l,m)=>{Le(32),r.content="",r.finish=!1;let B={model_config_id:m.model_config_id,use_model:m.use_model,temperature:m.temperature,max_token:m.max_token,size:m.size,similarity:m.similarity,search_type:m.search_type,question:x,id:l.join(","),recall_type:1};m.rerank_status&&(B.rerank_status=m.rerank_status),m.rerank_use_model&&(B.rerank_use_model=m.rerank_use_model),m.prompt&&(B.prompt=m.prompt),m.rerank_status==1&&(B.rerank_model_config_id=m.rerank_model_config_id),M=we(B),M.onMessage=g=>{if(g.event!=="sending"&&Ae(g),g.event=="dialogue_id"&&(U.value=g.data),g.event=="reasoning_content"&&w("reasoning_content",g.data),g.event=="sending"&&w("sending",g.data),g.event=="ai_message"){let v=JSON.parse(g.data);w("ai_message",v)}if(g.event=="quote_file"){let v=JSON.parse(g.data);w("quote_file",v)}if(g.event=="finish"&&w("finish",g.data),g.event=="debug"){let v=JSON.parse(g.data);w("debug",v)}if(g.event=="error"){let v=g.data;w("error",v)}if(g.event=="recall_time"){let v=g.data;w("recall_time",v)}},M.onClose=()=>{s(),M=null}}}}),$s={class:"chat-monitor-page"},Ss={class:"page-left"},Ls={class:"toolbar-box"},ws={class:"library-checkbox-box"},As={class:"app-list-box"},Cs={class:"list-box",ref:"scrollContainer"},Ms={class:"list-item"},Rs={class:"list-item-box"},Is={class:"library-icon"},Ns=["onClick"],qs={class:"page-body"},Us={__name:"index",setup($){const r=bs();let{getIndeterminate:M,getCheckAll:U,getCheckedList:b,getActiveKey:I}=ne(r);const w=xs(),{getLibrarySearchFn:s,searchMessage:z}=w,{messageObj:E}=ne(w),x=C(null),l=C(null),m=C("all"),B=C([{title:"全部",value:"all"},{title:"普通",value:"0"},{title:"问答",value:"2"}]),g=C({}),v=C([]),a=X({indeterminate:!1,checkAll:!1,checkedList:[]}),P=c=>{g.value=c},F=C(!1),f=async c=>{var N;F.value=!1;let A=await s();if(l.value=A.data,l.value.id||(l.value=Object.assign(g.value)),!l.value.model_config_id||!l.value.use_model)return F.value=!0,W("请在搜索设置中配置好相应配置后再使用");(N=x.value)==null||N.handleRecallTest(l.value),z(c,a.checkedList,l.value)},e=c=>{Object.assign(a,{checkedList:c.target.checked?v.value.map(A=>A.id):[],indeterminate:!!a.checkedList.length&&a.checkedList.length<v.value.length}),r.setCheckedList(a.checkedList),r.setIndeterminate(a.indeterminate)},R=c=>{r.setCheckedList(c)},o=c=>{window.open(`#/library/details/knowledge-document?id=${c}`)};ee(()=>a.checkedList,c=>{a.indeterminate=!!c.length&&c.length<v.value.length,a.checkAll=c.length>=v.value.length,r.setIndeterminate(a.indeterminate),r.setCheckAll(a.checkAll)});const d=()=>{v.value.forEach(c=>{c.type==0,c.type==2}),B.value=[{title:"全部",value:"all"},{title:"普通",value:"0"},{title:"问答",value:"2"}]},S=(c,A)=>{if(A.length===0)return!1;const N=new Set(c);return A.every(O=>N.has(O))},u=(c,A)=>!A.some(N=>c.includes(N)),L=async()=>{let c=m.value==="all"?"":m.value;await Me({type:c}).then(A=>{var J;let N=A.data||[];N.forEach(h=>{h.file_size_str=Re(h.file_size),h.avatar||(h.avatar=h.type==0?Ie:Ne)}),v.value=N;const O=v.value.map(h=>h.id);if((J=b.value)!=null&&J.length&&(O!=null&&O.length)){const h=b.value,H=O,n=S(h,H),G=u(h,H),ae=h.length>=H.length&&n,oe={checkAll:ae,indeterminate:!ae&&!G};r.$patch(oe),Object.assign(a,oe)}else{const h={checkAll:!1,indeterminate:!1};r.$patch(h),Object.assign(a,h)}a.checkedList=b.value,a.indeterminate=M.value,!U.value&&b.value.length==0&&!M.value&&I.value=="all"&&(r.setCheckAll(!0),a.checkedList=O,r.setCheckedList(O)),m.value==="all"&&d()})},y=c=>{r.setActiveKey(c),L()};return te(async()=>{I.value&&(m.value=I.value),await L();let c=await s();l.value=c.data}),ge(()=>{}),(c,A)=>{const N=Qe,O=Xe,J=Ye;return _(),p("div",$s,[t("div",Ss,[t("div",Ls,[i(ks,{tabs:B.value,value:m.value,"onUpdate:value":A[0]||(A[0]=h=>m.value=h),onChange:y},null,8,["tabs","value"])]),t("div",ws,[t("div",As,[i(N,{checked:a.checkAll,"onUpdate:checked":A[1]||(A[1]=h=>a.checkAll=h),indeterminate:a.indeterminate,onChange:e},{default:k(()=>A[3]||(A[3]=[q(" 全选/取消 ")])),_:1,__:[3]},8,["checked","indeterminate"])]),i(J,{value:a.checkedList,"onUpdate:value":A[2]||(A[2]=h=>a.checkedList=h),onChange:R},{default:k(()=>[t("div",Cs,[(_(!0),p(D,null,Q(v.value,h=>(_(),p("div",{class:"list-item-wraapper",key:h.id},[t("div",Ms,[i(N,{value:h.id},null,8,["value"]),t("div",Rs,[t("div",Is,[i(O,{preview:!1,width:32,src:h.avatar},null,8,["src"])]),t("div",{class:"library-name",onClick:H=>o(h.id)},T(h.library_name),9,Ns)])])]))),128))],512)]),_:1},8,["value"])])]),t("div",qs,[i(fs,{ref_key:"searchBoxRef",ref:x,onDefaultParmas:P,onSearch:f,isError:F.value,messageObj:K(E),librarySearchData:l.value,library_ids:a.checkedList},null,8,["isError","messageObj","librarySearchData","library_ids"])])])}}},Ma=Z(Us,[["__scopeId","data-v-1cd61309"]]);export{Ma as default};
