import{b as Ce,B as Mt,bu as bn,d as Xe,M as be,dg as Sn,V as wn,E as Ee,Z as xn,dr as Pt,dv as Dt,k as ve,dl as Ft,dm as zt,bU as $n,bL as Cn,bM as Nt,bN as Ln,dw as qn,bO as On,dx as In,bQ as En,e as At,dy as Tn,a1 as Rn,br as Mn,f as Pn,dz as Dn,df as It,dA as Fn,dB as zn,bP as Nn}from"../../index-CfxQ5aRu.js";import{M as o,N as v,W as n,k as t,S as a,u as oe,a1 as Fe,a2 as ze,e as s,B as qe,x as Ue,Z as K,a7 as U,F as pe,$ as xe,z as We,a5 as Qe,b as ke,D as Bt,ai as rt,Y as E,a0 as ye,X as De,Q,G as ut,a4 as Ht,a6 as Ut,a8 as An}from"./vue-chunks-BjMuQ6KD.js";import{_ as Bn}from"./empty-CzGZrENG.js";import{P as Qt}from"./PlusOutlined-xiVHYVI8.js";import{S as Ze,c as Ke,a as Jt,C as jt,b as Hn,E as Un}from"./edit-subsection-C73N9WQ2.js";import{Z as Qn,f as Jn,a as jn,P as Gn,H as Vn,C as Wn,b as Zn}from"./cu-scroll-BxO2YBnE.js";import{S as Je}from"./index-BLP-Fxny.js";import{_ as dt,M as _t}from"./index-Bx_z5H0C.js";import"./index-CBvtIVuM.js";import{D as pt}from"./dropdown-DsYo-imx.js";import{S as Gt}from"./SettingOutlined-fTdHQK4u.js";import{S as Vt}from"./SyncOutlined-DZpJ_zyP.js";import{M as Wt}from"./MoreOutlined-DLVu09bY.js";import{_ as Ye}from"./index-D1MiuDW_.js";import{_ as He}from"./cu-scroll-ClwfOnpN.js";import{_ as Kn,F as Xn}from"./index-xqeVJHPz.js";import{S as Zt,_ as Kt}from"./index-BuS_bfCI.js";import{R as Yn}from"./rename-modal-BPJhzzDn.js";import{V as Et}from"./vue-pdf-embed-TbWIKlKu.js";import{S as ea,a as ta,D as na,E as aa}from"./edit-fragment-alert-Bv6RlMlR.js";import{C as oa}from"./ClockCircleFilled-BsRXNW0P.js";import{_ as la,a as sa}from"./index-P3IiyBCy.js";import{B as ia,_ as ca}from"./index-Q8_wcZdl.js";import{T as ra,_ as ua}from"./index-BMYKVcHu.js";import{_ as da}from"./index-CjFLR2DA.js";import{_ as _a,a as pa}from"./RadioButton-_iRIgmgW.js";import{L as fa}from"./LeftOutlined-qzkQKHcF.js";import{D as Tt}from"./DownOutlined-Gk0UBxct.js";import"./axios-Cm0UX6qg.js";import"./qs-DjdPq-RR.js";import"./crypto-js-BemCeW_6.js";import"./dayjs-DK4rpucX.js";import"./index-DcUUFn-g.js";import"./Input-C5WaaE9Z.js";import"./FormItemContext-DQ1b1ToO.js";import"./index-D6-G2N0k.js";import"./inputProps-D7qr__m5.js";import"./Search-DozVr2pE.js";import"./SearchOutlined-B7dGgS_P.js";import"./isPlainObject-xAKL-sfk.js";import"./TextArea-CN_AI7y7.js";import"./index-CXSrVsd0.js";import"./ResizeObserver.es-B1PUzC5B.js";import"./Password-BCnVcrNJ.js";import"./index-CL2f_cnE.js";import"./index-BLNMWHkL.js";import"./index-DqFgAaLP.js";import"./Trigger-Dy6Dc2CN.js";import"./DownloadOutlined-BrqGknZq.js";import"./CheckOutlined-BLsT0eZM.js";import"./collapseMotion-BH6Vz7El.js";import"./index-BWdnNCYH.js";import"./index-d7geF-HW.js";import"./index-BMSQkwth.js";import"./index-DJgb7gGJ.js";import"./index-QsoU6-T8.js";import"./UpOutlined-CY9GinGn.js";import"./pull-up.esm-JZ91zQ8P.js";import"./observe-dom.esm-DPKTicVt.js";import"./shallowequal-B6gQS78g.js";import"./slide-BYYxYcj9.js";import"./RightOutlined-BHf0iqSq.js";import"./move-BjmscfYf.js";import"./colors-C9XVGyX_.js";import"./responsiveObserve-X1b6Czsg.js";import"./QuestionCircleOutlined-Deh272L3.js";import"./model-select-c6lAzYs5.js";import"./index-D8Y0HnA5.js";import"./index-Capld-U4.js";import"./index-Qxwv7brO.js";import"./index-C38XHIGB.js";import"./useMaxLevel-C9fYQrQA.js";import"./CaretDownFilled-CgS0_Akm.js";import"./index-BSl1-tWC.js";import"./css-DbBMd65r.js";import"./fromPairs-Dx9PT-t0.js";import"./index-CxLzlFzW.js";import"./Checkbox-DQe8ZxR1.js";import"./index-DPiF7UEG.js";import"./CaretDownOutlined-Qu8nVykI.js";import"./pick-CoYCIHvO.js";const ft=$=>(Fe("data-v-8eb7d862"),$=$(),ze(),$),ma={class:"empty-box"},va=ft(()=>n("img",{src:Bn,alt:""},null,-1)),ha=ft(()=>n("div",{class:"title"},"知识库文档为空，请添加分段",-1)),ga=ft(()=>n("span",null,"添加分段",-1)),ka={__name:"empty",props:{detailsInfo:{type:Object}},emits:["openEditSubscription"],setup($,{emit:se}){const C=se,j=()=>{C("openEditSubscription",{})};return(_,p)=>{const f=Mt;return o(),v("div",ma,[va,ha,n("div",null,[t(f,{type:"primary",onClick:j},{icon:a(()=>[t(oe(Qt))]),default:a(()=>[ga]),_:1})])])}}},ct=Ce(ka,[["__scopeId","data-v-8eb7d862"]]),ya=$=>(Fe("data-v-f0ead6c0"),$=$(),ze(),$),ba={class:"chart-wrapper"},Sa=ya(()=>n("div",{class:"chart-mini-map",id:"chatMap"},null,-1)),wa={class:"zoom-toolbar-wrapper"},xa={__name:"chart-box",emits:["nodeClick"],setup($,{expose:se,emit:C}){const j=C,_=s(null);let p=null;const f=qe({nodes:[],edges:[]}),R=s(1),P={},D=()=>{p&&p.destroy();const c={layout:"forceDirected",initialZoom:R.value,disableTelemetry:!0,maxZoom:10,minZoom:.1,minimapContainer:document.getElementById("chatMap"),styling:{minimapViewportBoxColor:"#4399FF",selectedBorderColor:"rgba(255, 255, 255, 1)"}},r=document.getElementById("chartBox");p=new Jn(r,f.nodes,f.edges,c,P);const k=new jn(p);new Gn(p),k.updateCallback("onZoom",O=>{R.value=Number(O.toFixed(1))}),new Vn(p,{drawShadowOnHover:!0}),new Wn(p,{selectOnClick:!0}).updateCallback("onNodeClick",O=>{j("nodeClick",O)})},B=c=>{R.value=c,p&&p.setZoom(c)},g=({nodes:c,edges:r})=>{f.nodes=[f.nodes,...c],f.edges=[f.edges,...r],p&&p.addElementsToGraph(c,r)},ee=({nodes:c,edges:r})=>{f.nodes=[f.nodes,...c],f.edges=[f.edges,...r],p&&p.addAndUpdateElementsInGraph(c,r)},S=({nodes:c,edges:r})=>{f.nodes=c,f.edges=r,p&&p.updateElementsInGraph(c,r)},q=()=>{p&&p.destroy()},te=({nodes:c,edges:r})=>{f.nodes=c,f.edges=r,D()};return Ue(()=>{}),se({render:te,add:g,addAndUpdate:ee,update:S,destroy:q}),(c,r)=>(o(),v("div",ba,[n("div",{class:"chart",id:"chartBox",ref_key:"chartBox",ref:_},null,512),Sa,n("div",wa,[t(Qn,{value:R.value,onChange:B},null,8,["value"])])]))}},$a=Ce(xa,[["__scopeId","data-v-f0ead6c0"]]),je=$=>(Fe("data-v-bb7b1011"),$=$(),ze(),$),Ca={key:0,class:"popup-wrapper entity-details-wrapper"},La={class:"popup-header"},qa=je(()=>n("div",{class:"popup-title"},"实体详情",-1)),Oa={key:0,class:"popup-body"},Ia={class:"popup-content"},Ea={class:"entity-details"},Ta={class:"entity-item"},Ra=je(()=>n("div",{class:"entity-item-header"},[n("div",{class:"entity-item-label"},"实体")],-1)),Ma={class:"entity-name"},Pa={class:"entity-item",style:{"margin-bottom":"8px"}},Da=je(()=>n("div",{class:"entity-item-header"},[n("div",{class:"entity-item-label"},"归属文档")],-1)),Fa={class:"file-info"},za={class:"file-name"},Na={class:"entity-item"},Aa=je(()=>n("div",{class:"entity-item-header"},[n("div",{class:"entity-item-label"},"分段")],-1)),Ba={class:"doc-item"},Ha={class:"fragment-content"},Ua={class:"entity-item"},Qa=je(()=>n("div",{class:"entity-item-header"},[n("div",{class:"entity-item-label"},"子图")],-1)),Ja={key:0,class:""},ja={class:"fragment-content"},Ga={__name:"entity-details",setup($,{expose:se}){const C=qe({show:!1,node:null,fromNodes:[]}),j=()=>{C.show=!1};return se({open:(p,f)=>{C.node=p,C.fromNodes=f,C.show?(C.show=!1,We(()=>{C.show=!0})):C.show=!0},close:j}),(p,f)=>{const R=Xe;return C.show?(o(),v("div",Ca,[n("div",La,[qa,t(oe(bn),{class:"close-btn",onClick:j})]),C.node?(o(),v("div",Oa,[t(Zn,null,{default:a(()=>[n("div",Ia,[n("div",Ea,[n("div",Ta,[Ra,n("div",Ma,K(C.node.name),1)]),n("div",Pa,[Da,n("div",Fa,[t(R,{class:"file-icon",name:"doc-file",style:{}}),n("span",za,K(C.node.file_name),1)])]),n("div",Na,[Aa,n("div",null,[n("div",Ba,[n("div",Ha,K(C.node.content),1)])])]),n("div",Ua,[Qa,n("div",null,[C.fromNodes.length==0?(o(),v("div",Ja,"无")):U("",!0),(o(!0),v(pe,null,xe(C.fromNodes,P=>(o(),v("div",{class:"subgraph-item",key:P.id},[n("div",ja,K(P.name),1)]))),128))])])])])]),_:1})])):U("",!0)])):U("",!0)}}},Va=Ce(Ga,[["__scopeId","data-v-bb7b1011"]]),Wa={class:"graph-model-body"},Za={key:0,class:"loading-wrapper"},Ka={class:"right-box"},Xa={__name:"index",setup($,{expose:se}){const C=s(!1),j=s(null),_=s(null),p=s(null),f=s(!1),R=qe({file_id:"",data_id:""}),P=qe({edges:[],nodes:[]});let D={};const B=()=>{g()},g=()=>{f.value=!0,Sn({file_id:R.file_id,data_id:R.data_id,search_term:R.search_term}).then(c=>{f.value=!1;let r=c.data.edges||[],k=c.data.nodes||[];const h=new Map;r=r.filter(b=>{const he=`${b.from_id}_${b.to_id}`,ie=`${b.to_id}_${b.from_id}`;return h.has(he)||h.has(ie)?!1:(h.set(he,!0),!0)}),r.forEach(b=>{b.id=b.id.toString(),b.from=b.from_id.toString(),b.to=b.to_id.toString(),b.caption=b.label});const O=new Set(r.map(b=>b.from)),ne=new Set(r.map(b=>b.to));k.forEach(b=>{b.caption=b.name,b.id=b.id.toString(),b.nodeType=O.has(b.id)&&ne.has(b.id)?"both":O.has(b.id)?"from":ne.has(b.id)?"to":"normal",b.nodeType==="from"?(b.size=35,b.color="#FFB1B2"):b.nodeType==="to"?(b.size=45,b.color="#005AFF"):(b.size=30,b.color="#69E9BE")});let fe={edges:r,nodes:k};P.edges=fe.edges,P.nodes=fe.nodes,setTimeout(()=>{_.value.render(fe)},0),D={},r.forEach(b=>{D[b.to]||(D[b.to]=[]),D[b.to].push(b.from)})}).catch(c=>{f.value=!1})},ee=c=>{let r=D[c.id]||[],k=[];for(let h=0;h<P.nodes.length;h++)r.indexOf(P.nodes[h].id)>-1&&k.push(P.nodes[h]);p.value.open(c,k)},S=()=>{_.value.destroy(),C.value=!1},q=()=>{C.value=!1};return se({open:c=>{R.file_id=c.file_id,R.data_id=c.id,C.value=!0,setTimeout(()=>{B()},350)}}),(c,r)=>{const k=Je,h=be;return o(),v("div",{ref_key:"mymodal",ref:j},[t(h,{wrapClassName:"graph-model-wrapper",zIndex:99999,centered:"",open:C.value,"onUpdate:open":r[0]||(r[0]=O=>C.value=O),title:"知识图谱",width:"90vw",footer:null,onOk:q,onCancel:S},{default:a(()=>[n("div",Wa,[f.value?(o(),v("div",Za,[t(k)])):U("",!0),t($a,{ref_key:"chartBoxRef",ref:_,loading:f.value,onNodeClick:ee},null,8,["loading"]),n("div",Ka,[t(Va,{ref_key:"entityDetailsRef",ref:p},null,512)])])]),_:1},8,["open"])],512)}}},Ya=Ce(Xa,[["__scopeId","data-v-56e1b6be"]]),eo=$=>(Fe("data-v-1dcfe3b0"),$=$(),ze(),$),to={class:"subsection-box-title"},no=["onClick"],ao={class:"top-block"},oo={class:"title"},lo={class:"title-block"},so={class:"status-box"},io={class:"cfb363f"},co={class:"split-err"},ro={key:0},uo={class:"cfb363f"},_o={class:"right-opration"},po={class:"hover-btn-box"},fo=["onClick"],mo=eo(()=>n("div",null,"精选设置",-1)),vo=["onClick"],ho=["onClick"],go={class:"hover-btn-box"},ko={class:"hover-btn-box"},yo=["onClick"],bo=["onClick"],So={key:0,class:"content-box"},wo={key:1,class:"content-box"},xo=["onMouseup","innerHTML"],$o={key:2,class:"fragment-img"},Co=["src"],Lo={__name:"subsection-box",props:{paragraphLists:{type:Array,default:()=>[]},detailsInfo:{type:Object,default:()=>{}},total:{type:[Number,String],default:0}},emits:["handleDelParagraph","handleScrollTargetPage","openEditSubscription","handleConvert","getStatrList","handleSplit","handleSplitNext","handleSplitUp","handleSplitDelete","handleSegmentation"],setup($,{expose:se,emit:C}){const j=Qe(),_=C,p=$,f=(d,y)=>{let{id:N,title:I,content:X,question:Y,answer:J,images:ce,category_id:u}=d,re=d.similar_questions||[];be.confirm({title:"重新转换确认",icon:null,content:`确定要重新转换【分段${y+1}】吗?`,onOk(){return new Promise(F=>{Pt({id:N,title:I,content:X,question:Y,answer:J,images:ce,category_id:u,similar_questions:JSON.stringify(re)}).then(()=>{_("handleConvert",d),F()}).catch(()=>{F()})})},onCancel(){}})},R=d=>{_("openEditSubscription",d)},P=d=>{be.confirm({title:"提示",icon:t(Ee),content:"确认是否删除该分段?",onOk(){return new Promise(y=>{Dt({id:d}).then(()=>{ve.success("删除成功"),_("handleDelParagraph",d),y()}).catch(()=>{y()})})},onCancel(){}})},D=(d,y,N)=>{window.getSelection().toString().trim()||(_("handleScrollTargetPage",{page_num:d.page_num,index:y}),$e(N))},B=d=>{_("handleSegmentation",d)},g=s([]),ee=()=>{let d={file_id:j.query.id};Ft(d).then(y=>{g.value=y.data||[],_("getStatrList",y.data||[])})};ee();const S=s(null),q=()=>{S.value.show()},te=d=>{var N;let y=(N=g.value.filter(I=>I.id==d.category_id)[0])==null?void 0:N.type;return y?Ke[y]:""},c=(d,y={})=>{zt({id:d.id,category_id:y.id||0}).then(()=>{ve.success("设置成功"),d.category_id=y.id,ee()})},r=s(null),k=d=>{r.value.open(d)},h=s(null),O=s(!1),ne=s({x:0,y:0}),fe=s(""),b=s(null),he=s({text:"",parentIndex:-1,originalHtml:""}),ie=ke(()=>{if(!O.value)return{};const d=162;let y=ne.value.x,N=ne.value.y;const I=h.value.getBoundingClientRect(),X=window.innerWidth;y<10?y=10:y+d>X-50&&(y=X-d-50);const Y=y-I.left,J=N;return{left:`${Y}px`,top:`${J}px`}}),H=(d,y)=>{setTimeout(()=>{const N=window.getSelection(),I=N.toString().trim();if(I){d.stopPropagation(),he.value={text:I,parentIndex:y,originalHtml:p.paragraphLists[y].content},fe.value=I,b.value=N.getRangeAt(0).cloneRange();const Y=N.getRangeAt(0).getBoundingClientRect(),J=h.value.getBoundingClientRect();ne.value={x:Y.left+Y.width/2,y:Y.top-J.top-50},O.value=!0}else O.value=!1},50)},z=d=>{const{parentIndex:y}=he.value;switch(d){case"separate":Se(y);break;case"merge-next":x(y);break;case"merge-prev":me(y);break;case"delete":Re(y);break}O.value=!1,window.getSelection().removeAllRanges()},G=(d,y,N)=>{if(y===0&&N===d.textContent.length&&d.textContent.trim().length>0)return["",d.innerHTML,""];const X=document.createTreeWalker(d,NodeFilter.SHOW_TEXT);let Y,J=0,ce,u,re,F;for(;Y=X.nextNode();){const Ie=Y.nodeValue.length;if(!ce&&J+Ie>=y&&(ce=Y,re=y-J),!u&&J+Ie>=N){u=Y,F=N-J;break}J+=Ie}const we=document.createRange();we.setStart(ce,re),we.setEnd(u,F);const Oe=document.createRange();Oe.setStart(d,0),Oe.setEnd(ce,re);const Le=document.createRange();return Le.setStart(u,F),Le.setEnd(d,d.childNodes.length),[V(Oe),V(we),V(Le)]},V=d=>{const y=document.createElement("div");return y.appendChild(d.cloneContents()),y.innerHTML},Se=d=>{const y=p.paragraphLists[d].content,I=window.getSelection().getRangeAt(0);I.toString()&&be.confirm({title:"单独分段",icon:t(Ee),content:"确认将该分段内容单独分段么？分段后，原分段的内容会被删除",onOk(){const Y=document.createElement("div");Y.innerHTML=y;const[J,ce,u]=G(Y,I.startOffset,I.endOffset),re=J.replace(/<[^>]+>/g,"").trim()==="",F=u.replace(/<[^>]+>/g,"").trim()==="";re&&F?_("handleSplit",{index:d,beforeContent:"",selectedContent:ce,afterContent:"",isFullSelection:!0}):_("handleSplit",{index:d,beforeContent:J,selectedContent:ce,afterContent:u,originalSelection:{start:I.startOffset,end:I.endOffset,parentIndex:d}})}})},x=d=>{if(d>=p.paragraphLists.length-1)return ve.error("没有下一个分段");const y=p.paragraphLists[d].content,I=window.getSelection().getRangeAt(0);I.toString()&&be.confirm({title:"合并到下一个分段",icon:t(Ee),content:"确认将该分段内容合并到下一个分段么？分段后，原分段的内容会被删除",onOk(){const Y=document.createElement("div");Y.innerHTML=y;const[J,ce,u]=G(Y,I.startOffset,I.endOffset),re=J.replace(/<[^>]+>/g,"").trim()==="",F=u.replace(/<[^>]+>/g,"").trim()==="";re&&F?_("handleSplitNext",{index:d,beforeContent:"",selectedContent:ce,afterContent:"",isFullSelection:!0}):_("handleSplitNext",{index:d,beforeContent:J,selectedContent:ce,afterContent:u,originalSelection:{start:I.startOffset,end:I.endOffset,parentIndex:d}})}})},me=d=>{if(d<=0)return ve.error("没有上一个分段");const y=p.paragraphLists[d].content,I=window.getSelection().getRangeAt(0);I.toString()&&be.confirm({title:"合并到上一个分段",icon:t(Ee),content:"确认将该分段内容合并到上一个分段么？分段后，原分段的内容会被删除",onOk(){const Y=document.createElement("div");Y.innerHTML=y;const[J,ce,u]=G(Y,I.startOffset,I.endOffset),re=J.replace(/<[^>]+>/g,"").trim()==="",F=u.replace(/<[^>]+>/g,"").trim()==="";re&&F?_("handleSplitUp",{index:d,beforeContent:"",selectedContent:ce,afterContent:"",isFullSelection:!0}):_("handleSplitUp",{index:d,beforeContent:J,selectedContent:ce,afterContent:u,originalSelection:{start:I.startOffset,end:I.endOffset,parentIndex:d}})}})},Re=d=>{const y=p.paragraphLists[d].content,I=window.getSelection().getRangeAt(0);I.toString()&&be.confirm({title:"删除",icon:t(Ee),content:"确认将该分段内容删除么？",onOk(){const Y=document.createElement("div");Y.innerHTML=y;const[J,ce,u]=G(Y,I.startOffset,I.endOffset),re=J.replace(/<[^>]+>/g,"").trim()==="",F=u.replace(/<[^>]+>/g,"").trim()==="";re&&F?_("handleSplitDelete",{index:d,beforeContent:"",selectedContent:"",afterContent:"",isFullSelection:!0}):_("handleSplitDelete",{index:d,beforeContent:J,selectedContent:"",afterContent:u,originalSelection:{start:I.startOffset,end:I.endOffset,parentIndex:d}})}})},$e=d=>{O.value&&!d.target.closest(".bubble-card")&&(O.value=!1)};return Ue(()=>{document.addEventListener("click",$e)}),Bt(()=>{document.removeEventListener("click",$e)}),se({handleOpenEditModal:R}),(d,y)=>{const N=Ye,I=dt,X=_t,Y=pt,J=Xe,ce=rt("viewer");return o(),v("div",{class:"subsection-box content-container",ref_key:"containerRef",ref:h},[n("div",to,[E(" 分段预览 "),n("span",null,"共"+K(p.total)+"个分段",1)]),(o(!0),v(pe,null,xe(p.paragraphLists,(u,re)=>(o(),v("div",{class:"list-item",key:u.id,onClick:ye(F=>D(u,re,F),["stop"]),style:De({"--status-color":te(u)})},[n("div",ao,[n("div",oo,[E(" 分段"+K(re+1)+" ",1),n("div",lo,K(u.title),1),n("span",null,"共"+K(u.word_total)+"个字符",1),n("span",so,[E(" 嵌入状态："+K(u.status_text),1),u.status==3?(o(),Q(oe(wn),{key:0})):U("",!0),u.status==2&&u.errmsg?(o(),Q(N,{key:1,title:u.errmsg},{default:a(()=>[n("strong",io,[E("原因"),t(oe(Ee),{class:"err-icon cfb363f"})])]),_:2},1032,["title"])):U("",!0),u.split_status==4&&u.split_err_msg?(o(),Q(N,{key:2,title:u.split_err_msg},{default:a(()=>[n("div",co,[t(oe(xn),{style:{"margin-left":"0"},class:"cfb363f"}),E(" 分段失败 ")])]),_:2},1032,["title"])):U("",!0)]),$.detailsInfo.graph_switch?(o(),v("span",ro,[E(" 知识图谱状态："+K(u.graph_status_text)+" ",1),u.graph_status==3&&u.graph_err_msg?(o(),Q(N,{key:0,title:u.graph_err_msg},{default:a(()=>[n("strong",uo,[E("原因"),t(oe(Ee),{class:"err-icon cfb363f"})])]),_:2},1032,["title"])):U("",!0)])):U("",!0)]),n("div",_o,[t(Y,null,{overlay:a(()=>[t(X,null,{default:a(()=>[(o(!0),v(pe,null,xe(g.value,F=>(o(),Q(I,{key:F.id},{default:a(()=>[n("div",{class:"start-item",onClick:ye(we=>c(u,F),["stop"])},[t(oe(Ze),{style:De({color:oe(Ke)[F.type]})},null,8,["style"]),n("div",null,K(F.name||"-"),1)],8,fo)]),_:2},1024))),128)),t(I,null,{default:a(()=>[n("div",{class:"start-item",onClick:ye(q,["stop"])},[t(oe(Gt)),mo])]),_:1})]),_:2},1024)]),default:a(()=>[n("div",po,[u.category_id>0?(o(),Q(oe(Ze),{key:0,onClick:ye(F=>c(u,{}),["stop"]),style:De({color:te(u),"font-size":"16px"})},null,8,["onClick","style"])):(o(),Q(oe(Jt),{key:1,onClick:F=>c(u,g.value[0]),style:{"font-size":"16px",color:"#595959"}},null,8,["onClick"]))])]),_:2},1024),t(N,null,{title:a(()=>[E("重新分段")]),default:a(()=>[n("div",{class:"hover-btn-box",onClick:ye(F=>B(u),["stop"])},[t(J,{name:"segmentation-icon",style:{"font-size":"16px"}})],8,vo)]),_:2},1024),$.detailsInfo.graph_switch?(o(),Q(N,{key:0},{title:a(()=>[E("知识图谱")]),default:a(()=>[n("div",{class:"hover-btn-box",onClick:F=>k(u)},[t(J,{name:"graph-icon",style:{"font-size":"16px",color:"#595959"}})],8,ho)]),_:2},1024)):U("",!0),t(N,null,{title:a(()=>[E("重新转换")]),default:a(()=>[n("div",go,[t(oe(Vt),{onClick:ye(F=>f(u,re),["stop"])},null,8,["onClick"])])]),_:2},1024),t(Y,{placement:"bottomRight"},{overlay:a(()=>[t(X,null,{default:a(()=>[t(I,null,{default:a(()=>[n("div",{onClick:ye(F=>R(u),["stop"])},"编辑",8,yo)]),_:2},1024),t(I,null,{default:a(()=>[n("div",{onClick:ye(F=>P(u.id),["stop"])},"删除",8,bo)]),_:2},1024)]),_:2},1024)]),default:a(()=>[n("div",ko,[t(oe(Wt),{style:{"font-size":"16px",color:"#595959"}})])]),_:2},1024)])]),u.question?(o(),v("div",So,"Q："+K(u.question),1)):U("",!0),u.answer?(o(),v("div",wo,"A："+K(u.answer),1)):U("",!0),n("div",{class:"content-box",onMouseup:ye(F=>H(F,re),["stop"]),innerHTML:u.content},null,40,xo),u.images.length>0?ut((o(),v("div",$o,[(o(!0),v(pe,null,xe(u.images,(F,we)=>(o(),v("img",{key:we,src:F,alt:""},null,8,Co))),128))])),[[ce]]):U("",!0)],12,no))),128)),t(jt,{onOk:ee,ref_key:"classificationMarkModalRef",ref:S},null,512),t(Ya,{ref_key:"graphModelRef",ref:r},null,512),O.value?(o(),v("div",{key:0,class:"bubble-card",style:De(ie.value)},[n("button",{class:"bubble-item",onClick:y[0]||(y[0]=ye(u=>z("separate"),["stop"]))},[t(J,{name:"segmentation",style:{"font-size":"16px",color:"#262626","margin-right":"4px"}}),E(" 单独成段 ")]),n("button",{class:"bubble-item",onClick:y[1]||(y[1]=ye(u=>z("merge-prev"),["stop"]))},[t(J,{name:"segmentation-up",style:{"font-size":"16px",color:"#262626","margin-right":"4px"}}),E(" 合并到上一分段 ")]),n("button",{class:"bubble-item",onClick:y[2]||(y[2]=ye(u=>z("merge-next"),["stop"]))},[t(J,{name:"segmentation-down",style:{"font-size":"16px",color:"#262626","margin-right":"4px"}}),E(" 合并到下一分段 ")]),n("button",{class:"bubble-item",onClick:y[3]||(y[3]=ye(u=>z("delete"),["stop"]))},[t(J,{name:"delete",style:{"font-size":"16px",color:"#262626","margin-right":"4px"}}),E(" 删除 ")])],4)):U("",!0)],512)}}},Rt=Ce(Lo,[["__scopeId","data-v-1dcfe3b0"]]),qo={class:"mode-box"},Oo=["innerHTML"],Io={class:"tag-item"},Eo={__name:"segmentation-mode",props:{detailsInfo:{type:Object}},setup($){const se=$,C=s(""),j=ke(()=>{const{is_table_file:_,is_qa_doc:p,is_diy_split:f,question_lable:R,answer_lable:P,separators:D,chunk_size:B,chunk_overlap:g,question_column:ee,answer_column:S,qa_index_type:q,doc_type:te}=se.detailsInfo;if(_!=1&&p!=1&&f!=1)return te==3?(C.value=`分段模式：手动分段
文档类型：普通文档`,"自定义：普通文档"):(C.value=`分段模式：智能分段
文档类型：普通文档`,"智能分段：普通文档");if(_!=1&&p==1)return te==3?(C.value=`分段模式：手动分段
文档类型：QA文档`,"自定义：QA文档"):(C.value=`分段模式：智能分段
文档类型：QA文档
问题开始标识符："${R}"
答案开始标识符："${P}"`,"智能分段：QA文档");if(_!=1&&p!=1&&f==1)return C.value=`分段模式：自定义分段
文档标识符：${D}
分段最大长度：${B}字符
文段重叠长度：${g}字符`,"自定义分段";if(_==1&&p!=1)return C.value=`分段模式：智能分段
文档类型：普通表格`,"智能分段：普通表格";if(_==1&&p==1){let c=q==1?"问题与答案一起生成索引":"仅对问题生成索引";return C.value=`分段模式：智能分段
文档类型：QA文档
问题所在列："${ee}"
答案所在列："${S}"
索引方式：${c}`,"智能分段：QA文档"}});return(_,p)=>{const f=Ye;return o(),v("div",qo,[t(f,null,{title:a(()=>[n("div",{class:"tooltip-text-box",innerHTML:C.value},null,8,Oo)]),default:a(()=>[n("div",Io,K(j.value),1)]),_:1})])}}},To=Ce(Eo,[["__scopeId","data-v-e8649c10"]]),Ro={__name:"update-frequency",emits:["ok"],setup($,{expose:se,emit:C}){const j=C,_=s(!1),p=s(!1),f=qe({doc_auto_renew_frequency:1,id:""}),R=D=>{let{doc_auto_renew_frequency:B,id:g}=D;f.doc_auto_renew_frequency=+B,f.id=g,_.value=!0},P=()=>{p.value=!0,$n({...f}).then(D=>{j("ok",f.doc_auto_renew_frequency),_.value=!1,ve.success("设置成功")}).finally(()=>{p.value=!1})};return se({open:R}),(D,B)=>{const g=Zt,ee=Kt,S=Kn,q=Xn,te=be;return o(),v("div",null,[t(te,{open:_.value,"onUpdate:open":B[1]||(B[1]=c=>_.value=c),"confirm-loading":p.value,maskClosable:!1,title:"设置更新频率",onOk:P},{default:a(()=>[t(q,{style:{margin:"32px 0"},layout:"vertical",model:f},{default:a(()=>[t(S,{name:"doc_auto_renew_frequency",label:"更新频率",required:""},{default:a(()=>[t(ee,{value:f.doc_auto_renew_frequency,"onUpdate:value":B[0]||(B[0]=c=>f.doc_auto_renew_frequency=c),style:{width:"100%"}},{default:a(()=>[t(g,{value:1},{default:a(()=>[E("不自动更新")]),_:1}),t(g,{value:2},{default:a(()=>[E("每天")]),_:1}),t(g,{value:3},{default:a(()=>[E("每3天")]),_:1}),t(g,{value:4},{default:a(()=>[E("每7天")]),_:1}),t(g,{value:5},{default:a(()=>[E("每30天")]),_:1})]),_:1},8,["value"])]),_:1})]),_:1},8,["model"])]),_:1},8,["open","confirm-loading"])])}}},Mo={class:"loading"},Po={__name:"pdf-preview",props:{source:{type:[String],required:!0},pageSize:{type:Number,default:10}},emits:["onScrollEnd","select","rendered","scroll","getTotalPage"],setup($,{expose:se,emit:C}){const j=$,_=C,p=s(null),f=s([]),R=s(0),P=s(!1),D=ke(()=>P.value?null:{"border-bottom":"2px solid #d9d9d9"}),B=s({fade:!1,scrollbarTrackClickable:!0,interactive:!0,minSize:40});Ue(async()=>{const r=await Et.getDocument(j.source).promise;R.value=r.numPages,_("getTotalPage",R.value),g()});const g=(r=null)=>{const k=f.value.length;if(k>=R.value||P.value)return;P.value=!0;const h=[];for(let O=1;O<=j.pageSize&&k+O<=R.value;O++)h.push(k+O);f.value.push(...h),We(()=>{typeof r=="function"&&r()})},ee=r=>{g(),_("onScrollEnd",r)},S=r=>{We(()=>{r===f.value[f.value.length-1]&&(P.value=!1,_("rendered",r,R.value))})},q=r=>{_("select",r)},te=()=>p.value,c=r=>{_("scroll",r)};return se({loadMore:g,getScrollInstance:te}),(r,k)=>{const h=Je;return o(),Q(He,{scrollbar:B.value,ref_key:"scrollRef",ref:p,onScroll:c,onOnScrollEnd:ee},{default:a(()=>[(o(!0),v(pe,null,xe(f.value,O=>(o(),Q(oe(Et),{onClick:ne=>q(O),key:O,source:$.source,page:O,onRendered:()=>S(O),style:De(D.value)},null,8,["onClick","source","page","onRendered","style"]))),128)),n("div",Mo,[P.value?(o(),Q(h,{key:0})):U("",!0)])]),_:1},8,["scrollbar"])}}},Do=Ce(Po,[["__scopeId","data-v-8520f2eb"]]),Fo=$=>(Fe("data-v-3bdce118"),$=$(),ze(),$),zo={key:0,class:"loading-wrap"},No={class:"document-segmentation"},Ao={class:"page-container"},Bo={class:"page-left"},Ho={class:"page-right"},Uo={class:"document-fragment-preview"},Qo={class:"preview-header"},Jo=Fo(()=>n("span",{class:"label-text"},"分段预览",-1)),jo={class:"fragment-number"},Go={key:1,class:"loading-box"},Vo="你是一位文章分段助手，根据文章内容的语义进行合理分段，确保每个分段表述一个完整的语义，每个分段字数控制在500字左右，最大不超过1000字。请严格按照文章内容进行分段，不要对文章内容进行加工，分段完成后输出分段后的内容。",Wo={__name:"document-segmentation-model",props:{pdfState:{type:Object,default:()=>{}},currentData:{type:Object,default:()=>{}},paragraphType:{type:String,default:""}},emits:["ok","finish","loading"],setup($,{expose:se,emit:C}){const j=Cn(),{setInitDocumentFragmentList:_}=j,p=Qe(),f=C,{id:R}=p.query,P=s(!0),D=s(1);let B=!1;const g=$,ee=s(1);let S={id:R,separators_no:"",chunk_size:512,chunk_overlap:50,is_qa_doc:0,question_lable:"",answer_lable:"",enable_extract_image:!0,ai_chunk_size:5e3,ai_chunk_model:"",ai_chunk_model_config_id:"",ai_chunk_prumpt:Vo,ai_chunk_task_id:""};const q=s(null),te=l=>{typeof l.separators_no=="object"&&(l.separators_no=l.separators_no.join(",")),S={...S,...l},B?be.confirm({title:"提醒",icon:t(Ee),content:"文档片段已被编辑重新获取文档片段会丢失当前修改过的文档片段内容，确定要重新获取吗？",okText:"确定",okType:"danger",cancelText:"取消",onOk(){B=!1,me("create")},onCancel(){}}):(B=!1,me("create"))};let c=60*10,r=0;const k=s({}),h=s(0),O=()=>{P.value||(P.value=!0),Nt({id:R}).then(async l=>{const{status:M}=l.data;if(h.value=l.data.library_type,k.value=l.data,S={...S,separators_no:l.data.separators_no||"11,12",chunk_size:+l.data.chunk_size||512,ai_chunk_size:+l.data.ai_chunk_size||5e3,chunk_overlap:+l.data.chunk_overlap||50,is_qa_doc:h.value==2?1:0,question_lable:l.data.question_lable,answer_lable:l.data.answer_lable,question_column:l.data.question_column,answer_column:l.data.answer_column,enable_extract_image:l.data.enable_extract_image=="true",qa_index_type:+l.data.qa_index_type,chunk_type:+l.data.chunk_type,semantic_chunk_size:+l.data.semantic_chunk_size||512,semantic_chunk_overlap:+l.data.semantic_chunk_overlap||50,semantic_chunk_threshold:+l.data.semantic_chunk_threshold||90,semantic_chunk_use_model:l.data.semantic_chunk_use_model||"",ai_chunk_prumpt:l.data.ai_chunk_prumpt||"",ai_chunk_model:l.data.ai_chunk_model||"",semantic_chunk_model_config_id:l.data.semantic_chunk_model_config_id>0?l.data.semantic_chunk_model_config_id:"",ai_chunk_model_config_id:l.data.ai_chunk_model_config_id>0?l.data.ai_chunk_model_config_id:"",ai_chunk_task_id:l.data.ai_chunk_task_id||""},l.data.chunk_type==0&&(S={...S,separators_no:l.data.normal_chunk_default_separators_no,chunk_size:l.data.normal_chunk_default_chunk_size,chunk_overlap:l.data.normal_chunk_default_chunk_overlap,chunk_type:+l.data.default_chunk_type,semantic_chunk_size:+l.data.semantic_chunk_default_chunk_size,semantic_chunk_overlap:+l.data.semantic_chunk_default_chunk_overlap,semantic_chunk_threshold:+l.data.semantic_chunk_default_threshold,semantic_chunk_use_model:l.data.default_use_model||"",semantic_chunk_model_config_id:l.data.default_model_config_id>0?l.data.default_model_config_id:""}),M==0){if(r++,r>c){be.error({title:"提醒",content:"文档解析速度慢请稍后再试"});return}setTimeout(()=>{O()},1e3)}else(M==4||M==2)&&(P.value=!1,D.value=parseInt(l.data.is_table_file),l.data.library_id,h.value==2?(S.question_lable||S.question_column)&&me():me());l.data.is_table_file==1&&fe()})};Ue(async()=>{await O()});const ne=s([]),fe=()=>{Ln({id:R}).then(l=>{let M=[];for(let ae in l.data)M.push({lable:l.data[ae],value:ae});ne.value=M})},b=s([]),he=s(!1),ie=s(!1),H=s(""),z=s(null);let G=null;const V=s([]),Se=s(0),x=ke(()=>Se.value<=0),me=l=>{var ue;f("loading",!0);let M={...S,semantic_chunk_model_config_id:S.semantic_chunk_model_config_id?+S.semantic_chunk_model_config_id:0,ai_chunk_model_config_id:S.ai_chunk_model_config_id?+S.ai_chunk_model_config_id:0,...g.pdfState};S.chunk_type==3&&(S.ai_chunk_task_id&&!l&&(M.ai_chunk_task_id=S.ai_chunk_task_id),M.ai_chunk_task_id&&l&&l==="create"&&delete M.ai_chunk_task_id);let ae=On;return g.paragraphType&&g.paragraphType==="paragraphsSegmented"&&l=="create"&&(ae=In,delete M.id),g.paragraphType&&g.paragraphType==="paragraphsSegmented"&&!l?(V.value=g.currentData.list||[],Se.value=g.currentData.list.length,S.chunk_type==3&&(H.value=((ue=g.currentData.split_params)==null?void 0:ue.ai_chunk_task_id)||"",ie.value=!0,q.value.reLoading=!0,z.value=null,!S.ai_chunk_task_id&&D.value!=1||l&&l==="create"?(V.value=[],Se.value=0,y()):(ie.value=!1,q.value.reLoading=!1)),S.chunk_type!=3&&(q.value.reLoading=!1,q.value.saveLoading=!1),f("loading",!1),!1):ae(M).then(_e=>{var Te;b.value=_e.data.list||[],_(b.value),V.value=_e.data.list||[],Se.value=_e.data.list.length||0,S.chunk_type==3&&(H.value=((Te=_e.data.split_params)==null?void 0:Te.ai_chunk_task_id)||"",ie.value=!0,q.value.reLoading=!0,q.value.saveLoading=!0,z.value=null,!S.ai_chunk_task_id&&D.value!=1||l&&l==="create"?(V.value=[],Se.value=0,y()):(ie.value=!1,q.value.reLoading=!1,q.value.saveLoading=!1))}).finally(()=>{S.chunk_type!=3&&(q.value.reLoading=!1,q.value.saveLoading=!1),f("loading",!1)})},Re=l=>{ee.value=l},$e=async()=>{var l;try{const M=await N();return M.data.err_msg?(z.value=M.data.err_msg,!0):((l=M.data.list)==null?void 0:l.length)>0?(b.value=M.data.list||[],_(b.value),V.value=M.data.list||[],Se.value=M.data.list.length||0,!0):!1}catch{return z.value="请求异常，停止轮询",!0}};function d(l){return l.split("message:")[1]}const y=()=>{const l=async()=>{if(!await $e())G=setTimeout(l,3e3);else if(ie.value=!1,q.value.reLoading=!1,q.value.saveLoading=!1,G!==null&&(clearTimeout(G),G=null),he.value&&Le(),z.value){let ae=d(z.value);be.error({title:"分段失败提示",content:ae?`模型调用失败，失败原因：${ae}`:"模型调用失败"})}};l()},N=()=>En({id:S.id,task_id:H.value}),I=s(null);let X=null;const Y=({title:l,content:M,question:ae,answer:ue,images:_e},Te)=>{X=Te,I.value.open({title:l,content:M,question:ae,answer:ue,images:_e})},J=({title:l,content:M,question:ae,answer:ue,images:_e})=>{(V.value[X].title!=l||V.value[X].content!=M||V.value[X].question!=ae||V.value[X].answer!=ue)&&(B=!0),V.value[X].title=l,V.value[X].content=M,V.value[X].question=ae,V.value[X].answer=ue,V.value[X].images=_e,V.value[X].word_total=ue.length+ae.length+M.length},ce=l=>{be.confirm({title:"提醒",icon:t(Ee),content:"确定要删除这个片段吗?",okText:"确定",okType:"danger",cancelText:"取消",onOk(){B=!0,V.value.splice(l,1)},onCancel(){}})},u=s(""),re=l=>{u.value=l},F=s(!1),we=()=>{let l=q.value.formState;l=JSON.parse(JSON.stringify(l)),typeof l.separators_no=="object"&&(l.separators_no=l.separators_no.join(",")),S={...S,...l}},Oe=l=>{let M=0;return l.forEach(ae=>{M+=parseInt(ae.word_total)}),M},Le=async()=>{if((Se.value<=0||S.chunk_type!=ee.value)&&(we(),await me()),we(),u.value)return ve.error(u.value);if(S.chunk_type==3&&!V.value.length)return he.value=!0,!1;H.value&&(S.ai_chunk_task_id=H.value);let l={...S,semantic_chunk_model_config_id:S.semantic_chunk_model_config_id?+S.semantic_chunk_model_config_id:0,ai_chunk_model_config_id:S.ai_chunk_model_config_id?+S.ai_chunk_model_config_id:0,is_table_file:D.value,...g.pdfState};delete l.id;let M={file_id:R,word_total:Oe(V.value),split_params:JSON.stringify(l),list:JSON.stringify(V.value),...g.pdfState};l.is_qa_doc==1&&(M.qa_index_type=l.qa_index_type),F.value=!0,g.paragraphType&&g.paragraphType==="paragraphsSegmented"&&(M.data_id=M.data_ids,delete M.data_ids),qn(M).then(()=>{f("ok"),f("finish")}).finally(()=>{F.value=!1}).catch(ae=>{ae.data&&ae.data.index&&nt(ae.data.index),f("finish")})},Ie=s(null),nt=l=>{l=l-1;let M=Ie.value.querySelectorAll(".fragment-item");M.length>=l&&M[l].scrollIntoView({behavior:"smooth",block:"start",inline:"nearest"})};return Bt(()=>{G&&(clearTimeout(G),G=null)}),se({handleSaveLibFileSplit:Le}),(l,M)=>{const ae=Je;return o(),v(pe,null,[P.value?(o(),v("div",zo,[t(ae)])):U("",!0),n("div",No,[n("div",Ao,[n("div",Bo,[t(ea,{excellQaLists:ne.value,libFileInfo:k.value,library_type:h.value,mode:D.value,hideSave:!0,status:"paragraphsSegmented",ref_key:"segmentationSettingRef",ref:q,onChange:te,onChangeChunkType:Re,onSave:Le,onValidate:re},null,8,["excellQaLists","libFileInfo","library_type","mode"])]),n("div",Ho,[n("div",Uo,[n("div",Qo,[Jo,n("span",jo,"共"+K(Se.value)+"个分段",1)]),x.value&&!ie.value?(o(),Q(ta,{key:0})):U("",!0),ie.value?(o(),v("div",Go,[t(ae),E("数据处理中...")])):U("",!0),n("div",{class:"preview-box",ref_key:"previewBoxRef",ref:Ie},[(o(!0),v(pe,null,xe(V.value,(ue,_e)=>(o(),v("div",{class:"fragment-item",key:ue.number},[t(na,{status:"paragraphsSegmented",currentData:$.currentData,number:ue.number,title:ue.title,content:ue.content,total:ue.word_total,question:ue.question,answer:ue.answer,images:ue.images,onDelete:Te=>ce(_e),onEdit:Te=>Y(ue,_e)},null,8,["currentData","number","title","content","total","question","answer","images","onDelete","onEdit"])]))),128))],512)])])]),t(aa,{ref_key:"editFragmentAlertRef",ref:I,onOk:J},null,512)])],64)}}},Xt=Ce(Wo,[["__scopeId","data-v-3bdce118"]]),Zo={class:"select-box"},Ko=["onClick"],Xo={class:"title"},Yo={class:"desc"},el={key:0,class:"card-switch"},tl={class:"main-content-box"},nl={__name:"re-segmentation-page",props:{detailsInfo:{type:Object,default:()=>{}}},emits:["ok","enable"],setup($,{expose:se,emit:C}){const j=At(),_=ke(()=>{var z;return((z=j.companyInfo)==null?void 0:z.ali_ocr_switch)=="1"}),p=Qe().query,f=Ht(),R=$,P=s(!1),D=s(!1),B=s(""),g=C;let ee={};const S=s([{title:"图文OCR解析",desc:"通过OCR文字识别提取pdf文件内容，可以兼容扫描件，但是解析速度较慢。",icon:"pdf-ocr",pdf_parse_type:2},{title:"纯文本解析",desc:"只提取Pdf中的文字内容，如果文档为扫描件可能提取不到内容。",icon:"pdf-text",pdf_parse_type:1},{title:"图文解析",desc:"提取PDF文档中的图片和文字",icon:"pdf-img",pdf_parse_type:3}]),q=qe({pdf_parse_type:2,pdf_page_num:0}),te=()=>{S.value=S.value.filter(z=>z.pdf_parse_type!=4),g("enable")},c=s(!1),r=z=>{c.value=z},k=z=>{ee={...z},q.pdf_parse_type=2,q.pdf_page_num=z.pdf_page_num,z.type==1&&(B.value=`当页(${z.pdf_page_num})重新分段`),z.type==2&&(B.value="将文档重新分段"),z.type==3&&(B.value="重新学习文档",S.value.push({title:"阿里云OCR解析",desc:"通过阿里云文档智能接口解析提取图片和文字",icon:"ali-ocr",pdf_parse_type:4})),P.value=!0},h=()=>{window.open("#/user/aliocr")},O=z=>{if(z.pdf_parse_type==4&&!_.value)return!1;q.pdf_parse_type=z.pdf_parse_type},ne=s(!1),fe=()=>{if(ee.type==3){if(q.pdf_parse_type==1){f.push("/library/document-segmentation?document_id="+p.id+"&source=preview");return}ne.value=!0,Tn({id:p.id,pdf_parse_type:q.pdf_parse_type}).then(z=>{ve.success("重新学习成功"),(q.pdf_parse_type==2||q.pdf_parse_type==3||q.pdf_parse_type==4)&&f.push({path:"/library/details/knowledge-document",query:{id:R.detailsInfo.library_id}}),q.pdf_parse_type==1&&f.push("/library/document-segmentation?document_id="+p.id+"&source=preview"),P.value=!1}).finally(()=>{ne.value=!1});return}P.value=!1,D.value=!0},b=s(null),he=()=>{ne.value=!0,b.value.handleSaveLibFileSplit()},ie=()=>{ve.success("保存成功"),D.value=!1,g("ok",ee.type)},H=()=>{ne.value=!1};return se({show:k}),(z,G)=>{const V=Xe,Se=be;return o(),v("div",null,[t(Se,{open:P.value,"onUpdate:open":G[0]||(G[0]=x=>P.value=x),title:B.value,onOk:fe,onCancel:te,width:720,confirmLoading:ne.value},{default:a(()=>[n("div",Zo,[(o(!0),v(pe,null,xe(S.value,x=>(o(),v("div",{class:Ut(["select-list-item",{active:x.pdf_parse_type==q.pdf_parse_type},{disabled:x.pdf_parse_type==4&&!_.value}]),onClick:me=>O(x),key:x.pdf_parse_type},[n("div",Xo,[t(V,{name:x.icon,style:{"font-size":"16px"}},null,8,["name"]),E(" "+K(x.title),1)]),n("div",Yo,K(x.desc),1),x.pdf_parse_type==4&&!_.value?(o(),v("div",el,[E(" 未开启阿里云OCR "),n("div",{class:"card-switch-btn",onClick:ye(h,["stop"])},"去开启")])):U("",!0)],10,Ko))),128))])]),_:1},8,["open","title","confirmLoading"]),t(Se,{open:D.value,"onUpdate:open":G[1]||(G[1]=x=>D.value=x),onCancel:te,title:B.value,maskClosable:!1,"ok-text":c.value?"文档解析中,请稍候...":"确定",confirmLoading:ne.value||c.value,onOk:he,width:1e3},{default:a(()=>[n("div",tl,[D.value?(o(),Q(Xt,{key:0,onOk:ie,onFinish:H,onLoading:r,pdfState:q,ref_key:"documentSegmentationModalRef",ref:b},null,8,["pdfState"])):U("",!0)])]),_:1},8,["open","title","ok-text","confirmLoading"])])}}},al=Ce(nl,[["__scopeId","data-v-ed67085d"]]),et=$=>(Fe("data-v-55ca1dad"),$=$(),ze(),$),ol={class:"subsection-box"},ll={class:"qa-list-box"},sl={class:"list-item"},il=et(()=>n("div",{class:"list-label"},"问题",-1)),cl={class:"list-content"},rl={key:0,class:"list-item"},ul=et(()=>n("div",{class:"list-label"},"相似问法",-1)),dl={class:"list-content"},_l={class:"list-item"},pl=et(()=>n("div",{class:"list-label"},"答案",-1)),fl={class:"list-content"},ml={class:"fragment-img"},vl=["src"],hl={key:0,class:"status-tag"},gl={key:1,class:"status-tag complete"},kl={class:"status-tag status-error"},yl={key:3,class:"status-tag running"},bl={class:"right-opration"},Sl={class:"hover-btn-box"},wl=["onClick"],xl=et(()=>n("div",null,"标记设置",-1)),$l=["onClick"],Cl={class:"hover-btn-box"},Ll=["onClick"],ql=["onClick"],Ol={__name:"qa-subsection-box",props:{paragraphLists:{type:Array,default:()=>[]},total:{type:[Number,String],default:0}},emits:["handleDelParagraph","handleScrollTargetPage","openEditSubscription","handleConvert","getStatrList"],setup($,{expose:se,emit:C}){const _=Qe().query,p=C,f=$,R=(c,r)=>{let{id:k,title:h,content:O,question:ne,answer:fe,images:b,category_id:he}=c,ie=c.similar_questions||[];be.confirm({title:"重新转换确认",icon:null,content:`确定要重新转换【分段${r+1}】吗?`,onOk(){return new Promise((H,z)=>{Pt({id:k,title:h,content:O,question:ne,answer:fe,images:b,category_id:he,similar_questions:JSON.stringify(ie)}).then(G=>{p("handleConvert",c),H()}).catch(()=>{H()})})},onCancel(){}})},P=c=>{p("openEditSubscription",c)},D=c=>{be.confirm({title:"提示",icon:t(Ee),content:"确认是否删除该分段?",onOk(){return new Promise((r,k)=>{Dt({id:c}).then(h=>{ve.success("删除成功"),p("handleDelParagraph",c),r()}).catch(()=>{r()})})},onCancel(){}})},B=s([]),g=()=>{let c={};_.id&&(c.file_id=_.id),Ft(c).then(r=>{B.value=r.data||[],p("getStatrList",r.data||[])})};g();const ee=s(null),S=()=>{ee.value.show()},q=c=>{var k;let r=(k=B.value.filter(h=>h.id==c.category_id)[0])==null?void 0:k.type;return r?Ke[r]:"#F4EA2A"},te=(c,r={})=>{zt({id:c.id,category_id:r.id||0}).then(k=>{ve.success("设置成功"),c.category_id=r.id,g()})};return se({handleOpenEditModal:P}),(c,r)=>{const k=la,h=Ye,O=Je,ne=dt,fe=_t,b=pt,he=sa,ie=rt("viewer");return o(),v("div",ol,[t(he,{"data-source":$.paragraphLists,pagination:!1},{default:a(()=>[t(k,{key:"id","data-index":"id",width:1148},{title:a(()=>[E("问答（共"+K(f.total)+"个）",1)]),default:a(({record:H})=>[n("div",ll,[n("div",sl,[il,n("div",cl,K(H.question),1)]),H.similar_questions&&H.similar_questions.length?(o(),v("div",rl,[ul,n("div",dl,K(H.similar_questions.join("/")),1)])):U("",!0),n("div",_l,[pl,n("div",fl,K(H.answer),1)]),ut((o(),v("div",ml,[(o(!0),v(pe,null,xe(H.images,(z,G)=>(o(),v("img",{key:G,src:z,alt:""},null,8,vl))),128))])),[[ie]])])]),_:1}),t(k,{title:"嵌入状态",key:"status_text","data-index":"status_text",width:128},{default:a(({record:H})=>[H.status==0?(o(),v("span",hl,[t(oe(oa)),E(" 未转换")])):U("",!0),H.status==1?(o(),v("span",gl,[t(oe(Rn)),E(" 已转换")])):U("",!0),H.status==2?(o(),Q(h,{key:2,placement:"top"},{title:a(()=>[n("span",null,K(H.errmsg),1)]),default:a(()=>[n("span",null,[n("span",kl,[t(oe(Mn)),E(" 转换异常")])])]),_:2},1024)):U("",!0),H.status==3?(o(),v("span",yl,[t(O,{size:"small"}),E(" 转换中")])):U("",!0)]),_:1}),t(k,{title:"操作",key:"action","data-index":"action",width:120},{default:a(({record:H,index:z})=>[n("div",bl,[t(b,null,{overlay:a(()=>[t(fe,null,{default:a(()=>[(o(!0),v(pe,null,xe(B.value,G=>(o(),Q(ne,{key:G.id},{default:a(()=>[n("div",{class:"start-item",onClick:V=>te(H,G)},[t(oe(Ze),{style:De({color:oe(Ke)[G.type]})},null,8,["style"]),n("div",null,K(G.name||"-"),1)],8,wl)]),_:2},1024))),128)),t(ne,null,{default:a(()=>[n("div",{class:"start-item",onClick:S},[t(oe(Gt)),xl])]),_:1})]),_:2},1024)]),default:a(()=>[n("div",Sl,[H.category_id>0?(o(),Q(oe(Ze),{key:0,onClick:G=>te(H,{}),style:De({color:q(H),"font-size":"16px"})},null,8,["onClick","style"])):(o(),Q(oe(Jt),{key:1,onClick:G=>te(H,B.value[0]),style:{"font-size":"16px"}},null,8,["onClick"]))])]),_:2},1024),t(h,null,{title:a(()=>[E("重新转换")]),default:a(()=>[n("div",{class:"hover-btn-box",onClick:G=>R(H,z)},[t(oe(Vt))],8,$l)]),_:2},1024),t(b,{placement:"bottomRight"},{overlay:a(()=>[t(fe,null,{default:a(()=>[t(ne,null,{default:a(()=>[n("div",{onClick:ye(G=>P(H),["stop"])},"编辑",8,Ll)]),_:2},1024),t(ne,null,{default:a(()=>[n("div",{onClick:ye(G=>D(H.id),["stop"])},"删除",8,ql)]),_:2},1024)]),_:2},1024)]),default:a(()=>[n("div",Cl,[t(oe(Wt))])]),_:2},1024)])]),_:1})]),_:1},8,["data-source"]),t(jt,{onOk:g,ref_key:"classificationMarkModalRef",ref:ee},null,512)])}}},Il=Ce(Ol,[["__scopeId","data-v-55ca1dad"]]),El={class:"main-content-box"},Tl={__name:"segmentation-setting-modal",emits:["ok","enable"],setup($,{expose:se,emit:C}){const j=s(!1),_=s("重新分段"),p=C;let f={};const R=qe({data_ids:0,file_id:0}),P={0:"未转换",1:"已转换",2:"转换异常",3:"转换中",4:"分段失败",10:"分段中"},D=qe({status:"",errmsg:"",status_text:""}),B=()=>{p("enable")},g=s(!1),ee=h=>{g.value=h},S=h=>{j.value=!0,R.data_ids=h.id,R.file_id=h.file_id,D.list=[{content:h.content,number:h.number,title:h.title,word_total:h.word_total,question:h.question,answer:h.answer,images:h.images}],D.status=h.status,D.errmsg=h.errmsg,D.status_text=P[h.status]},q=s(!1),te=s(null),c=()=>{q.value=!0,te.value.handleSaveLibFileSplit()},r=()=>{ve.success("保存成功"),j.value=!1,p("ok",f.type)},k=()=>{q.value=!1};return se({show:S}),(h,O)=>{const ne=be;return o(),v("div",null,[t(ne,{open:j.value,"onUpdate:open":O[0]||(O[0]=fe=>j.value=fe),onCancel:B,title:_.value,maskClosable:!1,"ok-text":g.value?"文档解析中,请稍候...":"确定",confirmLoading:q.value||g.value,onOk:c,width:1084},{default:a(()=>[n("div",El,[j.value?(o(),Q(Xt,{key:0,onOk:r,onFinish:k,onLoading:ee,paragraphType:"paragraphsSegmented",pdfState:R,currentData:D,ref_key:"documentSegmentationModalRef",ref:te},null,8,["pdfState","currentData"])):U("",!0)])]),_:1},8,["open","title","ok-text","confirmLoading"])])}}},Rl=Ce(Tl,[["__scopeId","data-v-e57c7bfa"]]),tt=$=>(Fe("data-v-ac322fc6"),$=$(),ze(),$),Ml={class:"library-preview-page"},Pl={class:"breadcrumb-block"},Dl={class:"library-line1"},Fl={class:"selct-star-box"},zl={class:"document-title-block",style:{height:"22px"}},Nl={class:"title"},Al={class:"search-content-block"},Bl={class:"preview-box"},Hl=tt(()=>n("span",null,"添加分段",-1)),Ul={key:0,class:"page-loading-box"},Ql={class:"content-block"},Jl={class:"content-block"},jl={key:1,class:"pdf-view-box"},Gl={key:0,class:"pdf-mode-switch"},Vl={key:0},Wl={key:1,class:"segmentation-btn"},Zl=tt(()=>n("div",null,"将当页重新分段",-1)),Kl=tt(()=>n("div",null,"将文档重新分段",-1)),Xl=tt(()=>n("div",null,"重新学习文档",-1)),Yl={class:"view-content-box",style:{"padding-top":"60px"}},es=["onClick"],ts={key:0,class:"content-box"},ns={key:1,class:"content-box"},as=["innerHTML"],os={class:"fragment-img"},ls=["src"],ss={class:"right-contnt-box"},is={key:0,class:"right-tabs-box"},cs={class:"content-block"},rs="你是一位文章分段助手，根据文章内容的语义进行合理分段，确保每个分段表述一个完整的语义，每个分段字数控制在500字左右，最大不超过1000字。请严格按照文章内容进行分段，不要对文章内容进行加工，分段完成后输出分段后的内容。",us={__name:"library-preview",setup($){const se=At(),C=ke(()=>{var e;return((e=se.companyInfo)==null?void 0:e.neo4j_status)=="true"}),j=s(!1),_=s(null),p=s(0),f=s(0),R={0:"待生成",4:"生成中",2:"生成成功",3:"生成失败"},P=s([]),D=e=>{P.value=e},B=s({fade:!1,scrollbarTrackClickable:!0,interactive:!0,minSize:40}),g=Qe(),ee=Ht(),S=Pn(),q=ke(()=>k.value.is_table_file=="1"),te=ke(()=>k.value.doc_type),c=ke(()=>{let e=k.value.status;return!(e=="1"||e=="2")||x.value.length==0}),r=ke(()=>k.value.is_qa_doc=="1"),k=s({}),h=qe({status:-1,graph_status:-1,category_id:-1}),O=s(1),ne=ke(()=>"/manage/getLibRawFile?id="+g.query.id+"&token="+S.getToken),fe=()=>{ee.back()},b=s(null),he=s(null);let ie=-1;const H=(e,i=1)=>{let m,L;i==1?(m=".subsection-box .list-item",L=he.value):(m=".view-content-box .list-item",L=b.value);const A=document.querySelectorAll(m)[e];A.classList.add("flash-border"),ie>=0&&document.querySelectorAll(m)[ie].classList.remove("flash-border"),setTimeout(()=>{ie=-1,A.classList.remove("flash-border")},2500),ie=e,L.scrollToElement({el:A,time:1e3})},z=s(!0),G=s(0),V=s({page:1,size:10}),Se=s({}),x=s([]),me=s(0),Re={0:"未转换",1:"已转换",2:"转换异常",3:"转换中..."},$e=qe({split_status_exception:0,total:0,vector_status_converted:0,vector_status_converting:0,vector_status_exception:0,vector_status_initial:0}),d=qe([{value:-1,label:"全部",num:ke(()=>$e.total)},{value:4,label:"分段失败",num:ke(()=>$e.split_status_exception)},{value:0,label:"未转换",num:ke(()=>$e.vector_status_initial)},{value:3,label:"转换中",num:ke(()=>$e.vector_status_converting)},{value:2,label:"转换异常",num:ke(()=>$e.vector_status_exception)},{value:1,label:"已转换",num:ke(()=>$e.vector_status_converted)}]),y=s(1);let N={id:g.query.id,separators_no:"",chunk_size:512,chunk_overlap:50,is_qa_doc:0,question_lable:"",similar_label:"",answer_lable:"",enable_extract_image:!0,ai_chunk_size:5e3,ai_chunk_model:"",ai_chunk_model_config_id:"",ai_chunk_prumpt:rs,ai_chunk_task_id:""};const I=s(!1);let X=!0;(async()=>{Nt({id:g.query.id}).then(e=>{G.value=e.data.library_type,k.value={...e.data,graph_switch:e.data.graph_switch=="1"&&C.value};let i=e.data.status;i==1||i==2?we():z.value=!1,N={...N,separators_no:e.data.separators_no||"11,12",chunk_size:+e.data.chunk_size||512,ai_chunk_size:+e.data.ai_chunk_size||5e3,chunk_overlap:+e.data.chunk_overlap||50,is_qa_doc:G.value==2?1:0,question_lable:e.data.question_lable,similar_label:e.data.similar_label,answer_lable:e.data.answer_lable,question_column:e.data.question_column,similar_column:e.data.similar_column,answer_column:e.data.answer_column,enable_extract_image:e.data.enable_extract_image=="true",qa_index_type:+e.data.qa_index_type,chunk_type:+e.data.chunk_type,semantic_chunk_size:+e.data.semantic_chunk_size||512,semantic_chunk_overlap:+e.data.semantic_chunk_overlap||50,semantic_chunk_threshold:+e.data.semantic_chunk_threshold||90,semantic_chunk_use_model:e.data.semantic_chunk_use_model||"",ai_chunk_prumpt:e.data.ai_chunk_prumpt||"",ai_chunk_model:e.data.ai_chunk_model||"",semantic_chunk_model_config_id:e.data.semantic_chunk_model_config_id>0?e.data.semantic_chunk_model_config_id:"",ai_chunk_model_config_id:e.data.ai_chunk_model_config_id>0?e.data.ai_chunk_model_config_id:"",ai_chunk_task_id:e.data.ai_chunk_task_id||""},e.data.chunk_type==0&&(N={...N,separators_no:e.data.normal_chunk_default_separators_no,chunk_size:+e.data.normal_chunk_default_chunk_size,chunk_overlap:+e.data.normal_chunk_default_chunk_overlap,chunk_type:+e.data.default_chunk_type,semantic_chunk_size:+e.data.semantic_chunk_default_chunk_size,semantic_chunk_overlap:+e.data.semantic_chunk_default_chunk_overlap,semantic_chunk_threshold:+e.data.semantic_chunk_default_threshold,semantic_chunk_use_model:e.data.default_use_model||"",semantic_chunk_model_config_id:e.data.default_model_config_id>0?e.data.default_model_config_id:""}),(i==4||i==2)&&(y.value=parseInt(e.data.is_table_file))})})();const J=()=>{Dn({file_id:g.query.id}).then(e=>{Object.assign($e,e.data)})},ce=()=>{window.location.reload()},u=()=>{V.value.page=1,me.value=0,x.value=[],we()},re=e=>{h.category_id=e,u()},F=(e=null)=>{V.value.page++,we(e)},we=(e=null)=>{X=!0,It({file_id:g.query.id,...V.value,...h}).then(i=>{var w,T;z.value=!1,X=!1;let m=i.data,L=m.list||[],A=((w=m.info)==null?void 0:w.is_qa_doc)=="1"&&((T=m.info)==null?void 0:T.is_table_file)=="1";L.forEach(ge=>{ge.status_text=Re[ge.status],ge.graph_status_text=R[ge.graph_status],ge.isExcelQa=A,ge.similar_questions&&(ge.similar_questions=JSON.parse(ge.similar_questions))}),Se.value=m.info,V.value.page==1&&(x.value=[]),x.value=[...x.value,...L],me.value=m.total,typeof e=="function"&&e()})},Oe=()=>{X||x.value.length>=me.value||(F(),_.value&&_.value.loadMore())},Le=()=>{l()};let Ie=null;function nt(){clearInterval(Ie),x.value.filter(i=>i.status==3).length?Ie=setInterval(()=>{l()},5e3):clearInterval(Ie)}const l=()=>{It({file_id:g.query.id,page:1,size:x.value.length,...h}).then(e=>{var A,w;let i=e.data,m=i.list||[],L=((A=i.info)==null?void 0:A.is_qa_doc)=="1"&&((w=i.info)==null?void 0:w.is_table_file)=="1";m.forEach(T=>{T.status_text=Re[T.status],T.graph_status_text=R[T.graph_status],T.isExcelQa=L,T.similar_questions&&(T.similar_questions=JSON.parse(T.similar_questions))}),x.value=m,nt()})},M=e=>{if(!e.id){V.value.page=1,we();return}let i=x.value,m=i.findIndex(L=>L.id==e.id);if(m>-1){let L=i[m];L.title=e.title,L.content=e.content,L.question=e.question,L.answer=e.answer,L.images=e.images,L.category_id=e.category_id,L.word_total=e.question.length+e.answer.length+e.content.length,L.similar_questions=e.similar_questions.length?JSON.parse(e.similar_questions):[],i.splice(m,1,L),x.value=i}},ae=e=>{let i=x.value,m=i.findIndex(L=>L.id==e);m>-1&&(i.splice(m,1),x.value=i,me.value=me.value--)},ue=s(null),_e=e=>{ue.value.showModal(JSON.parse(JSON.stringify(e)))},Te=s(null),Yt=()=>{Fn({id:g.query.id}).then(()=>ve.success("操作完成"))},en=()=>{zn({id:g.query.id}).then(()=>ve.success("操作完成"))},mt=s(null),tn=()=>{mt.value.show(k.value)},vt=()=>{ee.push("/library/document-segmentation?document_id="+g.query.id+"&source=preview")},nn=()=>{Te.value.open({id:g.query.id,doc_auto_renew_frequency:k.value.doc_auto_renew_frequency})},an=e=>{k.value.doc_auto_renew_frequency=e},on=e=>{k.value.file_name=e},ln=e=>{const i=()=>{for(let m in x.value)if(x.value[m].page_num==e){H(m);return}};if(e>x.value[x.value.length-1].page_num){ve.warning("分段数据正在加载，请稍后...");const m=()=>{e<=x.value[x.value.length-1].page_num?(ve.success("加载完成"),We(()=>{i()})):F(m)};F(m)}else i()},sn=(e,i)=>{f.value=i,p.value=e,x.value[x.value.length-1].page_num<e&&F()},ht=e=>{var i;if(((i=k.value)==null?void 0:i.file_ext)=="pdf"&&O.value==1){const m=e.page_num-1,L=()=>document.querySelectorAll(".pdf-render-box > .scroll-content .vue-pdf-embed")[m],A=()=>{const T=L();T.classList.add("flash-border"),setTimeout(()=>T.classList.remove("flash-border"),2500),_.value.getScrollInstance().scrollToElement({el:T,time:1e3})};if(L())A();else{ve.warning("PDF正在加载，请稍后...");const T=()=>{L()?(ve.success("加载完成"),A()):_.value&&_.value.loadMore()};_.value&&_.value.loadMore(T)}}else H(e.index,2)},at=s(1);let ot=null;const Ge=s(0),cn=e=>{Ge.value=e},rn=({y:e})=>{if(!ot){const m=document.querySelectorAll(".pdf-render-box > .scroll-content .vue-pdf-embed")[0];ot=m&&m.clientHeight}let i=Math.floor(Math.abs(e)/ot)+1;at.value=Math.max(i,1)},lt=s(null),st=s(null),un=e=>{let{key:i}=e;_.value&&_.value.getScrollInstance().disable(),i==1&&lt.value.show({type:i,pdf_page_num:at.value}),i==2&&vt(),i==3&&lt.value.show({type:i,pdf_page_num:0})},gt=e=>{st.value&&st.value.show(e)},kt=()=>{_.value&&_.value.getScrollInstance().enable()},dn=()=>{kt(),u()},yt=()=>{j.value=!j.value},it=(e,i)=>{let m=JSON.parse(JSON.stringify(e));return m.content=i,m.word_total=i.length,m},Me=s(!1),Pe=s(1),bt=({index:e,beforeContent:i,selectedContent:m,afterContent:L,isFullSelection:A})=>{const w=[...x.value];Me.value=A,Pe.value=1,A?(w.splice(e+1,0,it(w[e],m)),w.splice(e,1)):(w[e].content=i||"",w[e].word_total=i.length||0,L.trim()&&w.splice(e+1,0,it(w[e],L)),w.splice(e+1,0,it(w[e],m)),w[e+1].images=[]),x.value=w,Ne(w,e)},St=({index:e,beforeContent:i,selectedContent:m,afterContent:L,isFullSelection:A})=>{const w=[...x.value];Me.value=A,Pe.value=2;let T=w[e+1].word_total;A?(w[e+1].content=+m,w[e+1].word_total=parseInt(T)+m.length,w.splice(e,1),x.value=w,Ne(w,e)):(w[e].content=i||"",w[e].word_total=i.length||0,w[e+1].content+=m,w[e+1].word_total=parseInt(T)+m.length,L.trim()&&(w[e].content+=L||"",w[e].word_total+=L.length||0),x.value=w,Ne(w,e+1))},wt=({index:e,beforeContent:i,selectedContent:m,afterContent:L,isFullSelection:A})=>{const w=[...x.value];Me.value=A,Pe.value=3;let T=w[e-1].word_total;A?(w[e-1].content+=m,w[e-1].word_total=parseInt(T)+m.length,w.splice(e,1),x.value=w,Ne(w,e)):(w[e].content=i||"",w[e].word_total=i.length||0,w[e-1].content+=m,w[e-1].word_total=parseInt(T)+m.length,L.trim()&&(w[e].content+=L||"",w[e].word_total+=L.length||0),x.value=w,Ne(w,e-1))},xt=({index:e,beforeContent:i,afterContent:m,isFullSelection:L})=>{const A=[...x.value];Me.value=L,Pe.value=4,L?A.splice(e,1):(A[e].content=i||"",A[e].word_total=i.length||0,m.trim()&&(A[e].content+=m||"",A[e].word_total+=m.length||0)),x.value=A,Ne(A,e)};function _n(e,i,m={},L){let A=L+1;if(!Array.isArray(e)||!Array.isArray(i))return JSON.stringify([]);const w=e.map((T,ge)=>{const W={};for(const Z of i){const Be=m[Z]||Z,de=T[Be];if(Object.prototype.hasOwnProperty.call(T,Be))if(Z==="number")W[Z]=ge+1;else if(Z==="page_num"||Z==="word_total")W[Z]=+de;else if(Z==="content"){if(!de)return null;W[Z]=de}else Z==="images"?Pe.value==1?Me.value?(A==W.number,W[Z]=de):A+1==W.number?W[Z]=[]:W[Z]=de:Pe.value==2?(Me.value,A==W.number,W[Z]=de):Pe.value==3?Me.value?(A-1==W.number,W[Z]=de):(A==W.number,W[Z]=de):Pe.value==4&&(Me.value,W[Z]=de):W[Z]=de}return W}).filter(T=>T!==null&&T.content!==void 0&&T.content!=="");return JSON.stringify(w)}const pn={similar_question_list:"similar_questions"},Ne=async(e,i)=>{let m={...N,semantic_chunk_model_config_id:N.semantic_chunk_model_config_id?+N.semantic_chunk_model_config_id:0,ai_chunk_model_config_id:N.ai_chunk_model_config_id?+N.ai_chunk_model_config_id:0,is_table_file:y.value};delete m.id;let L={id:g.query.id,word_total:me.value,split_params:JSON.stringify(m),list:_n(e,["number","page_num","title","content","question","similar_question_list","answer","word_total","images"],pn,i)};m.is_qa_doc==1&&(L.qa_index_type=m.qa_index_type),I.value=!0,Nn(L).then(A=>{ve.success("操作成功");const w=A.data;for(let T=0;T<w.length;T++){const ge=w[T],W=x.value[T];if(T<x.value.length)W.id=ge.toString(),W.status="0",W.status_text=Re[W.status];else break}}).finally(()=>{I.value=!1})};return Ue(()=>{J(),g.query.graph_status&&(h.graph_status=g.query.graph_status,u())}),(e,i)=>{var Ct,Lt,qt;const m=An("router-link"),L=ca,A=ia,w=Xe,T=Mt,ge=Zt,W=Kt,Z=dt,Be=_t,de=pt,fn=da,mn=Je,Ve=Ye,$t=pa,vn=_a,hn=ua,gn=ra,kn=rt("viewer");return o(),v("div",Ml,[n("div",Pl,[t(A,null,{default:a(()=>[t(L,null,{default:a(()=>[t(m,{to:"/library/list"},{default:a(()=>[E(" 知识库管理 ")]),_:1})]),_:1}),t(L,null,{default:a(()=>[t(m,{to:{path:"/library/details/knowledge-document",query:{id:k.value.library_id}}},{default:a(()=>[n("div",Dl,K(k.value.library_name)+"知识库",1)]),_:1},8,["to"])]),_:1}),t(L,null,{default:a(()=>[E("知识库详情")]),_:1})]),_:1}),n("div",Fl,[t(Hn,{startLists:P.value,onChange:re},null,8,["startLists"])])]),n("div",zl,[t(oe(fa),{onClick:fe}),n("span",Nl,K(k.value.file_name),1),t(To,{detailsInfo:k.value},null,8,["detailsInfo"])]),n("div",Al,[n("div",Bl,[j.value?(o(),Q(T,{key:1,onClick:i[1]||(i[1]=le=>yt())},{default:a(()=>[t(w,{class:"preview-box-icon",name:"expand"}),E(" 展开预览")]),_:1})):(o(),Q(T,{key:0,onClick:i[0]||(i[0]=le=>yt())},{default:a(()=>[t(w,{class:"preview-box-icon",name:"put-away"}),E(" 收起预览")]),_:1}))]),t(fn,null,{default:a(()=>[r.value?(o(),Q(W,{key:0,value:h.status,"onUpdate:value":i[2]||(i[2]=le=>h.status=le),placeholder:"请选择",style:{width:"160px"},onChange:u},{default:a(()=>[t(ge,{value:-1},{default:a(()=>[E("全部嵌入状态")]),_:1}),(o(),v(pe,null,xe(Re,(le,Ae)=>t(ge,{key:le,value:Ae},{default:a(()=>[E(K(le),1)]),_:2},1032,["value"])),64))]),_:1},8,["value"])):U("",!0),k.value.graph_switch?(o(),Q(W,{key:1,value:h.graph_status,"onUpdate:value":i[3]||(i[3]=le=>h.graph_status=le),placeholder:"请选择",onChange:u,style:{width:"160px"}},{default:a(()=>[t(ge,{value:-1},{default:a(()=>[E("全部知识图谱状态")]),_:1}),(o(),v(pe,null,xe(R,(le,Ae)=>t(ge,{key:le,value:Ae},{default:a(()=>[E(K(le),1)]),_:2},1032,["value"])),64))]),_:1},8,["value"])):U("",!0),t(de,null,{overlay:a(()=>[t(Be,null,{default:a(()=>[t(Z,{onClick:Yt},{default:a(()=>[E("重新嵌入向量")]),_:1}),k.value.graph_switch?(o(),Q(Z,{key:0,onClick:en},{default:a(()=>[E("重新抽取知识图谱")]),_:1})):U("",!0),t(Z,{onClick:tn},{default:a(()=>[E("重命名")]),_:1}),te.value==2?(o(),Q(Z,{key:1,onClick:nn},{default:a(()=>[E("设置更新频率")]),_:1})):U("",!0)]),_:1})]),default:a(()=>[t(T,null,{default:a(()=>[E("其他操作 "),t(oe(Tt))]),_:1})]),_:1}),te.value!=3?(o(),Q(T,{key:2,onClick:vt},{default:a(()=>[E("重新分段")]),_:1})):U("",!0),t(T,{onClick:i[4]||(i[4]=le=>_e({})),type:"primary"},{icon:a(()=>[t(oe(Qt))]),default:a(()=>[Hl]),_:1})]),_:1})]),z.value?(o(),v("div",Ul,[t(mn)])):(o(),v(pe,{key:1},[r.value?(o(),v(pe,{key:0},[c.value?(o(),Q(ct,{key:0,onOpenEditSubscription:_e})):(o(),Q(He,{key:1,scrollbar:{minSize:0},onOnScrollEnd:Oe},{default:a(()=>[n("div",Ql,[t(Il,{ref:"subsectionBoxRef",total:me.value,paragraphLists:x.value,detailsInfo:k.value,onOpenEditSubscription:_e,onHandleDelParagraph:ae,onHandleConvert:Le,onGetStatrList:D},null,8,["total","paragraphLists","detailsInfo"])])]),_:1}))],64)):(o(),v(pe,{key:1},[q.value||te.value==3?(o(),v(pe,{key:0},[c.value?(o(),Q(ct,{key:0,onOpenEditSubscription:_e})):(o(),Q(He,{key:1,scrollbar:{minSize:0},onOnScrollEnd:Oe,disableMouse:!0},{default:a(()=>[n("div",Jl,[t(Rt,{ref:"subsectionBoxRef",total:me.value,detailsInfo:k.value,paragraphLists:x.value,onOpenEditSubscription:_e,onHandleDelParagraph:ae,onHandleConvert:Le,onHandleScrollTargetPage:ht,onGetStatrList:D,onHandleSplit:bt,onHandleSplitNext:St,onHandleSplitUp:wt,onHandleSplitDelete:xt,onHandleSegmentation:gt},null,8,["total","detailsInfo","paragraphLists"])])]),_:1}))],64)):(o(),v("div",jl,[n("div",{class:Ut(["view-content-wrap",{collapsed:j.value}])},[((Ct=k.value)==null?void 0:Ct.file_ext)=="pdf"?(o(),v("div",Gl,[t(vn,{value:O.value,"onUpdate:value":i[5]||(i[5]=le=>O.value=le)},{default:a(()=>[t($t,{value:1},{default:a(()=>[t(Ve,{placement:"right",title:"原文预览模式下，会展示pdf原始文件内容，手动编辑分段的不会展示。您可以通过原文预览模式，校验分段准确性，然后手动编辑分段。"},{default:a(()=>[E(" 原文预览 "),O.value==1&&Ge.value>0?(o(),v("span",Vl,"("+K(at.value)+" / "+K(Ge.value)+")",1)):U("",!0)]),_:1})]),_:1}),t($t,{value:2},{default:a(()=>[E("纯文本预览")]),_:1})]),_:1},8,["value"])])):U("",!0),((Lt=k.value)==null?void 0:Lt.file_ext)=="pdf"?(o(),v("div",Wl,[t(de,null,{overlay:a(()=>[t(Be,{onClick:un},{default:a(()=>[O.value==1&&Ge.value>0?(o(),Q(Z,{key:1},{default:a(()=>[t(Ve,{placement:"right",title:"将当前页重新解析并分段"},{default:a(()=>[Zl]),_:1})]),_:1})):U("",!0),(o(),Q(Z,{key:2},{default:a(()=>[t(Ve,{placement:"right",title:"将整个文档重新分段，注意，重新分段并不会重新提取文档的内容，只是将内容重新分段。"},{default:a(()=>[Kl]),_:1})]),_:1})),(o(),Q(Z,{key:3},{default:a(()=>[t(Ve,{placement:"right",title:"将整个文档重新学习，包含重新解析并提取文档内容，重新分段。"},{default:a(()=>[Xl]),_:1})]),_:1}))]),_:1})]),default:a(()=>[t(T,null,{default:a(()=>[E(" 重新分段 "),t(oe(Tt))]),_:1})]),_:1})])):U("",!0),((qt=k.value)==null?void 0:qt.file_ext)=="pdf"&&O.value==1?(o(),Q(Do,{key:2,ref_key:"pdfRef",ref:_,class:"scroll-box pdf-render-box",source:ne.value,onSelect:ln,onScroll:rn,onRendered:sn,onGetTotalPage:cn},null,8,["source"])):(o(),Q(He,{key:3,scrollbar:B.value,ref_key:"leftScrollRef",ref:b,class:"scroll-box",onOnScrollEnd:Oe},{default:a(()=>[n("div",Yl,[(o(!0),v(pe,null,xe(x.value,(le,Ae)=>(o(),v("div",{class:"list-item",onClick:Ot=>H(Ae),key:Ae},[le.question?(o(),v("div",ts,K(le.question),1)):U("",!0),le.answer?(o(),v("div",ns,K(le.answer),1)):U("",!0),n("div",{class:"content-box",innerHTML:le.content},null,8,as),ut((o(),v("div",os,[(o(!0),v(pe,null,xe(le.images,(Ot,yn)=>(o(),v("img",{key:yn,src:Ot,alt:""},null,8,ls))),128))])),[[kn]])],8,es))),128))])]),_:1},8,["scrollbar"]))],2),n("div",ss,[r.value?U("",!0):(o(),v("div",is,[t(gn,{activeKey:h.status,"onUpdate:activeKey":i[6]||(i[6]=le=>h.status=le),style:{"background-color":"#f2f4f7",padding:"0px 16px","border-radius":"6px"},onChange:u},{default:a(()=>[(o(!0),v(pe,null,xe(d,le=>(o(),Q(hn,{key:le.value,tab:`${le.label} (${le.num})`},null,8,["tab"]))),128))]),_:1},8,["activeKey"])])),c.value?(o(),Q(ct,{key:1,onOpenEditSubscription:_e})):(o(),Q(He,{key:2,scrollbar:B.value,disableMouse:!0,ref_key:"rightScrollRef",ref:he,onOnScrollEnd:Oe},{default:a(()=>[n("div",cs,[t(Rt,{ref:"subsectionBoxRef",total:me.value,detailsInfo:k.value,paragraphLists:x.value,onOpenEditSubscription:_e,onHandleDelParagraph:ae,onHandleConvert:Le,onHandleScrollTargetPage:ht,onGetStatrList:D,onHandleSplit:bt,onHandleSplitNext:St,onHandleSplitUp:wt,onHandleSplitDelete:xt,onHandleSegmentation:gt},null,8,["total","detailsInfo","paragraphLists"])])]),_:1},8,["scrollbar"]))])]))],64))],64)),t(Un,{detailsInfo:k.value,onHandleEdit:M,ref_key:"editSubscriptionRef",ref:ue},null,8,["detailsInfo"]),t(Ro,{onOk:an,ref_key:"updateFrequencyRef",ref:Te},null,512),t(Yn,{onOk:on,ref_key:"renameModalRef",ref:mt},null,512),t(al,{onOk:dn,onEnable:kt,detailsInfo:k.value,ref_key:"reSegmentationPageRef",ref:lt},null,8,["detailsInfo"]),t(Rl,{ref_key:"segmentationSettingModalRef",ref:st,onOk:ce},null,512)])}}},zi=Ce(us,[["__scopeId","data-v-ac322fc6"]]);export{zi as default};
