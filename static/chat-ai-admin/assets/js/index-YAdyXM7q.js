import{e as _e,b as me,d as C,z as Y,w as W,q as ee,N as p,O as _,F as D,S as j,a6 as V,j as r,U as b,Z as O,k as ue,u as K,X as t,a1 as G,a5 as ne,_ as T,G as pe,Y as ve,V as fe,ao as he,M as ie,a8 as oe,D as ge}from"./vue-chunks-BRsu9_To.js";import{l as ye,B as ke,d as te,k as le,dG as be,b as X,aA as xe,df as $e,bz as Z,aB as Se,aD as Le,dH as we,bC as Ae,dI as Ce,a0 as Me,bH as Re,bE as Ne,bF as qe}from"../../index-DGlN_gTP.js";import{c as re}from"./index-D9KRCCIf.js";import{M as Ie}from"./model-select-7nrl0gxH.js";import{S as Ue}from"./SettingOutlined-B7nQytvu.js";import"./index-SBg8gFw7.js";import{_ as Be,R as Oe}from"./RadioButton-Bnx6tN7r.js";import{Q}from"./QuestionCircleOutlined-Bvo9_S3-.js";import{S as Te,a as ze,i as Ee}from"./index-BlDgRIYn.js";import{_ as Fe}from"./index-h5uZcqCa.js";import{_ as je}from"./TextArea-BNOG6RQ7.js";import{_ as de}from"./index-BQDPftJ3.js";import{_ as Ke}from"./index-B8XmcRDl.js";import{_ as Ve}from"./index-DSI4uitL.js";import{_ as De}from"./index-C1MdRggi.js";import{M as Pe}from"./index-BMSQkwth.js";import"./index-JAP4Oum8.js";import{I as He}from"./Input-BpI49rDY.js";import{u as Je}from"./useEventBus-BwH2zX88.js";import{C as Ge,_ as Qe}from"./index-CVsoyaFF.js";import{I as Ye}from"./index-C2aSFNHZ.js";import"./axios-Dq7h7Pqt.js";import"./qs-BrxkIg-9.js";import"./crypto-js-ClNpte_9.js";import"./dayjs-B6IotFah.js";import"./index-DasxHN4l.js";import"./FormItemContext-DAoPsdM7.js";import"./Checkbox-B8J-JVwM.js";import"./Trigger-oBKhEx1B.js";import"./ResizeObserver.es-B1PUzC5B.js";import"./index-C0cXlrXm.js";import"./slide-Ccxw2gRU.js";import"./index-k9nX7Zez.js";import"./CheckOutlined-B_Hs0-OP.js";import"./DownOutlined-BUKGfKlO.js";import"./SearchOutlined-DSY7YbKD.js";import"./move-BSoEcIoa.js";import"./inputProps-Bu_dzA3C.js";import"./colors-DKWwHq2l.js";import"./UpOutlined-CR2jjLrd.js";import"./Search-CH76L-gx.js";import"./isPlainObject-51jSOJKV.js";import"./Password-B9FCv-aw.js";import"./index-Cf43OwEB.js";import"./LeftOutlined-D6kSS-Pc.js";import"./RightOutlined-TchQhXHc.js";const Xe={class:"prompt-form"},Ze={class:"prompt-form-item"},We={class:"prompt-form-item"},et={class:"prompt-form-item-content"},tt={key:0,class:"prompt-form-item-tip"},st={class:"prompt-form-item"},at={class:"prompt-form-item-label"},ot={class:"form-item-body"},lt={class:"number-box"},nt={class:"number-slider-box"},it={class:"number-input-box"},rt={class:"prompt-form-item"},dt={class:"prompt-form-item-label"},ct={class:"form-item-body"},_t={class:"number-box"},mt={class:"number-slider-box"},ut={class:"number-input-box"},pt={class:"recall-settings-box"},vt={class:"form-box prompt-form"},ft={class:"form-item is-required"},ht={class:"form-item-body"},gt={class:"retrieval-mode-items"},yt=["onClick"],kt={class:"retrieval-mode-title"},bt={class:"title-text"},xt={class:"retrieval-mode-desc"},$t={class:"form-item"},St={class:"form-item-label"},Lt={class:"form-item-body"},wt={class:"number-box"},At={class:"number-slider-box"},Ct={class:"number-input-box"},Mt={key:0,class:"form-item"},Rt={class:"form-item-label"},Nt={class:"form-item-body"},qt={class:"number-box"},It={class:"number-slider-box"},Ut={class:"number-input-box"},Bt={class:"form-item"},Ot={class:"form-item-label"},Tt={key:0,class:"form-item-body"},zt=["src"],Et=_e({__name:"search-drawer",props:{librarySearchData:{type:Object,default:null},defaultLibrarySearchData:{type:Object,default:null}},setup($){let{role_permission:i,role_type:M}=ye();const I=me(()=>M==1||i.includes("SearchSets")),k=$,N=C([{iconName:"mix-icon",title:"混合检索",value:1,isRecommendation:!0,desc:"同时执行三种检索模式，使用RRF算法进行排序，从三种查询结果中选择更匹配用户问题的结果。混合检索兼顾语义相似性与逻辑关联性，通过互补优势提升检索的准确性和生成结果的可信度"},{iconName:"vector-icon",title:"向量检索",value:2,desc:"将用户提问转成向量之后与知识库分段匹配相似度，返回相似度高的结果。向量检索擅长语义相似性匹配和大规模非结构化数据处理，但缺乏可解释性和精准关系验证"},{iconName:"graph-icon",title:"知识图谱检索",value:4,desc:"通过关系推理，检索出与用户问题相关联的知识。知识图谱检索擅长精准的实体关系推理和逻辑验证，但对非结构化文本和语义模糊查询支持较弱"},{iconName:"search-check-icon",title:"全文检索",value:3,desc:"通过分词匹配文档中的词汇，返回包含这些词汇的文本片段"}]),w=C(!1),s=Y({use_model:"",model_config_id:"",prompt_type:"0",prompt:"",temperature:.5,max_token:2e3,context_pair:0,search_type:1,top_k:5,size:0,similarity:.4,rerank_status:0,rerank_use_model:void 0,rerank_model_config_id:void 0}),z=C([]),E=()=>{re({model_type:"RERANK"}).then(f=>{let e=f.data||[];z.value=e.map(R=>({id:R.model_config.id,name:R.model_info.model_name,icon:R.model_info.model_icon_url,children:R.model_info.rerank_model_list}))})},x=(f,e)=>{s.use_model=e.modelName,s.model_config_id=e.modelId,a()},n=C([]),m=f=>{var e,R,l,d,S;if(n.value=f,!((e=k.librarySearchData)!=null&&e.model_config_id)||!((R=k.librarySearchData)!=null&&R.use_model)){if(n.value.length>0){let u=n.value[0];if(u){let L=u.children[0];s.use_model=L.name,s.model_config_id=L.model_config_id}}}else s.use_model=((l=k.librarySearchData)==null?void 0:l.use_model)+"$$",s.model_config_id=((d=k.librarySearchData)==null?void 0:d.model_config_id)+"$$",s.use_model=s.use_model.split("$$")[0],s.model_config_id=(S=k.librarySearchData)==null?void 0:S.model_config_id.split("$$")[0]},U=f=>{s.search_type=f,a()},g=(f,e)=>{s.rerank_model_config_id=e.rerank_model_config_id,a()},v=f=>{let e={...f};e.max_token=parseFloat(e.max_token),e.temperature=parseFloat(e.temperature),e.context_pair=parseFloat(e.context_pair),e.search_type=parseFloat(e.search_type),e.rerank_status=parseFloat(e.rerank_status),e.similarity=parseFloat(e.similarity),e.top_k=parseFloat(e.size),e.rerank_use_model===""&&(e.rerank_use_model=void 0),Object.keys(e).forEach(R=>{s[R]=e[R]})},a=()=>{let f={...s};if(!f.prompt&&s.prompt_type=="1")return le.error("请输入自定义提示词");(s.search_type==3||s.search_type==4)&&delete f.similarity,s.prompt_type=="0"&&delete f.prompt,f.size=f.top_k,be(f).then(e=>{le.success("保存成功")})},P=f=>{},F=()=>{w.value=!0};return W(()=>k.librarySearchData,f=>{var e;(e=k.librarySearchData)!=null&&e.id&&v({...pe(k.librarySearchData)})}),ee(()=>{E()}),(f,e)=>{const R=ke,l=Oe,d=Be,S=je,u=de,L=Ke,y=Ve,c=te,A=De,q=ze,B=Ee,H=Te,h=Fe;return _(),p(D,null,[I.value?(_(),j(R,{key:0,onClick:F,icon:ue(K(Ue))},{default:b(()=>e[15]||(e[15]=[O("搜索设置")])),_:1,__:[15]},8,["icon"])):V("",!0),r(h,{open:w.value,"onUpdate:open":e[14]||(e[14]=o=>w.value=o),class:"custom-class","root-class-name":"root-class-name",title:"搜索设置",width:"472",placement:"right",onAfterOpenChange:P},{default:b(()=>[t("div",Xe,[e[24]||(e[24]=t("div",{class:"prompt-form-label"},"模型设置",-1)),t("div",Ze,[e[16]||(e[16]=t("div",{class:"prompt-form-item-label"},[t("span",{style:{color:"red"}},"* "),t("span",null,"模型选择")],-1)),r(Ie,{modelType:"LLM",modeName:s.use_model,"onUpdate:modeName":e[0]||(e[0]=o=>s.use_model=o),modeId:s.model_config_id,"onUpdate:modeId":e[1]||(e[1]=o=>s.model_config_id=o),style:{width:"100%"},onLoaded:m,onChange:x},null,8,["modeName","modeId"])]),t("div",We,[e[19]||(e[19]=t("div",{class:"prompt-form-item-label"},[t("span",{style:{color:"red"}},"* "),t("span",null,"提示词")],-1)),r(d,{value:s.prompt_type,"onUpdate:value":e[2]||(e[2]=o=>s.prompt_type=o),onChange:a},{default:b(()=>[r(l,{value:"0"},{default:b(()=>e[17]||(e[17]=[O("默认提示词")])),_:1,__:[17]}),r(l,{value:"1"},{default:b(()=>e[18]||(e[18]=[O("自定义提示词")])),_:1,__:[18]})]),_:1},8,["value"]),t("div",et,[s.prompt_type=="0"?(_(),p("div",tt,"将提交的内容进行智能总结,不要随意发挥")):(_(),j(S,{key:1,onBlur:a,maxLength:500,style:{height:"80px"},value:s.prompt,"onUpdate:value":e[3]||(e[3]=o=>s.prompt=o),placeholder:"请输入自定义提示词"},null,8,["value"]))])]),t("div",st,[t("div",at,[e[21]||(e[21]=t("span",null,"温度",-1)),r(u,null,{title:b(()=>e[20]||(e[20]=[O("温度越低，回答越严谨。温度越高，回答越发散。")])),default:b(()=>[r(K(Q),{class:"question-icon"})]),_:1})]),t("div",ot,[t("div",lt,[t("div",nt,[r(L,{onBlur:a,class:"custom-slider",value:s.temperature,"onUpdate:value":e[4]||(e[4]=o=>s.temperature=o),min:0,max:2,step:.1},null,8,["value"])]),t("div",it,[r(y,{onBlur:a,value:s.temperature,"onUpdate:value":e[5]||(e[5]=o=>s.temperature=o),min:0,max:2,step:.1},null,8,["value"])])])])]),t("div",rt,[t("div",dt,[e[23]||(e[23]=t("span",null,"最大token",-1)),r(u,null,{title:b(()=>e[22]||(e[22]=[t("div",null,"问题+答案的最大token数，如果出现回答被截断，可调高此值",-1)])),default:b(()=>[r(K(Q),{class:"question-icon"})]),_:1})]),t("div",ct,[t("div",_t,[t("div",mt,[r(L,{onBlur:a,class:"custom-slider",value:s.max_token,"onUpdate:value":e[6]||(e[6]=o=>s.max_token=o),min:0,max:100*1024},null,8,["value"])]),t("div",ut,[r(y,{onBlur:a,value:s.max_token,"onUpdate:value":e[7]||(e[7]=o=>s.max_token=o),min:0,max:100*1024},null,8,["value"])])])])])]),t("div",pt,[t("div",vt,[e[32]||(e[32]=t("div",{class:"prompt-form-label"},"召回设置",-1)),t("div",ft,[e[25]||(e[25]=t("div",{class:"form-item-label"},[t("span",null,"检索模式")],-1)),t("div",ht,[t("div",gt,[(_(!0),p(D,null,G(N.value,o=>(_(),p("div",{class:ne(["retrieval-mode-item",{active:s.search_type==o.value}]),key:o.value,onClick:J=>U(o.value)},[s.search_type==o.value?(_(),j(c,{key:0,class:"check-arrow",name:"check-arrow-filled"})):V("",!0),t("div",kt,[r(c,{name:o.iconName,class:"title-icon"},null,8,["name"]),t("span",bt,T(o.title),1),o.isRecommendation?(_(),j(c,{key:0,class:"recommendation-icon",name:"recommendation"})):V("",!0)]),t("div",xt,T(o.desc),1)],10,yt))),128))])])]),t("div",$t,[t("div",St,[e[27]||(e[27]=t("span",null,"Top K ",-1)),r(u,null,{title:b(()=>e[26]||(e[26]=[O("最多从知识库中召回分段数，最低为1，最高为10。召回分段数越多，消耗的token也会越多。")])),default:b(()=>[r(K(Q),{class:"question-icon"})]),_:1})]),t("div",Lt,[t("div",wt,[t("div",At,[r(L,{onBlur:a,class:"custom-slider",value:s.top_k,"onUpdate:value":e[8]||(e[8]=o=>s.top_k=o),min:1,max:10},null,8,["value"])]),t("div",Ct,[r(y,{onBlur:a,value:s.top_k,"onUpdate:value":e[9]||(e[9]=o=>s.top_k=o),min:1,max:10},null,8,["value"])])])])]),s.search_type!=3&&s.search_type!=4?(_(),p("div",Mt,[t("div",Rt,[e[29]||(e[29]=t("span",null,"相似度阈值 ",-1)),r(u,null,{title:b(()=>e[28]||(e[28]=[O("召回时，只会召回相似度大于阈值的文本分段。取值范围：0~1，阈值越大回答的越准确，建议不超过0.9")])),default:b(()=>[r(K(Q),{class:"question-icon"})]),_:1})]),t("div",Nt,[t("div",qt,[t("div",It,[r(L,{onBlur:a,class:"custom-slider",value:s.similarity,"onUpdate:value":e[10]||(e[10]=o=>s.similarity=o),min:0,max:1,step:.01},null,8,["value"])]),t("div",Ut,[r(y,{onBlur:a,value:s.similarity,"onUpdate:value":e[11]||(e[11]=o=>s.similarity=o),min:0,max:1,step:.01},null,8,["value"])])])])])):V("",!0),t("div",Bt,[t("div",Ot,[e[31]||(e[31]=t("span",null,"Rerank模型 ",-1)),r(u,null,{title:b(()=>e[30]||(e[30]=[O("召回时，只会召回相似度大于阈值的文本分段。取值范围：0~1，阈值越大回答的越准确，建议不超过0.9")])),default:b(()=>[r(K(Q),{class:"question-icon"})]),_:1}),r(A,{onChange:a,style:{float:"right"},checkedValue:1,unCheckedValue:0,checked:s.rerank_status,"onUpdate:checked":e[12]||(e[12]=o=>s.rerank_status=o),"checked-children":"开","un-checked-children":"关"},null,8,["checked"])]),s.rerank_status==1?(_(),p("div",Tt,[r(H,{value:s.rerank_use_model,"onUpdate:value":e[13]||(e[13]=o=>s.rerank_use_model=o),placeholder:"请选择Rerank模型",onChange:g,style:{width:"100%"}},{default:b(()=>[(_(!0),p(D,null,G(z.value,o=>(_(),j(B,{key:o.id},{label:b(()=>[t("span",null,[t("img",{class:"model-icon",src:o.icon,alt:""},null,8,zt)])]),default:b(()=>[(_(!0),p(D,null,G(o.children,J=>(_(),j(q,{value:J,rerank_model_config_id:o.id,key:J},{default:b(()=>[t("span",null,T(J),1)]),_:2},1032,["value","rerank_model_config_id"]))),128))]),_:2},1024))),128))]),_:1},8,["value"])])):V("",!0)])])])]),_:1},8,["open"])],64)}}}),Ft=X(Et,[["__scopeId","data-v-ba1f3fd4"]]),jt={class:"no-data"},Kt={class:"no-data-text"},Vt={__name:"list-empty",props:{text:{type:String,default:"暂无数据"},size:{type:[Number,String],default:100}},setup($){const i=$;return(M,I)=>{const k=te;return _(),p("div",jt,[r(k,{name:"empty-document",style:ve({"font-size":`${i.size}px`,color:"white"})},null,8,["style"]),t("div",Kt,[fe(M.$slots,"default",{},()=>[O(T(i.text),1)],!0)])])}}},Dt=X(Vt,[["__scopeId","data-v-22b194ba"]]),Pt={class:"search-box-warpper"},Ht={class:"search-box-content"},Jt={class:"search-set-box"},Gt={key:0,class:"search-content"},Qt={class:"search-input-box"},Yt={key:1,class:"search-content search-main"},Xt={class:"search-input-box"},Zt={key:1,class:"search-content-box"},Wt={class:"search-tip-box"},es={key:0,class:"tip"},ts={key:1,class:"tip complete"},ss={key:0,class:"container"},as={key:1,class:"intelligent-answer"},os=["innerHTML"],ls={key:1},ns={class:"section-box"},is={key:0,class:"section-label"},rs={class:"section-item-nav"},ds={class:"section-item-nav-left"},cs=["onClick"],_s={key:0},ms={class:"section-item-nav-right"},us=["innerHTML"],ps={__name:"search-box",props:{librarySearchData:{type:Object,default:null},messageObj:{type:Object,default:null},library_ids:{type:Array,default:()=>[]},isError:{type:Boolean,default:!1}},emits:["search","defaultParmas"],setup($,{expose:i,emit:M}){const I=M,k=$,N=new Pe({html:!0,linkify:!0,typographer:!0}),w=C(""),s=C(""),z=C(!1),E=C(!1),x=C({});W(()=>k.messageObj.content,()=>{w.value=N.render(k.messageObj.content)}),W(()=>k.messageObj.error,l=>{l&&Z(l)});const n=async()=>{if(!k.library_ids.length)return Z("请在左侧的知识库选择项内至少选择一个知识库");if(!s.value)return Z("请输入消息内容");I("search",s.value),z.value=!0};function m(l){return l.match(/^-?\d+(?:\.\d{0,2})?/)[0]}const U=(l,d)=>{if(!l||!d.trim())return l;const S=d.replace(/[.*+?^${}()|[\]\\]/g,"\\$&"),u=new RegExp(`(${S})`,"gi");return l.replace(u,'<span class="highlight">$1</span>')},g=l=>{if(!l.file_name){window.open(`#/library/details/categary-manage?id=${l.library_id}`);return}window.open(`#/library/preview?id=${l.file_id}`)},v=C(k.librarySearchData),a=Y({rerank_status:"",rerank_use_model:"",prompt:"",model_config_id:"",use_model:"",temperature:.5,max_token:2e3,similarity:.4,search_type:1}),P=C({}),F=l=>{v.value=l;let d={model_config_id:l.model_config_id||a.model_config_id,use_model:l.use_model||a.use_model,temperature:l.temperature||a.temperature,max_token:l.max_token||a.max_token,size:200,similarity:l.similarity||a.similarity,search_type:l.search_type||a.search_type,question:s.value,id:k.library_ids.join(","),recall_type:1};l.rerank_status&&(d.rerank_status=l.rerank_status),l.rerank_use_model&&(d.rerank_use_model=l.rerank_use_model),l.prompt&&(d.prompt=l.prompt),l.rerank_status==1&&(d.rerank_model_config_id=l.rerank_model_config_id),E.value=!0,P.value=Object.assign(d),I("defaultParmas",P.value),$e(d).then(S=>{x.value=S.data}).catch(()=>{}).finally(()=>{E.value=!1})},f=C([]);function e(l,d,S){const u=new Set(l.map(L=>L.model_define));return d.filter(L=>{let y=L[S];u.has(y)&&l.filter(c=>{if(c.model_define==y)return c.children=Se(c.children,L.children),!1})}),l}const R=async()=>{await re({model_type:"LLM"}).then(l=>{let d=l.data||[],S=[];f.value=d.map(u=>{S=[];for(let L=0;L<u.model_info.llm_model_list.length;L++){const y=u.model_info.llm_model_list[L];S.push({name:y,deployment_name:u.model_config.deployment_name,model_config_id:u.model_config.id,model_define:u.model_info.model_define})}return{model_config_id:u.model_config.id,name:u.model_info.model_name,model_define:u.model_info.model_define,icon:u.model_info.model_icon_url,children:S,deployment_name:u.model_config.deployment_name}}),f.value=e(xe(f.value,"model_define"),f.value,"model_define")})};return ee(async()=>{var l,d,S,u,L;if(await R(),!((l=v.value)!=null&&l.model_config_id)||!((d=v.value)!=null&&d.use_model)){if(f.value.length>0){let y=f.value[0];if(y){let c=y.children[0];a.use_model=c.name,a.model_config_id=c.model_config_id}}}else a.use_model=((S=v.value)==null?void 0:S.use_model)+"$$",a.model_config_id=((u=v.value)==null?void 0:u.model_config_id)+"$$",a.use_model=a.use_model.split("$$")[0],a.model_config_id=(L=v.value)==null?void 0:L.model_config_id.split("$$")[0]}),i({handleRecallTest:F}),(l,d)=>{const S=te,u=He,L=de;return _(),p("div",Pt,[t("div",Ht,[t("div",Jt,[r(Ft,{librarySearchData:v.value},null,8,["librarySearchData"])]),z.value?(_(),p("div",Yt,[t("div",Xt,[r(u,{class:"search-input",onPressEnter:n,value:s.value,"onUpdate:value":d[1]||(d[1]=y=>s.value=y),"allow-clear":"",placeholder:"输入关键词搜索"},{suffix:b(()=>[t("div",{class:"search-icon-box",onClick:n},[r(S,{class:"search-icon",name:"search-right"})])]),_:1},8,["value"])]),!w.value&&$.messageObj.finish&&!x.value.length?(_(),j(Dt,{key:0,style:{"margin-top":"100px"},size:"250"},{default:b(()=>d[4]||(d[4]=[t("div",null,[t("p",{style:{color:"#262626","font-size":"16px","font-weight":"600","line-height":"24px"}},"暂无任何内容")],-1)])),_:1,__:[4]})):(_(),p("div",Zt,[t("div",Wt,[r(S,{class:"nav-icon",name:"search-tip"}),$.messageObj.finish?(_(),p("span",ts,"智能回答生成完毕")):(_(),p("span",es,"智能回答生成中..."))]),!$.messageObj.content&&!$.messageObj.finish&&!$.isError?(_(),p("div",ss,d[5]||(d[5]=[he('<div class="rect-container rect1" data-v-f065da1f><div class="rect" data-v-f065da1f></div></div><div class="rect-container rect2" data-v-f065da1f><div class="rect" data-v-f065da1f></div></div><div class="rect-container rect3" data-v-f065da1f><div class="rect" data-v-f065da1f></div></div>',3)]))):(_(),p("div",as,[w.value?(_(),p("div",{key:0,innerHTML:w.value},null,8,os)):(_(),p("div",ls,"暂无任何内容"))])),t("div",ns,[d[7]||(d[7]=t("div",{class:"tips"},[t("div",{class:"tips-text"},"以上内容由大模型生成"),t("div",{class:"tips-line"})],-1)),x.value.length?(_(),p("div",is,[d[6]||(d[6]=O("相关分段 ")),t("div",null,"("+T(x.value.length)+")",1)])):V("",!0),(_(!0),p(D,null,G(x.value,y=>(_(),p("div",{class:"section-item",key:y.id},[t("div",rs,[t("div",ds,[r(S,{class:"section-item-icon",name:"document"}),t("div",{class:"section-item-label",onClick:c=>g(y)},[O(T(y.file_name),1),y.file_name?V("",!0):(_(),p("span",_s,T(y.library_name)+"-精选",1))],8,cs)]),t("div",ms,"相似度："+T(m(y.similarity)),1)]),r(L,{overlayClassName:"search-content-tip",placement:"top"},{title:b(()=>[O(T(y.content),1)]),default:b(()=>[t("div",{class:"section-item-content",innerHTML:U(y.content,s.value)},null,8,us)]),_:2},1024)]))),128))])]))])):(_(),p("div",Gt,[d[2]||(d[2]=t("div",{class:"search-label"},"知识搜索",-1)),d[3]||(d[3]=t("div",{class:"search-tip"},"快速搜索所选择的知识库中内容",-1)),t("div",Qt,[r(u,{class:"search-input",onPressEnter:n,value:s.value,"onUpdate:value":d[0]||(d[0]=y=>s.value=y),"allow-clear":"",placeholder:"输入关键词搜索"},{suffix:b(()=>[t("div",{class:"search-icon-box",onClick:n},[r(S,{class:"search-icon",name:"search-right"})])]),_:1},8,["value"])])]))])])}}},vs=X(ps,[["__scopeId","data-v-f065da1f"]]),fs={class:"cu-tabs"},hs=["onClick"],gs={__name:"contain-tabs",props:{value:{type:[Number,String],required:!0},tabs:{type:Array,required:!0,default:()=>[]}},emits:["update:value","change"],setup($,{emit:i}){const M=i,I=$,k=N=>{M("update:value",N),M("change",N)};return(N,w)=>(_(),p("div",fs,[(_(!0),p(D,null,G($.tabs,s=>(_(),p("div",{class:ne(["tab-item",{active:I.value===s.value}]),onClick:z=>k(s.value),key:s.value},T(s.title),11,hs))),128))]))}},ys=X(gs,[["__scopeId","data-v-9397dcbb"]]),ks=ie("searchStore",{state:()=>({indeterminate:!1,checkAll:!1,checkedList:[],activeKey:"all"}),getters:{getIndeterminate(){return this.indeterminate},getCheckAll(){return this.checkAll},getCheckedList(){return this.checkedList},getActiveKey(){return this.activeKey}},actions:{setIndeterminate($){this.indeterminate=$},setCheckAll($){this.checkAll=$},setCheckedList($){this.checkedList=$},setActiveKey($){this.activeKey=$}},persist:{enabled:!0,strategies:[{key:"searchStore",storage:localStorage,paths:["indeterminate","checkAll","checkedList","activeKey"]}]}}),bs=ie("search-lirary",()=>{const $=Je(),i=Y({reasoning_content:"",show_reasoning:!1,content:"",quote_file:[],id:"",finish:!1,debug:[],error:[],recall_time:0,request_time:0,loading:!1});let M=null;const I=C(0),k=C(""),N=Y({context_pair:"",create_time:"",id:"",max_token:"",model_config_id:"",rerank_model_config_id:"",rerank_status:"",rerank_use_model:"",search_type:"",similarity:"",size:"",temperature:"",update_time:"",use_model:"",user_id:""}),w=(x,n)=>{if(x=="reasoning_content"){let m=i.reasoning_content||"";i.reasoning_content=m+n,i.show_reasoning=!0}if(x=="sending"){let m=i.content||"";i.content=m+n}if(x=="quote_file"&&(i.quote_file=n.length>0?n:[]),x=="ai_message"){if(n.menu_json&&n.msg_type==2){let m=JSON.parse(n.menu_json);i.question=m.question}i.id=n.id,i.content=n.content,n.quote_file&&typeof n.quote_file=="string"&&(i.quote_file=JSON.parse(n.quote_file))}x=="finish"&&(i.finish=!0),x=="debug"&&(i.debug=n.length>0?n:[]),x=="error"&&(i.error=n.length>0?n:[]),x=="recall_time"&&(i.recall_time=n||0),x=="request_time"&&(i.request_time=n||0),$.emit("updateAiMessage",i)},s=()=>{i.loading=!1};return{searchFormState:N,dialogue_id:I,openid:k,messageObj:i,getLibrarySearchFn:async()=>{M&&(M.abort(),M=null);const x=await Ce();try{let n=x.data;Object.assign(N,{...n})}catch(n){Promise.reject(n)}return x},searchMessage:(x,n,m)=>{Le(32),i.content="",i.finish=!1;let U={model_config_id:m.model_config_id,use_model:m.use_model,temperature:m.temperature,max_token:m.max_token,size:m.size,similarity:m.similarity,search_type:m.search_type,question:x,id:n.join(","),recall_type:1};m.rerank_status&&(U.rerank_status=m.rerank_status),m.rerank_use_model&&(U.rerank_use_model=m.rerank_use_model),m.prompt&&(U.prompt=m.prompt),m.rerank_status==1&&(U.rerank_model_config_id=m.rerank_model_config_id),M=we(U),M.onMessage=g=>{if(g.event!=="sending"&&Ae(g),g.event=="dialogue_id"&&(I.value=g.data),g.event=="reasoning_content"&&w("reasoning_content",g.data),g.event=="sending"&&w("sending",g.data),g.event=="ai_message"){let v=JSON.parse(g.data);w("ai_message",v)}if(g.event=="quote_file"){let v=JSON.parse(g.data);w("quote_file",v)}if(g.event=="finish"&&w("finish",g.data),g.event=="debug"){let v=JSON.parse(g.data);w("debug",v)}if(g.event=="error"){let v=g.data;w("error",v)}if(g.event=="recall_time"){let v=g.data;w("recall_time",v)}},M.onClose=()=>{s(),M=null}}}}),xs={class:"chat-monitor-page"},$s={class:"page-left"},Ss={class:"toolbar-box"},Ls={class:"library-checkbox-box"},ws={class:"app-list-box"},As={class:"list-box",ref:"scrollContainer"},Cs={class:"list-item"},Ms={class:"list-item-box"},Rs={class:"library-icon"},Ns=["onClick"],qs={class:"page-body"},Is={__name:"index",setup($){const i=ks();let{getIndeterminate:M,getCheckAll:I,getCheckedList:k,getActiveKey:N}=oe(i);const w=bs(),{getLibrarySearchFn:s,searchMessage:z}=w,{messageObj:E}=oe(w),x=C(null),n=C(null),m=C("all"),U=C([{title:"全部",value:"all"},{title:"普通",value:"0"},{title:"问答",value:"2"}]),g=C({}),v=C([]),a=Y({indeterminate:!1,checkAll:!1,checkedList:[]}),P=c=>{g.value=c},F=C(!1),f=async c=>{var q;F.value=!1;let A=await s();if(n.value=A.data,n.value.id||(n.value=Object.assign(g.value)),!n.value.model_config_id||!n.value.use_model)return F.value=!0,Z("请在搜索设置中配置好相应配置后再使用");(q=x.value)==null||q.handleRecallTest(n.value),z(c,a.checkedList,n.value)},e=c=>{Object.assign(a,{checkedList:c.target.checked?v.value.map(A=>A.id):[],indeterminate:!!a.checkedList.length&&a.checkedList.length<v.value.length}),i.setCheckedList(a.checkedList),i.setIndeterminate(a.indeterminate)},R=c=>{i.setCheckedList(c)},l=c=>{window.open(`#/library/details/knowledge-document?id=${c}`)};W(()=>a.checkedList,c=>{a.indeterminate=!!c.length&&c.length<v.value.length,a.checkAll=c.length>=v.value.length,i.setIndeterminate(a.indeterminate),i.setCheckAll(a.checkAll)});const d=()=>{v.value.forEach(c=>{c.type==0,c.type==2}),U.value=[{title:"全部",value:"all"},{title:"普通",value:"0"},{title:"问答",value:"2"}]},S=(c,A)=>{if(A.length===0)return!1;const q=new Set(c);return A.every(B=>q.has(B))},u=(c,A)=>!A.some(q=>c.includes(q)),L=async()=>{let c=m.value==="all"?"":m.value;await Me({type:c}).then(A=>{var H;let q=A.data||[];q.forEach(h=>{h.file_size_str=Re(h.file_size),h.avatar||(h.avatar=h.type==0?Ne:qe)}),v.value=q;const B=v.value.map(h=>h.id);if((H=k.value)!=null&&H.length&&(B!=null&&B.length)){const h=k.value,o=B,J=S(h,o),ce=u(h,o),se=h.length>=o.length&&J,ae={checkAll:se,indeterminate:!se&&!ce};i.$patch(ae),Object.assign(a,ae)}else{const h={checkAll:!1,indeterminate:!1};i.$patch(h),Object.assign(a,h)}a.checkedList=k.value,a.indeterminate=M.value,!I.value&&k.value.length==0&&!M.value&&N.value=="all"&&(i.setCheckAll(!0),a.checkedList=B,i.setCheckedList(B)),m.value==="all"&&d()})},y=c=>{i.setActiveKey(c),L()};return ee(async()=>{N.value&&(m.value=N.value),await L();let c=await s();n.value=c.data}),ge(()=>{}),(c,A)=>{const q=Ge,B=Ye,H=Qe;return _(),p("div",xs,[t("div",$s,[t("div",Ss,[r(ys,{tabs:U.value,value:m.value,"onUpdate:value":A[0]||(A[0]=h=>m.value=h),onChange:y},null,8,["tabs","value"])]),t("div",Ls,[t("div",ws,[r(q,{checked:a.checkAll,"onUpdate:checked":A[1]||(A[1]=h=>a.checkAll=h),indeterminate:a.indeterminate,onChange:e},{default:b(()=>A[3]||(A[3]=[O(" 全选/取消 ")])),_:1,__:[3]},8,["checked","indeterminate"])]),r(H,{value:a.checkedList,"onUpdate:value":A[2]||(A[2]=h=>a.checkedList=h),onChange:R},{default:b(()=>[t("div",As,[(_(!0),p(D,null,G(v.value,h=>(_(),p("div",{class:"list-item-wraapper",key:h.id},[t("div",Cs,[r(q,{value:h.id},null,8,["value"]),t("div",Ms,[t("div",Rs,[r(B,{preview:!1,width:32,src:h.avatar},null,8,["src"])]),t("div",{class:"library-name",onClick:o=>l(h.id)},T(h.library_name),9,Ns)])])]))),128))],512)]),_:1},8,["value"])])]),t("div",qs,[r(vs,{ref_key:"searchBoxRef",ref:x,onDefaultParmas:P,onSearch:f,isError:F.value,messageObj:K(E),librarySearchData:n.value,library_ids:a.checkedList},null,8,["isError","messageObj","librarySearchData","library_ids"])])])}}},Ca=X(Is,[["__scopeId","data-v-1cd61309"]]);export{Ca as default};
