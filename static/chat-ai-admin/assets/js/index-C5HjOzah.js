import{e as h,B as se,x as W,w as N,M as u,N as p,W as e,k as S,S as D,F as R,$ as V,u as A,Q as oe,Y as M,Z as $,ai as ae,a6 as De,G as Q,a1 as P,a2 as Y,a7 as O,z as ee,a4 as Ie,a5 as we,a9 as Ce,D as Ee}from"./vue-chunks-BjMuQ6KD.js";import{n as I,k as Le,b as j,by as te,B as He,M as Me}from"../../index-CfxQ5aRu.js";import{a as Be,_ as Oe}from"./RadioButton-_iRIgmgW.js";import{R as Re}from"./dayjs-CE2mlg3S.js";import{_ as le}from"./empty-DkpCLaix.js";import{_ as Ae}from"./useIM-CliBsTXv.js";import{S as Ue}from"./index-BLP-Fxny.js";import{u as qe}from"./robot-Buya70Kq.js";import{u as ze}from"./chat-DyZefrwF.js";import{c as Ne}from"./index-D7LnsHib.js";import{_ as Ve}from"./index-Bh6cuFuE.js";import{S as Pe,_ as Ye}from"./index-BuS_bfCI.js";import{_ as je}from"./Search-DozVr2pE.js";import{_ as Fe}from"./index-D8Y0HnA5.js";import"./axios-Cm0UX6qg.js";import"./qs-DjdPq-RR.js";import"./crypto-js-BemCeW_6.js";import"./dayjs-DK4rpucX.js";import"./FormItemContext-DQ1b1ToO.js";import"./Checkbox-DQe8ZxR1.js";import"./index-BGu3mc-Q.js";import"./index-C3Es6Ui_.js";import"./colors-C9XVGyX_.js";import"./CheckOutlined-BLsT0eZM.js";import"./Trigger-Dy6Dc2CN.js";import"./ResizeObserver.es-B1PUzC5B.js";import"./shallowequal-B6gQS78g.js";import"./index-D6-G2N0k.js";import"./move-BjmscfYf.js";import"./slide-BYYxYcj9.js";import"./index-CXSrVsd0.js";import"./index-BLNMWHkL.js";import"./index-W8wCYhw3.js";import"./useEventBus-DCQvkgIt.js";import"./DownOutlined-Gk0UBxct.js";import"./SearchOutlined-B7dGgS_P.js";import"./Input-C5WaaE9Z.js";import"./inputProps-D7qr__m5.js";import"./isPlainObject-xAKL-sfk.js";const Ge={class:"zm-date"},Qe={class:"date-btn"},We={class:"date-content"},Ze={__name:"date",props:{datekey:{type:String,default:"1"}},emits:["dateChange"],setup(c,{emit:E}){const w=c,i=h(1),d=E;let b=se([{label:"今日",value:!0,key:2,start_time:I().startOf("day"),end_time:I().endOf("day")},{label:"昨日",value:!1,key:3,start_time:I().subtract(1,"day").startOf("day"),end_time:I().startOf("day").subtract(1,"millisecond")},{label:"近7日",value:!1,key:4,start_time:I().subtract(6,"day").startOf("day"),end_time:I().endOf("day").subtract(1,"millisecond")}]);const _=h(null),s=h(null),m=h([]),a=y=>y>=I().subtract(0,"day"),x=()=>{let y=i.value,n=null;b.forEach(o=>{o.key==y&&(n=o)}),n&&(m.value=[n.start_time,n.end_time],_.value=n.start_time.unix(),s.value=n.end_time.unix()),H()},L=y=>{const n=I(y[0]).startOf("day");if(I(y[1]).endOf("day").diff(n,"days")>29)m.value[0]=y[0].startOf("day"),m.value[1]=n.add(29,"days").endOf("day"),_.value=m.value[0].unix(),s.value=m.value[1].unix(),Le.error("最多只能选择30天");else{const g=I(y[0]).startOf("day").unix(),v=I(y[1]).endOf("day").unix();m.value=y,_.value=g,s.value=v}i.value=1,H()},H=()=>{d("dateChange",{start_time:_.value,end_time:s.value})};return W(()=>{i.value=parseInt(w.datekey),x()}),N(()=>w.datekey,(y,n)=>{i.value=parseInt(w.datekey.split("-")[0]),x()}),(y,n)=>{const o=Be,g=Oe,v=Re;return u(),p("div",Ge,[e("div",Qe,[S(g,{value:i.value,"onUpdate:value":n[0]||(n[0]=l=>i.value=l),onChange:x},{default:D(()=>[(u(!0),p(R,null,V(A(b),l=>(u(),oe(o,{class:"date-btn-button",value:l.key,key:l.key},{default:D(()=>[M($(l.label),1)]),_:2},1032,["value"]))),128))]),_:1},8,["value"])]),e("div",We,[S(v,{value:m.value,"onUpdate:value":n[1]||(n[1]=l=>m.value=l),onChange:L,format:"YYYY-MM-DD",disabledDate:a,allowClear:!1},null,8,["value"])])])}}},Z=c=>(P("data-v-cd7bf51c"),c=c(),Y(),c),Je={key:0,class:"empty-box"},Ke=Z(()=>e("img",{src:le,alt:""},null,-1)),Xe=Z(()=>e("div",{class:"title"},"暂无结果，请重试",-1)),et=[Ke,Xe],tt=["onClick"],st={class:"user-item-left"},ot=["src"],at={class:"user-item-right"},lt={class:"user-name-box"},nt={class:"user-name"},rt={class:"user-timer"},ct={class:"user-info"},it={class:"user-source-box"},ut=Z(()=>e("div",{class:"user-source-title"},"来自：",-1)),dt={class:"user-source-content"},_t={__name:"user",props:{userList:{type:Array,default:null},channelItem:{type:Array,default:null}},emits:["userClick","userScroll","userScrollStart","userScrollEnd"],setup(c,{emit:E}){const w=h(null),i=c,d=E,b=h([]),_=h([]),s=h({}),m=o=>{s.value=o,d("userClick",o)},a={scrollTop:0,scrollHeight:0,clientHeight:0,scrollStartDiff:60,scrollEndDiff:60,scrollDirection:""};let x=null;function L(o){x&&(clearTimeout(x),x=null),x=setTimeout(()=>{a.scrollTop-o.target.scrollTop>0&&(a.scrollDirection="up"),a.scrollTop-o.target.scrollTop<0&&(a.scrollDirection="down"),a.scrollTop=o.target.scrollTop,a.scrollHeight=o.target.scrollHeight,a.clientHeight=o.target.clientHeight,d("userScroll",{...a}),Math.abs(a.scrollTop)<=a.scrollStartDiff+100&&a.scrollDirection==="up"&&H(),Math.abs(a.scrollHeight-a.scrollTop-a.clientHeight)<=a.scrollEndDiff&&a.scrollDirection==="down"&&y()},50)}function H(){i.userList.length!=0&&d("userScrollStart",{msg:i.userList[0]})}function y(){i.userList.length!=0&&d("userScrollEnd",{msg:i.userList[i.userList.length-1]})}N(()=>i.userList,o=>{b.value=o,b.value.length>0&&b.value.length<=20&&(m(b.value[0]),s.value=b.value[0])},{immediate:!0}),N(()=>i.channelItem,o=>{_.value=o},{immediate:!0});const n=o=>{for(let g=0;g<_.value.length;g++)if(o.app_type==_.value[g].app_type&&(o.app_id||"")==_.value[g].app_id)return _.value[g].app_name};return W(()=>{b.value=i.userList,_.value=i.channelItem}),(o,g)=>{const v=ae("ftime");return u(),p("div",{class:"user-content",ref_key:"scrollUserBoxRef",ref:w,onScroll:L},[b.value.length===0?(u(),p("div",Je,et)):(u(!0),p(R,{key:1},V(b.value,l=>(u(),p("div",{class:De(["user-item",{active:l.openid==s.value.openid}]),onClick:t=>m(l),key:l.session_id},[e("div",st,[e("img",{class:"user-img",src:l.avatar,alt:""},null,8,ot)]),e("div",at,[e("div",lt,[e("div",nt,$(l.name),1),Q((u(),p("div",rt,[M($(l.last_chat_time),1)])),[[v,"MM-DD HH:mm"]])]),e("div",ct,$(l.last_chat_message),1),e("div",it,[ut,e("div",dt,$(n(l)),1)])])],10,tt))),128))],544)}}},pt=j(_t,[["__scopeId","data-v-cd7bf51c"]]),ne=c=>(P("data-v-d72a9ab3"),c=c(),Y(),c),mt={class:"message-box"},vt={class:"message-top-box"},ft={class:"message-top-title"},gt={key:0,class:"message-top-source"},ht={class:"message-list"},yt={key:0,class:"empty-box"},St=ne(()=>e("img",{src:le,alt:""},null,-1)),bt=ne(()=>e("div",{class:"title"},"暂无结果，请重试",-1)),Tt=[St,bt],kt=["id"],$t={class:"itme-right"},xt={class:"message-info"},Dt={class:"item-body"},It={class:"message-content"},wt={class:"user-avatar-box"},Ct=["src"],Et=["id"],Lt={class:"itme-left"},Ht=["src"],Mt={class:"itme-right"},Bt={class:"message-info"},Ot={class:"item-body"},Rt={key:0,class:"message-content"},At=["innerHTML"],Ut={key:2,class:"message-content"},qt=["src"],zt={key:2,class:"loading-box"},Nt={__name:"message-list",props:{messages:{type:Array,default:()=>[]},robotInfo:{type:Object,default:()=>{}},isEmpty:{type:Boolean,default:()=>!1},sessionSource:{type:String,default:()=>null},channelItem:{type:Array,default:()=>[]}},emits:["scroll","scrollStart","scrollEnd"],setup(c,{expose:E,emit:w}){const i=w,d=c,b=h(!1),_=h(null),s={scrollTop:0,scrollHeight:0,clientHeight:0,scrollStartDiff:60,scrollEndDiff:60,scrollDirection:""};let m=null,a=!1;const x=v=>{let l;for(let t=0;t<d.channelItem.length;t++){const T=d.channelItem[t];T.app_type===v&&(l=T.app_name)}return l};function L(v){a||(m&&(clearTimeout(m),m=null),m=setTimeout(()=>{s.scrollTop-v.target.scrollTop>0&&(s.scrollDirection="up"),s.scrollTop-v.target.scrollTop<0&&(s.scrollDirection="down"),s.scrollTop=v.target.scrollTop,s.scrollHeight=v.target.scrollHeight,s.clientHeight=v.target.clientHeight,i("scroll",{...s}),Math.abs(s.scrollTop)<=s.scrollStartDiff&&s.scrollDirection==="up"&&H(),Math.abs(s.scrollHeight-s.scrollTop-s.clientHeight)<=s.scrollEndDiff&&s.scrollDirection==="down"&&y()},100))}function H(){d.messages.length!=0&&i("scrollStart",{msg:d.messages[0]})}function y(){d.messages.length!=0&&i("scrollEnd",{msg:d.messages[d.messages.length-1]})}const n=()=>{_.value&&ee(()=>{a=!0,_.value.scrollTop=_.value.scrollHeight+1,setTimeout(()=>{s.scrollTop=_.value.scrollTop,a=!1},50)})};function o(v,l){ee(()=>{a=!0,l||(l="top");let t=_.value,T=document.querySelector("#msg-"+v);T&&(l=="top"?t.scrollTop=T.offsetTop:t.scrollTop=T.offsetTop-t.clientHeight+T.clientHeight),setTimeout(()=>{s.scrollTop=_.value.scrollTop,a=!1},50)})}function g(){s.scrollTop=0,s.scrollDirection=""}return E({scrollToBottom:n,scrollToMessage:o,resetScroll:g}),(v,l)=>{const t=Ue,T=ae("viewer");return u(),p("div",mt,[e("div",vt,[e("div",ft,$(d.robotInfo.robot_name),1),c.sessionSource?(u(),p("div",gt,"("+$(x(c.sessionSource))+")",1)):O("",!0)]),e("div",{class:"message-list-wrapper",ref_key:"scrollBoxRef",ref:_,onScroll:L},[e("div",ht,[d.isEmpty||!d.messages?(u(),p("div",yt,Tt)):(u(!0),p(R,{key:1},V(d.messages,f=>(u(),p(R,{key:f.uid},[f.is_customer==1?(u(),p("div",{key:0,class:"message-item user-message",id:"msg-"+f.uid},[e("div",$t,[e("div",xt,[e("span",null,$(A(te)(f.create_time)),1),e("span",null,$(f.name),1)]),e("div",Dt,[e("div",It,$(f.content),1)])]),e("div",wt,[e("img",{class:"user-avatar",src:f.avatar},null,8,Ct)])],8,kt)):(u(),p("div",{key:1,class:"message-item robot-message",id:"msg-"+f.uid},[e("div",Lt,[S(t,{size:"small",spinning:f.loading},{default:D(()=>[e("img",{class:"robot-avatar",src:f.robot_avatar},null,8,Ht)]),_:2},1032,["spinning"])]),e("div",Mt,[e("div",Bt,[e("span",null,$(A(te)(f.create_time)),1),e("span",null,$(f.name),1)]),e("div",Ot,[f.msg_type==1?Q((u(),p("div",Rt,[S(Ae,{content:f.content},null,8,["content"])])),[[T]]):O("",!0),f.msg_type==2?(u(),p("div",{key:1,class:"message-content",innerHTML:f.menu_json.content},null,8,At)):O("",!0),f.msg_type==3?(u(),p("div",Ut,[Q(e("img",{class:"msg-img",src:f.content,alt:""},null,8,qt),[[T]])])):O("",!0)])])],8,Et))],64))),128)),b.value?(u(),p("div",zt,[S(t)])):O("",!0)])],544)])}}},Vt=j(Nt,[["__scopeId","data-v-d72a9ab3"]]),re=c=>(P("data-v-58295e83"),c=c(),Y(),c),Pt={class:"team-members-pages"},Yt={class:"set-model"},jt=re(()=>e("div",{class:"label set-model-label"},"渠道：",-1)),Ft={class:"set-model-body"},Gt={class:"set-date"},Qt=re(()=>e("div",{class:"label set-date-label"},[e("span",null,"日期：")],-1)),Wt={class:"set-date-body"},Zt={class:"set-name"},Jt={class:"set-reset"},Kt={class:"list-box"},Xt={class:"user-box"},es={class:"records-box"},ts={__name:"session-record",setup(c){const E=h(!1),w=Ie(),i=we(),d=i.query,b=qe(),{robotInfo:_}=b,s=ze(),{messageList:m}=Ce(s);let a=!0;const{createMsg:x,onGetChatMessage:L,getRecordList:H,getChannelList:y}=s,n=h(null),o=h([]),g=h([]),v=h(""),l=h("1"),t=se({robot_id:d.id,app_type:"all",app_id:"",start_time:"",end_time:"",name:"",page:1,size:20}),T=h(!1),f=r=>{t.start_time=r.start_time,t.end_time=r.end_time,G()},ce=()=>{t.app_type="all",t.name="",t.page=1,l.value="1-"+Math.random()},U=h(!1),F=h(!1),ie=async()=>{let r=J();F.value=!0,await Ne(r),U.value=!0,F.value=!1},ue=()=>{w.push({path:"/robot/config/export-record",query:d})},G=()=>{t.page=1,K()},de=r=>{t.app_type=r,G()},_e=()=>{},pe=r=>{v.value=r.app_type,Se(r)},me=async()=>{},ve=()=>{T.value&&(t.page++,K())},fe=async()=>{a=!1;let r=m.value[0].uid;await L()&&he(r)},ge=()=>{n.value&&a&&n.value.scrollToBottom()},he=r=>{n.value&&n.value.scrollToMessage(r)},ye=()=>{n.value&&n.value.resetScroll()};let q=null;const Se=async r=>{a=!0;let B={robot_key:(i.query||{}).robot_key,avatar:r.avatar,name:r.name,nickname:r.name,is_background:1,openid:r.openid};ye(),await x(B),q&&(clearTimeout(q),q=null),q=setTimeout(async()=>{await L()&&ge()},100)},be=async()=>{const r=await y();o.value=[{app_type:"all",app_name:"全部渠道"},...r.data]},J=()=>{let r={robot_id:t.robot_id,start_time:t.start_time,end_time:t.end_time,name:t.name,page:t.page,size:t.size};return t.app_type!=="all"&&(r.app_type=t.app_type),r},K=async()=>{let r=J(),k=await H(r),B=k.data.list||[];t.page==1&&(g.value=[]),g.value=[...g.value,...B],E.value=g.value.length==0,T.value=k.data.has_more};return N(()=>m.value,()=>{}),W(async()=>{be()}),Ee(()=>{}),(r,k)=>{const B=Pe,X=Ye,Te=je,z=He,ke=Fe,$e=Ve,xe=Me;return u(),p("div",Pt,[S(ke,{justify:"flex-start",class:"screen-box"},{default:D(()=>[e("div",Yt,[jt,e("div",Ft,[S(X,{value:t.app_type,"onUpdate:value":k[0]||(k[0]=C=>t.app_type=C),placeholder:"全部渠道",onChange:de,style:{width:"200px"}},{default:D(()=>[(u(!0),p(R,null,V(o.value,C=>(u(),oe(B,{key:C.app_type,value:C.app_type},{default:D(()=>[e("span",null,$(C.app_name),1)]),_:2},1032,["value"]))),128))]),_:1},8,["value"])])]),e("div",Gt,[Qt,e("div",Wt,[S(Ze,{onDateChange:f,datekey:l.value},null,8,["datekey"])])]),e("div",Zt,[S(Te,{value:t.name,"onUpdate:value":k[1]||(k[1]=C=>t.name=C),placeholder:"请输入用户名称搜索",style:{width:"200px"},onSearch:G},null,8,["value"])]),e("div",Jt,[S(z,{onClick:ce},{default:D(()=>[M("重置")]),_:1}),S(z,{onClick:ie,loading:F.value},{default:D(()=>[M("导出")]),_:1},8,["loading"])])]),_:1}),e("div",Kt,[e("div",Xt,[S(pt,{channelItem:o.value,userList:g.value,onUserScrollStart:me,onUserScrollEnd:ve,onUserClick:pe},null,8,["channelItem","userList"])]),e("div",es,[S(Vt,{ref_key:"messageListRef",ref:n,isEmpty:E.value,messages:A(m),robotInfo:A(_),channelItem:o.value,sessionSource:v.value,onScrollStart:fe,onScrollEnd:_e},null,8,["isEmpty","messages","robotInfo","channelItem","sessionSource"])])]),S(xe,{open:U.value,"onUpdate:open":k[3]||(k[3]=C=>U.value=C),title:null,footer:null,width:640},{default:D(()=>[S($e,{status:"success",title:"导出任务创建成功","sub-title":"系统会在后台导出。导出数据量越大，耗时越久。您可以稍后点击导出记录查看并下载导出的文件。"},{extra:D(()=>[S(z,{style:{"margin-right":"16px"},onClick:k[2]||(k[2]=C=>U.value=!1)},{default:D(()=>[M("知道了")]),_:1}),S(z,{onClick:ue,type:"primary"},{default:D(()=>[M("去下载")]),_:1})]),_:1})]),_:1},8,["open"])])}}},ss=j(ts,[["__scopeId","data-v-58295e83"]]),os=c=>(P("data-v-705cfb21"),c=c(),Y(),c),as={class:"user-model-page"},ls=os(()=>e("div",{class:"page-title"},"会话记录",-1)),ns={class:"list-wrapper"},rs={__name:"index",setup(c){return(E,w)=>(u(),p("div",as,[ls,e("div",ns,[S(ss)])]))}},Gs=j(rs,[["__scopeId","data-v-705cfb21"]]);export{Gs as default};
