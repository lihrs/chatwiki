import{K as le,M as n,N as r,k as R,X as ce,W as a,U as X,Y as H,Z as p,a9 as U,e as $,w as Z,z as j,x as ee,D as te,u as T,Q as q,F as M,$ as I,a6 as P,a7 as x,a1 as E,a2 as V,S as D,I as se,aa as Y,a4 as re,ai as de,G as ue}from"./vue-chunks-BjMuQ6KD.js";import{u as oe}from"./useEventBus-DCQvkgIt.js";import{g as _e}from"./index-W8wCYhw3.js";import{cN as W,f as he,by as G,aD as K,b as B,d as Q,bu as pe}from"../../index-CfxQ5aRu.js";import{u as me,_ as ve}from"./useIM-CliBsTXv.js";import{B as A,M as fe,S as ge,P as ye}from"./pull-up.esm-JZ91zQ8P.js";import{O as be}from"./observe-dom.esm-DPKTicVt.js";import{S as Le}from"./index-BLP-Fxny.js";import{a as ke}from"./index-D7LnsHib.js";import{_ as Se}from"./index-Ch1-3QsQ.js";import"./index-DcUUFn-g.js";import{I as Te}from"./Input-C5WaaE9Z.js";import{_ as $e,S as Ce}from"./index-BuS_bfCI.js";import"./axios-Cm0UX6qg.js";import"./qs-DjdPq-RR.js";import"./crypto-js-BemCeW_6.js";import"./dayjs-DK4rpucX.js";import"./index-BLNMWHkL.js";import"./FormItemContext-DQ1b1ToO.js";import"./index-D6-G2N0k.js";import"./Search-DozVr2pE.js";import"./SearchOutlined-B7dGgS_P.js";import"./isPlainObject-xAKL-sfk.js";import"./inputProps-D7qr__m5.js";import"./TextArea-CN_AI7y7.js";import"./index-CXSrVsd0.js";import"./ResizeObserver.es-B1PUzC5B.js";import"./Password-BCnVcrNJ.js";import"./Trigger-Dy6Dc2CN.js";import"./slide-BYYxYcj9.js";import"./CheckOutlined-BLsT0eZM.js";import"./DownOutlined-Gk0UBxct.js";import"./move-BjmscfYf.js";const we=(t={})=>W.get({url:"/manage/getReceiverList",params:t}),Re=(t={})=>W.post({url:"/chat/message",data:t}),xe=(t={})=>W.post({url:"/manage/setReceiverRead",data:t}),F=le("chatMonitor",{state:()=>({im:null,selectedRobotId:"",robotList:[],selectedReceiverId:"",receiverList:[],receiverListPage:{page:0,size:10},activeChat:null,chatMessagePageSize:10,messageList:[],messageListScrollTop:0,chatMessageLoadCompleted:!1,messageListLoading:!1}),getters:{},actions:{async init(){this.selectedRobotId="",this.selectedReceiverId="",this.robotList=[],this.receiverList=[],this.messageList=[],this.receiverListPage={page:0,size:10},this.messageListScrollTop=0,this.chatMessageLoadCompleted=!1,this.messageListLoading=!1,this.activeChat=null,await this.getRobotList(),await this.getReceiverList(),this.receiverList.length>0&&await this.switchChat(this.receiverList[0]),this.initIM()},closeIM(){this.im&&this.im.close()},initIM(){const t=me(),c=he();this.im=t,t.connect(c.user_id),t.on("message",e=>{!e.data||e.msg_type!=="receiver_notify"||((e.change=="create"||e.change=="update")&&this.onAddReceiver(e),e.change=="delete"&&this.onDeleteReceiver(e),(e.change=="c_message"||e.change=="ai_message")&&this.onAddMessage(e))})},onAddMessage(t){if(!this.activeChat)return;const c=oe();let e=t.data;this.activeChat.session_id==e.session_id&&(e.displayName=e.name||e.nickname,e.dispayTime=G(e.create_time),e.uid=K(32),e.loading=!1,e.menu_json&&typeof e.menu_json=="string"&&(e.menu_json=JSON.parse(e.menu_json)),e.quote_file&&typeof e.quote_file=="string"&&(e.quote_file=JSON.parse(e.quote_file)),this.messageList.push(e),c.emit("onAddMessage",e))},onAddReceiver(t){let c=t.data;c.displayName=c.name||c.nickname,c.come_from=JSON.parse(c.come_from);let e=this.receiverList.find(o=>o.session_id==c.session_id);e?Object.assign(e,c):(this.selectedRobotId==""||this.selectedRobotId==c.robot_id)&&this.receiverList.unshift(c)},onDeleteReceiver(t){let c=t.data,e=this.receiverList.findIndex(o=>o.id==c);e!=-1&&(this.activeChat&&this.activeChat.id==c&&(this.activeChat=null),this.receiverList.splice(e,1))},async getRobotList(t){return _e(t).then(c=>(this.robotList=c.data||[],c))},async getReceiverList(t){return t!=null&&t.page?this.receiverListPage.page=t==null?void 0:t.page:this.receiverListPage.page++,we({...this.receiverListPage,robot_id:this.selectedRobotId,...t}).then(c=>{let e=c.data.list||[];for(let o=0;o<e.length;o++)e[o].displayName=e[o].name||e[o].nickname,e[o].come_from&&(e[o].come_from=JSON.parse(e[o].come_from));return this.receiverListPage.page==1?this.receiverList=e:this.receiverList=this.receiverList.concat(e),c})},changeRobot(t){this.activeChat=null,this.resetReceiverList(t)},resetReceiverList(t){return this.receiverListPage.page=0,this.receiverList=[],this.getReceiverList(t)},async getChatMessage(){if(this.messageListLoading)return;this.messageListLoading=!0;let t=0,c=this.messageList.filter(o=>!o.isWelcome);c.length>0&&(t=c[0].id);let e={robot_key:this.activeChat.robot_key,openid:this.activeChat.openid,min_id:t,size:this.chatMessagePageSize};return Re(e).then(o=>{var b,m;this.messageListLoading=!1;let s=o.data.list||[];const u=((b=o==null?void 0:o.data)==null?void 0:b.customer)||{},h=((m=o==null?void 0:o.data)==null?void 0:m.robot)||{};s.sort((i,v)=>i.id-v.id);for(let i=0;i<s.length;i++)s[i].displayName=s[i].name||s[i].nickname,s[i].is_customer==1?(s[i].displayName=s[i].displayName||u.name,s[i].avatar=s[i].avatar||u.avatar):(s[i].displayName=s[i].displayName||h.robot_name,s[i].avatar=s[i].avatar||h.robot_avatar),s[i].uid=K(32),s[i].menu_json&&typeof s[i].menu_json=="string"&&(s[i].menu_json=JSON.parse(s[i].menu_json)),s[i].quote_file&&typeof s[i].menu_json=="string"&&(s[i].quote_file=JSON.parse(s[i].quote_file)),s[i].dispayTime=G(s[i].create_time);return this.messageList=[...s,...this.messageList],s.length<this.chatMessagePageSize&&(this.chatMessageLoadCompleted=!0),o}).catch(o=>{this.messageListLoading=!1})},claerUnread(){return xe({id:this.selectedReceiverId})},async switchChat(t){this.chatMessageLoadCompleted=!1,this.messageListLoading=!1,this.messageList=[],this.messageListScrollTop=0,this.selectedReceiverId=t.id,this.activeChat=t,this.claerUnread(),await this.getChatMessage()}}}),Me={class:"no-data"},Ie={class:"no-data-text"},Ne={__name:"list-empty",props:{text:{type:String,default:"暂无数据"},size:{type:[Number,String],default:100}},setup(t){const c=t;return(e,o)=>{const s=Q;return n(),r("div",Me,[R(s,{name:"empty",style:ce({"font-size":`${c.size}px`})},null,8,["style"]),a("div",Ie,[X(e.$slots,"default",{},()=>[H(p(c.text),1)],!0)])])}}},ie=B(Ne,[["__scopeId","data-v-35f939c8"]]),De=t=>(E("data-v-4087dd63"),t=t(),V(),t),Be={key:1,class:"chat-list"},Oe=["onClick"],qe={class:"avatar"},ze=["src","alt"],Ae={class:"chat-info"},je={class:"nickname"},He={class:"last-message"},Pe={class:"webapp-source"},Ue={key:0,class:"loading-wrapper"},Fe=De(()=>a("span",{class:"loading-text"},"加载中...",-1)),Je={key:1,class:"finished-text"},Ee={__name:"chat-list ",emits:["switchChat"],setup(t,{expose:c,emit:e}){A.use(fe),A.use(ge),A.use(be),A.use(ye);const o=e,s=F(),{getReceiverList:u}=s,{receiverList:h,selectedReceiverId:b}=U(s),m=$(null);let i=null;const v=$(!1),L=$(!1),w=()=>{i=new A(m.value,{scrollY:!0,click:!0,observeDOM:!0,mouseWheel:!0,bounce:!1,scrollbar:{fade:!0,interactive:!0},pullUpLoad:!0}),i.on("pullingUp",()=>{f()})},f=async g=>{if(v.value||L.value){i.finishPullUp();return}v.value=!0;try{(await u(g)).data.list.length===0&&!g.keyword&&(L.value=!0)}catch(C){console.error("加载更多数据失败:",C)}finally{v.value=!1,i.finishPullUp()}},_=g=>{o("switchChat",g)};return Z(h,g=>{g.length>0&&j(()=>{i&&i.refresh()})}),ee(()=>{j(()=>{w()})}),te(()=>{i&&i.destroy()}),c({getData:f}),(g,C)=>{const y=Le;return n(),r("div",{class:"scroll-wrapper",ref_key:"scrollRef",ref:m},[T(h).length==0?(n(),q(ie,{key:0,size:"140",text:"暂无机器人接待中会话"})):(n(),r("div",Be,[(n(!0),r(M,null,I(T(h),l=>(n(),r("div",{key:l.id,class:P(["chat-item",{active:l.id===T(b)}]),onClick:k=>_(l)},[a("div",qe,[a("img",{src:l.avatar,alt:l.displayName},null,8,ze),l.unread>0?(n(),r("span",{key:0,class:P(["dot",{plus:l.unread>9}])},p(l.unread),3)):x("",!0)]),a("div",Ae,[a("div",je,p(l.displayName),1),a("div",He,p(l.last_chat_message),1),a("div",Pe,"来自："+p(l.come_from.app_name),1)])],10,Oe))),128)),v.value?(n(),r("div",Ue,[R(y,{size:"small"}),Fe])):x("",!0),L.value?(n(),r("div",Je,"没有更多了")):x("",!0)]))],512)}}},Ve=B(Ee,[["__scopeId","data-v-4087dd63"]]),We={__name:"chat-message-scroll",props:{topTriggerDistance:{type:Number,default:10},bottomTriggerDistance:{type:Number,default:40},isLoading:{type:Boolean,default:!1},scrollTop:{type:Number,default:0}},emits:["scroll-top","scroll-bottom","scroll"],setup(t,{expose:c,emit:e}){const o=t,s=e,u=$(null),h=$({scrollTop:0,scrollHeight:0,clientHeight:0,scrollDirection:"down",scrollStartDiff:o.topTriggerDistance,scrollEndDiff:o.bottomTriggerDistance}),b=$(null),m=_=>{const{scrollTop:g}=_,C=h.value.scrollTop-g;h.value.scrollDirection=C>0?"up":"down",Object.assign(h.value,{scrollTop:g,scrollHeight:_.scrollHeight,clientHeight:_.clientHeight})},i=()=>{const{scrollTop:_,scrollHeight:g,clientHeight:C,scrollStartDiff:y,scrollEndDiff:l,scrollDirection:k}=h.value;s("scroll",{...h.value}),o.isLoading||(Math.abs(_)<=y&&k==="up"&&s("scroll-top",{...h.value}),Math.abs(g-_-C)<=l&&k==="down"&&s("scroll-bottom",{...h.value}))},v=_=>{m(_.target),b.value&&(clearTimeout(b.value),b.value=null),b.value=setTimeout(()=>{i()},100)};function L(){u.value&&(u.value.scrollTop=0)}function w(){u.value&&(u.value.scrollTop=u.value.scrollHeight)}function f(){return u.value&&Object.assign(h.value,{scrollTop:u.value.scrollTop,scrollHeight:u.value.scrollHeight,clientHeight:u.value.clientHeight}),JSON.parse(JSON.stringify(h.value))}return Z(()=>o.scrollTop,_=>{u.value&&(u.value.scrollTop=_)}),c({scrollToTop:L,scrollToBottom:w,getState:f}),(_,g)=>(n(),r("div",{class:"chat-message-scroll",ref_key:"scrollContainer",ref:u,onScroll:v},[X(_.$slots,"default",{},void 0,!0)],544))}},Qe=B(We,[["__scopeId","data-v-23d37ca8"]]),ae=t=>(E("data-v-efc0c25f"),t=t(),V(),t),Ye={class:"chat-message-warpper"},Ge={class:"chat-message-content"},Ke={key:0,class:"is-loaded"},Xe={class:"avatar"},Ze=["src","alt"],et={class:"message-content"},tt={class:"message-info"},st={class:"nickname"},ot=ae(()=>a("i",{class:"gap"},null,-1)),it={class:"time"},at={class:"message-bubble"},nt={key:0,class:"text-content"},lt={key:1},ct={key:1,class:"image-content"},rt=["src"],dt={key:2,class:"menu-content"},ut={class:"menus-label"},_t={key:0,class:"menu-items"},ht=["onClick"],pt={key:3,class:"answer-reference-box"},mt=ae(()=>a("div",{class:"answer-reference-label"},"回答参考",-1)),vt=["onClick"],ft={__name:"chat-message",emits:["openLibrary"],setup(t,{expose:c,emit:e}){const o=e,s=$(null),u=F(),{getChatMessage:h}=u,{messageList:b,messageListScrollTop:m,messageListLoading:i,chatMessageLoadCompleted:v,activeChat:L}=U(u),w=()=>{};function f(k,S,N){let d=Y(k);S.robot_key=L.value.robot_key,S.robot_id=L.value.robot_id,d.forEach(O=>{O.message_id=N.id,O.openid=N.openid,O.robot_key=L.value.robot_key,O.robot_id=L.value.robot_id}),o("openLibrary",d,Y(S))}const _=k=>{const{scrollTop:S}=k;m.value=S},g=async()=>{if(v.value)return;let k=s.value.getState();await h(),j(()=>{let S=s.value.getState();S.scrollDirection=="up"&&(m.value=S.scrollHeight-k.scrollHeight)})},C=async()=>{};return c({scrollToTop:()=>{s.value.scrollToTop()},scrollToBottom:()=>{s.value.scrollToBottom()}}),(k,S)=>{const N=Q;return n(),r("div",Ye,[R(Qe,{ref_key:"scrollViewRef",ref:s,scrollTop:T(m),"onUpdate:scrollTop":S[0]||(S[0]=d=>se(m)?m.value=d:null),"is-loading":T(i),onScroll:_,onScrollTop:g,onScrollBottom:C},{default:D(()=>[a("div",Ge,[T(v)?(n(),r("div",Ke,"没用更多聊天记录了")):x("",!0),(n(!0),r(M,null,I(T(b),(d,O)=>(n(),r("div",{key:O,class:P(["message-item",d.is_customer==0?"right":""])},[a("div",Xe,[a("img",{src:d.avatar,alt:d.displayName},null,8,Ze)]),a("div",et,[a("div",tt,[a("span",st,p(d.displayName),1),ot,a("span",it,p(d.dispayTime),1)]),a("div",at,[d.msg_type==1?(n(),r("div",nt,[d.is_customer==0?(n(),q(ve,{key:0,content:d.content},null,8,["content"])):(n(),r("div",lt,p(d.content),1))])):d.msg_type==3?(n(),r("div",ct,[a("img",{src:d.content,alt:"image"},null,8,rt)])):d.msg_type==2?(n(),r("div",dt,[a("div",ut,p(d.menu_json.content),1),d.menu_json.question&&d.menu_json.question.length>0?(n(),r("div",_t,[(n(!0),r(M,null,I(d.menu_json.question,(z,J)=>(n(),r("div",{key:J,class:"menu-item",onClick:ne=>w(z)},p(z),9,ht))),128))])):x("",!0)])):x("",!0),d.quote_file&&d.quote_file.length?(n(),r("div",pt,[mt,a("div",null,[(n(!0),r(M,null,I(d.quote_file,(z,J)=>(n(),r("div",{class:"list-item",key:J},[R(N,{name:"attachment"}),a("span",{onClick:ne=>f(d.quote_file,z,d)},p(z.file_name),9,vt)]))),128))])])):x("",!0)])])],2))),128))])]),_:1},8,["scrollTop","is-loading"])])}}},gt=B(ft,[["__scopeId","data-v-efc0c25f"]]),yt={class:"library-info-content"},bt={class:"file-list"},Lt=["onClick"],kt={class:"document-items"},St={class:"document-item-header"},Tt={class:"left-box"},$t={class:"document-title"},Ct={key:0,class:"document-title"},wt={class:"document-size"},Rt={class:"document-item-body"},xt={class:"document-similarity"},Mt={key:0,class:"document-content"},It={key:1,class:"document-content"},Nt={class:"document-content"},Dt={class:"fragment-img"},Bt=["src"],Ot={__name:"library-info-alert",setup(t,{expose:c}){const e=re(),o=$(!1),s=$([]),u=$(null),h=()=>{s.value=[],u.value=null},b=(f,_)=>{h(),s.value=f,u.value=_.id,o.value=!0,v(_)},m=f=>{f.id!=u.value&&(u.value=f.id,v(f))},i=$([]),v=f=>{ke({message_id:f.message_id,file_id:f.id,robot_key:f.robot_key,openid:f.openid}).then(_=>{i.value=_.data||[]})},L=()=>{e.push("/library/preview?id="+u.value)},w=()=>{o.value=!1};return c({open:b}),(f,_)=>{const g=Q,C=Se,y=de("viewer");return n(),q(C,{class:"library-info-alert",open:o.value,"onUpdate:open":_[0]||(_[0]=l=>o.value=l),title:"答案来源",placement:"right",width:"746px",closable:!1,bodyStyle:{background:"#F2F4F7"}},{extra:D(()=>[a("span",{class:"close-btn",onClick:w},[R(T(pe))])]),default:D(()=>[a("div",yt,[a("div",bt,[(n(!0),r(M,null,I(s.value,l=>(n(),r("div",{class:P(["file-item",{active:u.value==l.id}]),key:l.id,onClick:k=>m(l)},p(l.file_name),11,Lt))),128))]),a("div",kt,[(n(!0),r(M,null,I(i.value,l=>(n(),r("div",{class:"document-item",key:l.id},[a("div",St,[a("div",Tt,[a("span",$t,"id："+p(l.id),1),l.title?(n(),r("span",Ct,p(l.title),1)):x("",!0),a("span",wt," 共"+p(l.word_total)+"个字符 ",1)]),a("div",{class:"right-box"},[a("a",{onClick:L},"查看源文档>")])]),a("div",Rt,[a("div",xt,[H(" 相似度： "),R(g,{name:"similarity",style:{"font-size":"16px"}}),H(p(l.similarity),1)]),l.question?(n(),r("div",Mt,"Q："+p(l.question),1)):x("",!0),l.answer?(n(),r("div",It,"A："+p(l.answer),1)):x("",!0),a("div",Nt,p(l.content),1),ue((n(),r("div",Dt,[(n(!0),r(M,null,I(l.images,(k,S)=>(n(),r("img",{key:S,src:k,alt:""},null,8,Bt))),128))])),[[y]])])]))),128))])])]),_:1},8,["open"])}}},qt=B(Ot,[["__scopeId","data-v-1eece137"]]),zt={key:0,class:"chat-box-warpper"},At={class:"chat-box-header"},jt={class:"nickname"},Ht={class:"chat-source"},Pt={class:"chat-box-content"},Ut={key:1},Ft={__name:"chat-box",setup(t,{expose:c}){const e=F(),{activeChat:o}=U(e),s=$(null),u=()=>{s.value.scrollToBottom()},h=()=>{s.value.scrollToTop()},b=$(null),m=(i,v)=>{b.value.open(i,v)};return c({scrollToTop:h,scrollToBottom:u}),(i,v)=>(n(),r(M,null,[T(o)?(n(),r("div",zt,[a("div",At,[a("div",jt,p(T(o).name||T(o).nickname),1),a("div",Ht," 来自："+p(T(o).come_from.robot_name)+" - "+p(T(o).come_from.app_name),1)]),a("div",Pt,[R(gt,{ref_key:"chatMessageRef",ref:s,onOpenLibrary:m},null,512)])])):(n(),r("div",Ut)),R(qt,{ref_key:"libraryInfoAlertRef",ref:b},null,512)],64))}},Jt=B(Ft,[["__scopeId","data-v-d67bf9eb"]]),Et=t=>(E("data-v-0d77ff6e"),t=t(),V(),t),Vt={class:"chat-monitor-page"},Wt={class:"page-left"},Qt={class:"app-list-box"},Yt={class:"search-box"},Gt={class:"chat-list-wrapper"},Kt={class:"page-body"},Xt=Et(()=>a("div",null,[a("p",null,"请在左侧列表先选择会话"),a("p",null,"通过本功能，可以实时查看机器人接待中的会话消息，监控机器人回复效果")],-1)),Zt={__name:"index",setup(t){const c=oe(),e=F(),{init:o,changeRobot:s,switchChat:u,closeIM:h}=e,{robotList:b,selectedRobotId:m,activeChat:i}=U(e),v=$(null),L=$(null),w=$(""),f=()=>{const y={keyword:w.value,page:1};s(y)},_=async y=>{var l;await u(y),(l=L.value)==null||l.scrollToBottom()},g=()=>{j(()=>{var y;(y=L.value)==null||y.scrollToBottom()})},C=()=>{const y={keyword:w.value,page:1};v.value&&v.value.getData(y)};return ee(async()=>{await o(),j(()=>{var y;(y=L.value)==null||y.scrollToBottom()}),c.on("onAddMessage",g)}),te(()=>{c.off("onAddMessage",g),h()}),(y,l)=>{const k=Ce,S=$e,N=Te;return n(),r("div",Vt,[a("div",Wt,[a("div",Qt,[R(S,{value:T(m),"onUpdate:value":l[0]||(l[0]=d=>se(m)?m.value=d:null),style:{width:"100%"},onChange:f},{default:D(()=>[R(k,{value:""},{default:D(()=>[H("全部应用")]),_:1}),(n(!0),r(M,null,I(T(b),d=>(n(),q(k,{value:d.id,key:d.id},{default:D(()=>[a("span",null,p(d.robot_name),1)]),_:2},1032,["value"]))),128))]),_:1},8,["value"])]),a("div",Yt,[R(N,{value:w.value,"onUpdate:value":l[1]||(l[1]=d=>w.value=d),placeholder:"搜索客户昵称或openld，按enter搜索","enter-button":"",style:{width:"100%"},onSearch:C,allowClear:"",onPressEnter:C},null,8,["value"])]),a("div",Gt,[R(Ve,{ref_key:"chatListRef",ref:v,onSwitchChat:_},null,512)])]),a("div",Kt,[T(i)?(n(),q(Jt,{key:0,ref_key:"chatBoxRef",ref:L},null,512)):(n(),q(ie,{key:1,style:{background:"#F2F4F7"},size:"250"},{default:D(()=>[Xt]),_:1}))])])}}},Ds=B(Zt,[["__scopeId","data-v-0d77ff6e"]]);export{Ds as default};
