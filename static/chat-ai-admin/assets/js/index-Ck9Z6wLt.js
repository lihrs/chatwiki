import{N as s,O as t,X as e,a6 as h,a5 as J,F as q,a1 as R,_ as m,b as Y,d as x,j as a,U as p,S as V,u as $,Z as E,H as X,I as Se,x as se,G as te,ag as _e,w as de,z as xe,a2 as Te,a3 as re,a8 as Me,q as Le,D as Ie,a7 as Ee}from"./vue-chunks-BRsu9_To.js";import{u as Oe}from"./useEventBus-BwH2zX88.js";import{u as pe}from"./chat-N__dm3Cg.js";import{b as N,W as ce,d as oe,an as Re,bv as me,M as Be,h as Ae,B as De,bB as Pe,k as Fe}from"../../index-CRscgXfx.js";import{_ as ue}from"./useIM-CZxFliN1.js";import{S as ge}from"./index-BJIaPIed.js";import{_ as ve}from"./index-1HwKIEyy.js";import{_ as fe}from"./cu-scroll-CSP3phOX.js";import{_ as He}from"./TextArea-K98swN5P.js";import{Q as H}from"./QuestionCircleOutlined-DKLyIfpc.js";import{_ as he}from"./index-C8VqlY87.js";import{a as Ne}from"./index-IjEOdvS1.js";import{V as Ue}from"./vue3-pdf-embed-BUNF_9cG.js";import{t as je}from"./index-CrzHUxIe.js";import{u as Qe}from"./robot-Dy6XFIJL.js";import{B as ze,_ as Ve}from"./index-D1_I00ev.js";import{P as Je}from"./PlusOutlined-Bx_uxzSh.js";import"./axios-Dq7h7Pqt.js";import"./qs-BrxkIg-9.js";import"./crypto-js-ClNpte_9.js";import"./dayjs-B6IotFah.js";import"./index-CRufPZma.js";import"./Trigger-D-LMK5CQ.js";import"./ResizeObserver.es-B1PUzC5B.js";import"./colors-GzwEvaOH.js";import"./pull-up.esm-D94Swpvl.js";import"./observe-dom.esm-CyCedSm-.js";import"./FormItemContext-DiOlYi_l.js";import"./index-BbckQ73x.js";import"./index-CxTVzuqL.js";import"./inputProps-QKn333yB.js";import"./vue-pdf-embed-C6Q-qZ65.js";import"./dropdown-BHoAAsqQ.js";import"./RightOutlined-lY7LuswZ.js";import"./move-l5WLgE3F.js";import"./slide-Cad5dMPr.js";import"./index-SJnDd6Rt.js";import"./shallowequal-C0xnIuy8.js";import"./collapseMotion-Brd6xpAT.js";import"./DownOutlined-h1NhriVT.js";const Ke={class:"guess-you-want"},Ge={class:"message-tabs"},We={key:1,class:"v-line"},Xe={key:0,class:"message-menus"},Ye=["onClick"],Ze={key:1,class:"message-menus"},et=["onClick"],tt={__name:"guess-you-want",props:{item:{type:Object,default:()=>{}},common_question_list:{type:Object,default:()=>[]},enable_common_question:{type:Boolean,default:!1}},emits:["clickMeun"],setup(T,{emit:O}){const b=O,o=T,f=(k,c)=>{k.question_tabkey=c},C=k=>{b("clickMeun",k)};return(k,c)=>(t(),s("div",Ke,[e("div",Ge,[o.item.guess_you_want?(t(),s("div",{key:0,onClick:c[0]||(c[0]=n=>f(o.item,1)),class:J(["tab-item",{active:o.item.question_tabkey==1}])}," 猜你想问 ",2)):h("",!0),o.item.guess_you_want&&o.common_question_list&&o.enable_common_question?(t(),s("div",We)):h("",!0),o.common_question_list&&o.enable_common_question?(t(),s("div",{key:2,onClick:c[1]||(c[1]=n=>f(o.item,2)),class:J(["tab-item",{active:o.item.question_tabkey==2}])}," 常见问题 ",2)):h("",!0)]),o.item.question_tabkey==1?(t(),s("div",Xe,[(t(!0),s(q,null,R(o.item.guess_you_want,(n,_)=>(t(),s("div",{onClick:u=>C(n),class:"menu-item",key:_},m(n),9,Ye))),128))])):(t(),s("div",Ze,[(t(!0),s(q,null,R(T.common_question_list,(n,_)=>(t(),s("div",{onClick:u=>C(n),class:"menu-item",key:_},m(n),9,et))),128))]))]))}},st=N(tt,[["__scopeId","data-v-9c22a890"]]),ot={class:"message-list-wrapper"},nt={class:"message-list"},lt=["id"],at={class:"itme-left"},it=["src"],rt={class:"itme-right"},ct={class:"item-body"},ut={class:"message-content"},_t=["id"],dt={class:"itme-left"},pt=["src"],mt={class:"itme-right"},gt={class:"label-flex-block"},vt=["onClick"],ft={class:"label-text"},ht=["onClick"],yt={class:"label-text"},bt={class:"item-body"},kt={key:0,class:"file-items"},$t=["onClick"],wt={class:"file-name"},qt={key:0},Ct={key:1},St={key:1,class:"thinking-content"},xt={class:"message-content"},Tt={class:"message-menus"},Mt=["onClick"],Lt=["innerHTML"],It={class:"message-menus"},Et=["onClick"],Ot={key:4,class:"message-content"},Rt=["src"],Bt={key:5,class:"message-action-wrap"},At={key:0,class:"message-action"},Dt={class:"action-btn"},Pt=["onClick"],Ft={__name:"message-list",props:{messages:{type:Array,default:()=>[]},robotInfo:{type:Object,default:()=>{}}},emits:["clickMsgMeun","scroll","scrollStart","scrollEnd","openPromptLog","openLibrary"],setup(T,{expose:O,emit:b}){const o=b,f=T,C=d=>{d.show_reasoning=!d.show_reasoning},k=d=>{d.show_quote_file=!d.show_quote_file},c=Y(()=>f.robotInfo.common_question_list.length?JSON.parse(f.robotInfo.common_question_list):[]),n=Y(()=>f.robotInfo.chat_type==1||f.robotInfo.chat_type==3),_=d=>{o("clickMsgMeun",d)},u=x(null),i={scrollTop:0,scrollHeight:0,clientHeight:0,scrollStartDiff:60,scrollEndDiff:60,scrollDirection:""};let L=null,D=!1;function U(d){D||(L&&(clearTimeout(L),L=null),L=setTimeout(()=>{i.scrollTop-d.target.scrollTop>0&&(i.scrollDirection="up"),i.scrollTop-d.target.scrollTop<0&&(i.scrollDirection="down"),i.scrollTop=d.target.scrollTop,i.scrollHeight=d.target.scrollHeight,i.clientHeight=d.target.clientHeight,o("scroll",{...i}),Math.abs(i.scrollTop)<=i.scrollStartDiff&&i.scrollDirection==="up"&&j(),Math.abs(i.scrollHeight-i.scrollTop-i.clientHeight)<=i.scrollEndDiff&&i.scrollDirection==="down"&&F()},50))}function j(){f.messages.length!=0&&o("scrollStart",{msg:f.messages[0]})}function F(){f.messages.length!=0&&o("scrollEnd",{msg:f.messages[f.messages.length-1]})}const W=()=>{u.value&&se(()=>{D=!0,u.value.scrollTop=u.value.scrollHeight+1,setTimeout(()=>{i.scrollTop=u.value.scrollTop,D=!1},50)})};function K(d,w){se(()=>{D=!0,w||(w="top");let I=u.value,r=document.querySelector("#msg-"+d);w=="top"?I.scrollTop=r.offsetTop:I.scrollTop=r.offsetTop-I.clientHeight+r.clientHeight,setTimeout(()=>{i.scrollTop=u.value.scrollTop,D=!1},50)})}function g(){i.scrollTop=0,i.scrollDirection=""}function y(d){return!!(d.quote_file&&d.quote_file.length>0||d.debug&&d.debug.length>0)}function P(d){o("openPromptLog",te(d))}function B(d,w,I){let r=te(d);w.message_id=w.message_id||I,r.forEach(A=>{A.message_id=A.message_id||I}),o("openLibrary",r,te(w))}return O({scrollToBottom:W,scrollToMessage:K,resetScroll:g}),(d,w)=>{const I=ge,r=oe,A=ve,Q=_e("viewer");return t(),s("div",ot,[e("div",{class:"scroll-box",ref_key:"scrollBoxRef",ref:u,onScroll:U},[e("div",nt,[(t(!0),s(q,null,R(f.messages,l=>(t(),s(q,{key:l.uid},[l.is_customer==1?(t(),s("div",{key:0,class:"message-item user-message",id:"msg-"+l.uid},[e("div",at,[e("img",{class:"user-avatar",src:l.avatar},null,8,it)]),e("div",rt,[e("div",ct,[e("div",ut,m(l.content),1)])])],8,lt)):(t(),s("div",{key:1,class:"message-item robot-message",id:"msg-"+l.uid},[e("div",dt,[a(I,{size:"small",spinning:l.loading},{default:p(()=>[e("img",{class:"robot-avatar",src:l.robot_avatar},null,8,pt)]),_:2},1032,["spinning"])]),e("div",mt,[e("div",gt,[l.msg_type==1&&n.value?(t(),s("div",{key:0,class:J(["thinking-label-wrapper",{reasoning_open:l.show_quote_file}])},[e("div",{class:"thinking-label",onClick:S=>k(l)},[l.quote_loading?(t(),s(q,{key:0},[a($(ce),{class:"loading"}),w[0]||(w[0]=e("span",{class:"label-text"},"正在检索知识库...",-1))],64)):(t(),s(q,{key:1},[a(r,{class:"think-icon",name:"quote-file"}),e("span",ft,"检索到"+m(l.quote_file.length)+"个知识库文档",1)],64)),l.quote_file.length?(t(),V(r,{key:2,name:"arrow-down",class:"arrow-down"})):h("",!0)],8,vt)],2)):h("",!0),l.reasoning_content?(t(),s("div",{key:1,class:J(["thinking-label-wrapper",{reasoning_open:l.show_reasoning}])},[e("div",{class:"thinking-label",onClick:S=>C(l)},[l.reasoning_status?(t(),V($(ce),{key:0,class:"loading"})):(t(),V(r,{key:1,class:"think-icon",name:"think"})),e("span",yt,m(l.reasoning_status?"深度思考中...":"已完成深度思考"),1),l.reasoning_status?h("",!0):(t(),V(r,{key:2,name:"arrow-down",class:"arrow-down"}))],8,ht),a(A,null,{title:p(()=>w[1]||(w[1]=[E("在应用设置中关闭推理过程开关，将不再显示推理过程")])),default:p(()=>[a($(Re),{class:"tip"})]),_:1})],2)):h("",!0)]),e("div",bt,[l.show_quote_file&&l.quote_file&&l.quote_file.length>0?(t(),s("div",kt,[(t(!0),s(q,null,R(l.quote_file,S=>(t(),s("div",{class:"file-item",key:S.id,onClick:z=>B(l.quote_file,S,l.id)},[e("a",wt,[a(r,{class:"think-icon",name:"quote-file"}),S.file_name?(t(),s("span",qt,m(S.file_name),1)):(t(),s("span",Ct,m(S.library_name)+"-精选",1))])],8,$t))),128))])):h("",!0),l.show_reasoning?(t(),s("div",St,[a(ue,{content:l.reasoning_content},null,8,["content"])])):h("",!0),l.msg_type==1?(t(),s(q,{key:2},[X((t(),s("div",xt,[a(ue,{content:l.content},null,8,["content"])])),[[Q]]),e("div",Tt,[(t(!0),s(q,null,R(l.question,(S,z)=>(t(),s("div",{class:"menu-item",onClick:Z=>_(S),key:z},m(S),9,Mt))),128))])],64)):h("",!0),l.msg_type==2?(t(),s(q,{key:3},[e("div",{class:"message-content",innerHTML:l.menu_json.content},null,8,Lt),e("div",It,[(t(!0),s(q,null,R(l.menu_json.question,(S,z)=>(t(),s("div",{class:"menu-item",onClick:Z=>_(S),key:z},m(S),9,Et))),128))])],64)):h("",!0),l.msg_type==3?(t(),s("div",Ot,[X(e("img",{class:"msg-img",src:l.content,alt:""},null,8,Rt),[[Q]])])):h("",!0),y(l)?X((t(),s("div",Bt,[l.debug&&l.debug.length>0?(t(),s("div",At,[e("div",Dt,[e("span",null,[e("a",{onClick:S=>P(l)},"Prompt 日志",8,Pt)])])])):h("",!0)],512)),[[Se,!l.question]]):h("",!0)]),(l.guess_you_want&&l.guess_you_want.length||c.value.length&&f.robotInfo.enable_common_question=="true")&&l.question_tabkey>0?(t(),V(st,{key:0,item:l,enable_common_question:f.robotInfo.enable_common_question=="true",common_question_list:c.value,onClickMeun:_},null,8,["item","enable_common_question","common_question_list"])):h("",!0)])],8,_t))],64))),128))])],544)])}}},Ht=N(Ft,[["__scopeId","data-v-a04d3aa0"]]),Nt={class:"chat-list-box"},Ut=["onClick"],jt={class:"chat-item-title"},Qt={__name:"chat-list",props:{list:{type:Array,default:()=>[]},active:{type:[String,Number],default:""}},emits:["openChat","onScrollEnd"],setup(T,{emit:O}){const b=O,o=T,f=x(null),C=c=>{b("openChat",c)},k=()=>{b("onScrollEnd")};return de(()=>o.list,()=>{se(()=>{f.value.refresh()})}),(c,n)=>{const _=oe;return t(),s("div",Nt,[a(fe,{ref_key:"scroller",ref:f,onOnScrollEnd:k},{default:p(()=>[e("div",null,[(t(!0),s(q,null,R(o.list,u=>(t(),s("div",{class:J(["chat-list-item",{active:u.id==o.active}]),onClick:i=>C(u),key:u.id},[a(_,{class:"chat-item-icon",name:"message"}),e("span",jt,m(u.subject||u.last_chat_message),1)],10,Ut))),128))])]),_:1},512)])}}},zt=N(Qt,[["__scopeId","data-v-8a5dd127"]]),Vt={class:"message-input-wrapper"},Jt={class:"message-action"},Kt={class:"loading-action"},Gt=["disabled"],Wt={__name:"message-input",props:{value:{type:String,default:""},loading:{type:Boolean,default:!1}},emits:["send","update:value"],setup(T,{emit:O}){const b=O,o=T,f=Y(()=>o.loading||o.value.trim().length===0),C=n=>{b("update:value",n.target.value.trim())},k=n=>{if(n.key==="Enter"&&!n.shiftKey){if(!n.target.value.trim())return;n.preventDefault(),c()}else n.key==="Enter"&&n.shiftKey&&(n.preventDefault(),b("update:value",o.value+`
`))},c=()=>{b("send",o.value.trim())};return(n,_)=>{const u=He,i=ge;return t(),s("div",Vt,[a(u,{value:T.value,"auto-size":{minRows:5,maxRows:5},placeholder:"在此输入您想了解的内容，Shift+Enter换行",onChange:C,onKeydown:k},null,8,["value"]),e("div",Jt,[e("span",Kt,[a(i,{spinning:T.loading},null,8,["spinning"])]),T.loading?h("",!0):(t(),s("button",{key:0,class:"send-msg-btn",disabled:f.value,onClick:c},_[0]||(_[0]=[e("span",null,"发送",-1)]),8,Gt))])])}}},Xt=N(Wt,[["__scopeId","data-v-47f207c0"]]),Yt={class:"prompt-log-content"},Zt={class:"prompt-log-items"},es={class:"prompt-log-label"},ts={class:"prompt-log-item"},ss={class:"prompt-log-items"},os={class:"prompt-log-label"},ns={class:"prompt-log-items"},ls={class:"prompt-log-label"},as={class:"prompt-log-item"},is={class:"prompt-log-items"},rs={class:"prompt-log-label"},cs={class:"prompt-log-item"},us={key:0,class:"prompt-log-items"},_s={class:"prompt-log-label"},ds={class:"prompt-log-item"},ps={key:1,class:"prompt-log-items"},ms={class:"prompt-log-label"},gs={class:"prompt-log-item"},vs={class:"prompt-log-items"},fs={class:"prompt-log-label"},hs={class:"prompt-log-item"},ys={__name:"prompt-log-alert",setup(T,{expose:O}){const b=x(!1),o=xe({prompt:"",library:[],context_qa:[],cur_question:"",cur_answer:"",error:""}),f=()=>{b.value=!1},C=()=>{o.prompt="",o.library=[],o.context_qa=[],o.cur_question="",o.cur_answer="",o.error="",o.recall_time="",o.request_time=""};return O({open:c=>{C(),o.error=c.error,o.recall_time=c.recall_time?(c.recall_time/1e3).toFixed(2):"",o.request_time=c.request_time?(c.request_time/1e3).toFixed(2):"";let n=c.debug||[];for(let _=0;_<n.length;_++){let u=n[_];u.type=="library"?o.library.push(u.content):u.type=="context_qa"?o.context_qa.push(u):o[u.type]=u.content}b.value=!0}}),(c,n)=>{const _=ve,u=he;return t(),V(u,{class:"prompt-log-alert",open:b.value,"onUpdate:open":n[0]||(n[0]=i=>b.value=i),title:"Prompt 日志",placement:"right",width:"746px",closable:!1},{extra:p(()=>[e("span",{class:"close-btn",onClick:f},[a($(me))])]),default:p(()=>[e("div",Yt,[e("div",Zt,[e("div",es,[n[2]||(n[2]=e("span",null,"提示词 ",-1)),a(_,null,{title:p(()=>n[1]||(n[1]=[E("系统提示词和文档分段。")])),default:p(()=>[a($(H),{class:"question-icon"})]),_:1})]),e("div",ts,[e("p",null,m(o.prompt),1)]),(t(!0),s(q,null,R(o.library,(i,L)=>(t(),s("div",{class:"prompt-log-item",key:L},[e("p",null,m(i),1)]))),128))]),e("div",ss,[e("div",os,[n[4]||(n[4]=e("span",null,"上下文 ",-1)),a(_,null,{title:p(()=>n[3]||(n[3]=[E("传递的历史提问消息")])),default:p(()=>[a($(H),{class:"question-icon"})]),_:1})]),(t(!0),s(q,null,R(o.context_qa,(i,L)=>(t(),s("div",{class:"prompt-log-item",key:L},[e("p",null,"Q："+m(i.question),1),e("p",null,"A："+m(i.answer),1)]))),128))]),e("div",ns,[e("div",ls,[n[6]||(n[6]=e("span",null,"USER ",-1)),a(_,null,{title:p(()=>n[5]||(n[5]=[E("本次用户的提问")])),default:p(()=>[a($(H),{class:"question-icon"})]),_:1})]),e("div",as,[e("p",null,m(o.cur_question),1)])]),e("div",is,[e("div",rs,[n[8]||(n[8]=e("span",null,"ASSISTANT ",-1)),a(_,null,{title:p(()=>n[7]||(n[7]=[E("语言模型输出的答案")])),default:p(()=>[a($(H),{class:"question-icon"})]),_:1})]),e("div",cs,[e("p",null,m(o.cur_answer),1)])]),o.recall_time>0?(t(),s("div",us,[e("div",_s,[n[10]||(n[10]=e("span",null,"Recall time ",-1)),a(_,null,{title:p(()=>n[9]||(n[9]=[E("从知识库中检索到有效分段所需要的时间，包括对分段进行排序时间。")])),default:p(()=>[a($(H),{class:"question-icon"})]),_:1})]),e("div",ds,[e("p",null,m(o.recall_time)+"s",1)])])):h("",!0),o.request_time>0?(t(),s("div",ps,[e("div",ms,[n[12]||(n[12]=e("span",null,"Request time ",-1)),a(_,null,{title:p(()=>n[11]||(n[11]=[E("从发送问题和上下文信息给大模型到大模型开始返回答案的时间。")])),default:p(()=>[a($(H),{class:"question-icon"})]),_:1})]),e("div",gs,[e("p",null,m(o.request_time)+"s",1)])])):h("",!0),e("div",vs,[e("div",fs,[n[14]||(n[14]=e("span",null,"Error ",-1)),a(_,null,{title:p(()=>n[13]||(n[13]=[E("报错信息，调用聊天接口报错时会显示。")])),default:p(()=>[a($(H),{class:"question-icon"})]),_:1})]),e("div",hs,[e("p",null,m(o.error),1)])])])]),_:1},8,["open"])}}},bs=N(ys,[["__scopeId","data-v-6f598f2d"]]),ks={class:"library-info-content"},$s={class:"file-list"},ws=["onClick"],qs={key:0},Cs={key:1},Ss={class:"document-items"},xs={class:"document-item-header"},Ts={class:"left-box"},Ms={class:"document-title"},Ls={key:0,class:"document-title"},Is={class:"document-size"},Es={class:"right-box"},Os=["onClick"],Rs={class:"document-item-body"},Bs={class:"document-similarity"},As={key:0,class:"document-content"},Ds={key:1,class:"document-content"},Ps={class:"document-content"},Fs={class:"fragment-img"},Hs=["src"],Ns={class:"iframe-box"},Us={__name:"library-info-alert",setup(T,{expose:O}){const b=pe(),{robot:o,user:f}=b;Te();const C=x(!1),k=x([]),c=x(null),n=()=>{k.value=[],c.value=null},_=(g,y)=>{if(n(),k.value=g.map(P=>{let B=null;return P.answer_source_data&&(B=JSON.parse(P.answer_source_data)),{...P,answer_source_data:B}}),c.value=y.id,C.value=!0,y.answer_source_data){i.value=JSON.parse(y.answer_source_data)||[];return}L(y)},u=g=>{if(g.id!=c.value){if(c.value=g.id,g.answer_source_data){i.value=g.answer_source_data||[];return}L(g)}},i=x([]),L=g=>{Ne({message_id:g.message_id,file_id:g.id,robot_key:o.robot_key,openid:o.openid}).then(y=>{i.value=y.data||[]})},D=()=>{let g=k.value.filter(y=>y.id==c.value)[0]||{};g.file_name?window.open(`#/library/preview?id=${c.value}`):window.open(`#/library/details/categary-manage?id=${g.library_id}`)},U=Y(()=>{let g=k.value.filter(y=>y.id==c.value)[0]||{};return g.file_name?g.file_name:g.library_name+"-精选"}),j=x(""),F=x(!1),W=g=>{F.value=!0,j.value="/manage/getLibRawFileOnePage?id="+c.value+"&page="+g.page_num+"&admin_user_id="+f.admin_user_id},K=()=>{C.value=!1};return O({open:_}),(g,y)=>{const P=oe,B=he,d=fe,w=Be,I=_e("viewer");return t(),s(q,null,[a(B,{class:"library-info-alert",open:C.value,"onUpdate:open":y[0]||(y[0]=r=>C.value=r),title:"答案来源",placement:"right",width:"746px",closable:!1,bodyStyle:{background:"#F2F4F7"}},{extra:p(()=>[e("span",{class:"close-btn",onClick:K},[a($(me))])]),default:p(()=>[e("div",ks,[e("div",$s,[(t(!0),s(q,null,R(k.value,r=>(t(),s("div",{class:J(["file-item",{active:c.value==r.id}]),key:r.id,onClick:A=>u(r)},[r.file_name?(t(),s("span",qs,m(r.file_name),1)):(t(),s("span",Cs,m(r.library_name)+"-精选",1))],10,ws))),128))]),e("div",Ss,[(t(!0),s(q,null,R(i.value,r=>(t(),s("div",{class:"document-item",key:r.id},[e("div",xs,[e("div",Ts,[e("span",Ms,"id："+m(r.id),1),r.title?(t(),s("span",Ls,m(r.title),1)):h("",!0),e("span",Is," 共"+m(r.word_total)+"个字符 ",1)]),e("div",Es,[r.page_num>0?(t(),s("a",{key:0,onClick:A=>W(r)},"预览原文件>",8,Os)):h("",!0),e("a",{onClick:D},"查看源文档>")])]),e("div",Rs,[e("div",Bs,[y[2]||(y[2]=E(" 相似度： ")),a(P,{name:"similarity",style:{"font-size":"16px"}}),E(m(r.similarity),1)]),r.question?(t(),s("div",As,"Q："+m(r.question),1)):h("",!0),r.answer?(t(),s("div",Ds,"A："+m(r.answer),1)):h("",!0),e("div",Ps,m(r.content),1),X((t(),s("div",Fs,[(t(!0),s(q,null,R(r.images,(A,Q)=>(t(),s("img",{key:Q,src:A,alt:""},null,8,Hs))),128))])),[[I]])])]))),128))])])]),_:1},8,["open"]),a(w,{open:F.value,"onUpdate:open":y[1]||(y[1]=r=>F.value=r),title:U.value,footer:null,width:740},{default:p(()=>[e("div",Ns,[a(d,null,{default:p(()=>[a($(Ue),{source:j.value},null,8,["source"])]),_:1})])]),_:1},8,["open","title"])],64)}}},js=N(Us,[["__scopeId","data-v-e8bc69ca"]]),Qs={class:"chat-page-wrapper"},zs={class:"chat-page-header"},Vs={class:"breadcrumb-box"},Js={class:"chat-page"},Ks={class:"page-left"},Gs={class:"page-left-top"},Ws={class:"page-left-body"},Xs={class:"page-body"},Ys={class:"chat-box-body"},Zs={style:{"margin-top":"30px"},class:"chat-box-footer"},eo={__name:"index",setup(T){const b=re().query,o=Qe(),{getRobot:f,robotInfo:C}=o,k=Oe(),c=pe(),n=Ae();let _=!0;const u=x(""),i=x(null),{createChat:L,sendMessage:D,getMyChatList:U,openChat:j,onGetChatMessage:F,changeRobotPrompt:W,$reset:K}=c,{messageList:g,sendLock:y,myChatList:P,robot:B,dialogue_id:d}=Me(c),w=re(),I=x(!1),r=async()=>{if(!u.value)return Pe("请输入消息内容");let v=await je({robot_key:B.value.robot_key,openid:B.value.openid,question:u.value,form_ids:B.value.form_ids,dialogue_id:d.value});if(v.data&&v.data.words)return Fe.error(`提交的内容包含敏感词：[${v.data.words.join(";")}] 请修改后再提交`);_=!0,D({message:u.value,global:JSON.stringify(b)}),u.value=""},A=async()=>{_=!0,u.value="";let v=w.query||{},M=n.user_id,G={robot_key:v.robot_key,avatar:v.avatar,name:v.name,nickname:v.nickname,is_background:1,openid:M,dialogue_id:0};le(),await L(G)},Q=async v=>{if(d.value==v.dialogue_id)return;_=!0;let G={robot_key:(w.query||{}).robot_key,avatar:v.avatar,name:v.name,nickname:v.nickname,is_background:v.is_background,openid:v.openid,dialogue_id:v.id};le(),await j(G),await F()&&ne()},l=v=>{_=!0,D({message:v})};x(!1);const S=()=>{ne()},z=async()=>{_=!1;let v=g.value[0].uid;await F()&&ye(v)},Z=()=>{},ne=()=>{i.value&&_&&i.value.scrollToBottom()},ye=v=>{i.value&&i.value.scrollToMessage(v)},le=()=>{i.value&&i.value.resetScroll()},be=()=>{U()},ae=x(null),ke=v=>{ae.value.open(v)},ie=x(null),$e=(v,M)=>{ie.value.open(v,M)};return de(()=>g.value,()=>{}),Le(async()=>{A(),U(),await f(b.id),I.value=!0,k.on("updateAiMessage",S)}),Ie(()=>{K(),k.off("updateAiMessage",S)}),(v,M)=>{const G=Ee("router-link"),ee=Ve,we=ze,qe=De;return t(),s("div",Qs,[e("div",zs,[e("div",Vs,[a(we,null,{default:p(()=>[a(ee,null,{default:p(()=>[a(G,{to:"/robot/list"},{default:p(()=>M[1]||(M[1]=[E("机器人管理")])),_:1,__:[1]})]),_:1}),a(ee,null,{default:p(()=>[E(m($(B).robot_name),1)]),_:1})]),_:1})])]),e("div",Js,[e("div",Ks,[e("div",Gs,[a(qe,{type:"primary",block:"",ghost:"",onClick:A},{default:p(()=>[a($(Je)),M[2]||(M[2]=E(" 新建对话"))]),_:1,__:[2]})]),e("div",Ws,[a(zt,{list:$(P),active:$(d),onOpenChat:Q,onOnScrollEnd:be},null,8,["list","active"])]),M[3]||(M[3]=e("div",{class:"page-left-footer"},null,-1))]),e("div",Xs,[e("div",Ys,[a(Ht,{ref_key:"messageListRef",ref:i,messages:$(g),robotInfo:$(C),onClickMsgMeun:l,onScrollStart:z,onScrollEnd:Z,onOpenPromptLog:ke,onOpenLibrary:$e},null,8,["messages","robotInfo"])]),e("div",Zs,[a(Xt,{value:u.value,"onUpdate:value":M[0]||(M[0]=Ce=>u.value=Ce),onSend:r,loading:$(y)},null,8,["value","loading"])])]),e("div",null,[h("",!0)])]),a(bs,{ref_key:"promptLogAlertRef",ref:ae},null,512),a(js,{ref_key:"libraryInfoAlertRef",ref:ie},null,512)])}}},Uo=N(eo,[["__scopeId","data-v-7257bb7b"]]);export{Uo as default};
